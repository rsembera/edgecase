<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}EdgeCase Equalizer{% endblock %}</title>
    
    <!-- Shared styles -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/shared.css') }}">
    
    <!-- Choices.js for styled dropdowns -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/choices.min.css') }}">

    <!-- Favicons-->
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicons/favicon.ico') }}">
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='favicons/favicon.svg') }}">
    <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='favicons/apple-touch-icon.png') }}">
    <link rel="icon" type="image/png" sizes="96x96" href="{{ url_for('static', filename='favicons/favicon-96x96.png') }}">
    
    <style>
        /* Self-hosted Lexend fonts */
        @font-face {
            font-family: 'Lexend';
            src: url("{{ url_for('static', filename='fonts/Lexend-Light.ttf') }}") format('truetype');
            font-weight: 300;
        }
        @font-face {
            font-family: 'Lexend';
            src: url("{{ url_for('static', filename='fonts/Lexend-Regular.ttf') }}") format('truetype');
            font-weight: 400;
        }
        @font-face {
            font-family: 'Lexend';
            src: url("{{ url_for('static', filename='fonts/Lexend-Medium.ttf') }}") format('truetype');
            font-weight: 500;
        }
        @font-face {
            font-family: 'Lexend';
            src: url("{{ url_for('static', filename='fonts/Lexend-SemiBold.ttf') }}") format('truetype');
            font-weight: 600;
        }
        @font-face {
            font-family: 'Lexend';
            src: url("{{ url_for('static', filename='fonts/Lexend-Bold.ttf') }}") format('truetype');
            font-weight: 700;
        }
        
        /* Self-hosted Inter fonts */
        @font-face {
            font-family: 'Inter';
            src: url("{{ url_for('static', filename='fonts/Inter-Regular.ttf') }}") format('truetype');
            font-weight: 400;
        }
        @font-face {
            font-family: 'Inter';
            src: url("{{ url_for('static', filename='fonts/Inter-Medium.ttf') }}") format('truetype');
            font-weight: 500;
        }
        @font-face {
            font-family: 'Inter';
            src: url("{{ url_for('static', filename='fonts/Inter-SemiBold.ttf') }}") format('truetype');
            font-weight: 600;
        }
        @font-face {
            font-family: 'Inter';
            src: url("{{ url_for('static', filename='fonts/Inter-Bold.ttf') }}") format('truetype');
            font-weight: 700;
        }
        
        /* Self-hosted Lora fonts (serif) */
        @font-face {
            font-family: 'Lora';
            src: url("{{ url_for('static', filename='fonts/Lora-Regular.ttf') }}") format('truetype');
            font-weight: 400;
        }
        @font-face {
            font-family: 'Lora';
            src: url("{{ url_for('static', filename='fonts/Lora-Medium.ttf') }}") format('truetype');
            font-weight: 500;
        }
        @font-face {
            font-family: 'Lora';
            src: url("{{ url_for('static', filename='fonts/Lora-SemiBold.ttf') }}") format('truetype');
            font-weight: 600;
        }
        @font-face {
            font-family: 'Lora';
            src: url("{{ url_for('static', filename='fonts/Lora-Bold.ttf') }}") format('truetype');
            font-weight: 700;
        }

        /* Base reset */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        /* CSS variable for font selection */
        :root {
            --font-ui: 'Lexend', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }
        
        /* Body defaults */
        body {
            font-family: var(--font-ui);
            line-height: 1.6;
            color: #111827;
            background: #EDF2F5;
            font-size: 1.125rem; /* 18px base */
        }
        
        /* Main content container */
        main {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        /* Tutti-Frutti theme - colored stat cards (main view only) */
        body.tutti-frutti .stat-card:nth-child(1) { background: #C8D8E0; }
        body.tutti-frutti .stat-card:nth-child(2) { background: #DCD3E8; }
        body.tutti-frutti .stat-card:nth-child(3) { background: #E9CFCF; }
        body.tutti-frutti .stat-card:nth-child(4) { background: #CFE7DA; }
        body.tutti-frutti .stat-card:nth-child(5) { background: #F5DEB0; }
        body.tutti-frutti .stat-card:nth-child(6) { background: #DCD3E8; }
    </style>
    {% block extra_css %}{% endblock %}
</head>
<body>
    <main>
        {% block content %}{% endblock %}
    </main>

    <!-- Server disconnect overlay -->
    <div id="disconnect-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 10000; align-items: center; justify-content: center;">
        <div style="background: white; padding: 2rem; border-radius: 1rem; max-width: 350px; text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.15);">
            <h2 style="color: #1F2937; margin-bottom: 0.75rem; font-size: 1.375rem; font-weight: 700;">Server Disconnected</h2>
            <p style="color: #6B7280; margin-bottom: 1.5rem; font-size: 0.9375rem;">The server has stopped. Refresh the page to reconnect.</p>
            <button onclick="location.reload()" style="padding: 0.75rem 1.5rem; background: #BFDCDC; color: #115D4F; border: none; border-radius: 0.75rem; font-size: 0.9375rem; font-weight: 600; cursor: pointer; width: 100%; font-family: var(--font-ui);">
                Refresh Page
            </button>
        </div>
    </div>
    
    <style>
        body.frozen > *:not(#disconnect-overlay):not(#session-expired-overlay):not(#timeout-warning-overlay) {
            pointer-events: none;
            opacity: 0.6;
            user-select: none;
        }
    </style>
    
    <!-- Session timeout warning overlay -->
    <div id="timeout-warning-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 9999; align-items: center; justify-content: center;">
        <div style="background: white; padding: 2rem; border-radius: 1rem; max-width: 400px; text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.15);">
            <h2 style="color: #1F2937; margin-bottom: 0.75rem; font-size: 1.375rem; font-weight: 700;">Session Expiring Soon</h2>
            <p style="color: #6B7280; margin-bottom: 0.5rem; font-size: 0.9375rem;">Your session will expire in <strong id="timeout-countdown">--</strong> seconds.</p>
            <p style="color: #6B7280; margin-bottom: 1.5rem; font-size: 0.875rem;">Any unsaved work may be lost.</p>
            <div style="display: flex; gap: 0.75rem;">
                <button onclick="stayLoggedIn()" style="flex: 1; padding: 0.75rem 1rem; background: #BFDCDC; color: #115D4F; border: none; border-radius: 0.75rem; font-size: 0.9375rem; font-weight: 600; cursor: pointer; font-family: var(--font-ui);">
                    Stay Logged In
                </button>
                <button onclick="window.location.href='/logout'" style="flex: 1; padding: 0.75rem 1rem; background: #f3f4f6; color: #374151; border: none; border-radius: 0.75rem; font-size: 0.9375rem; font-weight: 600; cursor: pointer; font-family: var(--font-ui);">
                    Log Out
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // Server disconnect detection
        let disconnectShown = false;
        
        function freezeUI() {
            if (!disconnectShown) {
                disconnectShown = true;
                document.body.classList.add('frozen');
                document.getElementById('disconnect-overlay').style.display = 'flex';
            }
        }
        
        // Override form submission to check connectivity first
        const originalSubmit = HTMLFormElement.prototype.submit;
        HTMLFormElement.prototype.submit = function() {
            const form = this;
            
            fetch('/', { method: 'HEAD', cache: 'no-store' })
                .then(response => {
                    if (response.ok) {
                        originalSubmit.call(form);
                    } else {
                        freezeUI();
                    }
                })
                .catch(() => {
                    freezeUI();
                });
        };
        
        // Intercept link clicks
        document.addEventListener('click', function(e) {
            const link = e.target.closest('a');
            if (link && link.href && link.href.startsWith(window.location.origin) && !link.target) {
                e.preventDefault();
                
                fetch(link.href, { method: 'HEAD', cache: 'no-store' })
                    .then(response => {
                        if (response.ok) {
                            window.location.href = link.href;
                        } else {
                            freezeUI();
                        }
                    })
                    .catch(() => {
                        freezeUI();
                    });
            }
        }, true);
    </script>
    
    <script>
    // Font application function
    function applyFont() {
        const fontChoice = localStorage.getItem('uiFont') || 'lexend';
        const fontMap = {
            'lexend': "'Lexend', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif",
            'inter': "'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif",
            'lora': "'Lora', Georgia, 'Times New Roman', serif"
        };
        document.documentElement.style.setProperty('--font-ui', fontMap[fontChoice] || fontMap['lexend']);
    }
    
    function applyTheme() {
        const cardStyle = localStorage.getItem('cardStyle') || 'strait-laced';
        const backgroundStyle = localStorage.getItem('backgroundStyle') || 'theme-default';
        
        // Apply card style
        const cardThemes = ['tutti-frutti', 'ocean-breeze', 'sunset-glow', 'garden-path', 'warm-stone'];
        // Remove all theme classes first
        cardThemes.forEach(theme => document.body.classList.remove(theme));
        // Add the selected theme (strait-laced has no class)
        if (cardThemes.includes(cardStyle)) {
            document.body.classList.add(cardStyle);
        }
        
        // Theme to background color mapping
        const themeBackgrounds = {
            'strait-laced': '#C5CDD3',   // Cool grey
            'ocean-breeze': '#C5D3DD',   // Powder blue
            'sunset-glow': '#E5E1D8',    // Warm cream
            'garden-path': '#C8D1C8',    // Soft green
            'warm-stone': '#D4CEC5',     // Taupe
            'tutti-frutti': '#D8D5DD'    // Soft lavender
        };

        // Apply background
        if (backgroundStyle === 'theme-default') {
            // Use the theme's default background color
            document.body.style.backgroundImage = 'none';
            document.body.style.backgroundColor = themeBackgrounds[cardStyle] || '#C5CDD3';
        } else if (backgroundStyle.startsWith('user:')) {
            // User-uploaded background image
            const filename = backgroundStyle.replace('user:', '');
            const bgPath = `/static/user_backgrounds/${filename}`;
            document.body.style.backgroundImage = `url('${bgPath}')`;
            document.body.style.backgroundSize = 'cover';
            document.body.style.backgroundPosition = 'center';
            document.body.style.backgroundAttachment = 'fixed';
        } else {
            // Legacy: old solid color values - migrate to theme-default
            localStorage.setItem('backgroundStyle', 'theme-default');
            document.body.style.backgroundImage = 'none';
            document.body.style.backgroundColor = themeBackgrounds[cardStyle] || '#C5CDD3';
        }
    }
        
        // Apply font and theme immediately
        applyFont();
        applyTheme();
    </script>
    
<!-- Choices.js for styled dropdowns -->
    <script src="{{ url_for('static', filename='js/choices.min.js') }}"></script>
    
    <!-- Lucide Icons -->
    <script src="{{ url_for('static', filename='js/lucide.min.js') }}"></script>
    
    <!-- Session timeout warning system -->
    <script>
    (function() {
        let warningShown = false;
        let countdownInterval = null;
        let secondsRemaining = 0;
        
        // Check session status periodically
        function checkSession() {
            fetch('/api/session-status')
                .then(r => r.json())
                .then(data => {
                    if (!data.logged_in) {
                        // Session expired - show modal
                        document.body.classList.add('frozen');
                        document.getElementById('session-expired-overlay').style.display = 'flex';
                        return;
                    }
                    if (data.timeout_minutes === 0) return; // "Never" timeout
                    
                    secondsRemaining = data.seconds_remaining;
                    
                    if (data.warning_needed && !warningShown) {
                        showWarning();
                    } else if (!data.warning_needed && warningShown) {
                        hideWarning();
                    }
                    
                    if (warningShown) {
                        updateCountdown();
                    }
                })
                .catch(() => {}); // Ignore errors (server disconnect handled elsewhere)
        }
        
        function showWarning() {
            warningShown = true;
            document.getElementById('timeout-warning-overlay').style.display = 'flex';
            updateCountdown();
            // Update countdown every second
            countdownInterval = setInterval(function() {
                secondsRemaining = Math.max(0, secondsRemaining - 1);
                updateCountdown();
                if (secondsRemaining <= 0) {
                    clearInterval(countdownInterval);
                    window.location.href = '/logout';
                }
            }, 1000);
            // Expose to global scope so timeout protection script can clear it
            window.warningCountdownInterval = countdownInterval;
        }
        
        function hideWarning() {
            warningShown = false;
            document.getElementById('timeout-warning-overlay').style.display = 'none';
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
        }
        
        function updateCountdown() {
            document.getElementById('timeout-countdown').textContent = secondsRemaining;
        }
        
        // Expose stayLoggedIn to global scope
        window.stayLoggedIn = function() {
            fetch('/api/keepalive', { method: 'POST' })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        hideWarning();
                    }
                })
                .catch(() => {});
        };
        
        // Check every 30 seconds
        setInterval(checkSession, 30000);
        // Initial check after 5 seconds (let page load)
        setTimeout(checkSession, 5000);
        
        // Check immediately when tab becomes visible (catches backgrounded tabs)
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'visible') {
                checkSession();
            }
        });
    })();
    </script>
    
    <!-- Client-side timeout protection (blanks screen when idle) -->
    <script>
    (function() {
        let timeoutMinutes = null;
        let lastActivityTime = Date.now();
        let lastKeepaliveSent = Date.now();
        let timeoutCheckInterval = null;
        const KEEPALIVE_INTERVAL_MS = 60000; // Ping server max once per minute
        
        // Get timeout setting from server
        fetch('/api/session-status')
            .then(r => r.json())
            .then(data => {
                if (data.logged_in) {
                    timeoutMinutes = data.timeout_minutes;
                    if (timeoutMinutes > 0) {
                        // Start checking for timeout
                        startTimeoutCheck();
                        // Track user activity
                        trackActivity();
                        // Check on wake from sleep
                        trackVisibilityChange();
                    }
                }
            })
            .catch(() => {});
        
        function trackActivity() {
            const events = ['mousedown', 'mousemove', 'keydown', 'scroll', 'touchstart'];
            events.forEach(event => {
                document.addEventListener(event, function() {
                    lastActivityTime = Date.now();
                    
                    // Send keepalive to server if it's been >1 minute since last ping
                    const timeSinceLastKeepalive = Date.now() - lastKeepaliveSent;
                    if (timeSinceLastKeepalive >= KEEPALIVE_INTERVAL_MS) {
                        sendKeepalive();
                    }
                }, { passive: true });
            });
        }
        
        function trackVisibilityChange() {
            document.addEventListener('visibilitychange', function() {
                if (document.visibilityState === 'visible') {
                    // Page just became visible (wake from sleep, tab switch, etc.)
                    // Check immediately if timeout has been exceeded
                    checkTimeoutNow();
                }
            });
        }
        
        function sendKeepalive() {
            lastKeepaliveSent = Date.now();
            fetch('/api/keepalive', { method: 'POST' })
                .catch(() => {});
        }
        
        function checkTimeoutNow() {
            const now = Date.now();
            const elapsedMinutes = (now - lastActivityTime) / 1000 / 60;
            
            if (elapsedMinutes >= timeoutMinutes) {
                if (timeoutCheckInterval) {
                    clearInterval(timeoutCheckInterval);
                }
                blankScreenAndLogout();
            }
        }
        
        function startTimeoutCheck() {
            // Check every second if timeout has been exceeded
            timeoutCheckInterval = setInterval(checkTimeoutNow, 1000);
        }
        
        function blankScreenAndLogout() {
            // Clear warning modal interval if it exists (prevents console errors)
            const warningInterval = window.warningCountdownInterval;
            if (warningInterval) {
                clearInterval(warningInterval);
            }
            
            // Hide all page content
            document.body.innerHTML = '';
            document.body.style.background = '#f9fafb';
            
            // Show login message
            const container = document.createElement('div');
            container.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 1rem; box-shadow: 0 4px 20px rgba(0,0,0,0.15); text-align: center; max-width: 350px;';
            container.innerHTML = `
                <h2 style="color: #1F2937; margin-bottom: 0.75rem; font-size: 1.375rem; font-weight: 700; font-family: 'Lexend', sans-serif;">Session Timed Out</h2>
                <p style="color: #6B7280; margin-bottom: 1.5rem; font-size: 0.9375rem; font-family: 'Lexend', sans-serif;">Your session has expired due to inactivity. Please log in again.</p>
                <button onclick="window.location.href='/login'" style="padding: 0.75rem 1.5rem; background: #BFDCDC; color: #115D4F; border: none; border-radius: 0.75rem; font-size: 0.9375rem; font-weight: 600; cursor: pointer; width: 100%; font-family: 'Lexend', sans-serif;">
                    Log In
                </button>
            `;
            document.body.appendChild(container);
        }
    })();
    </script>
    
    <!-- Session expired overlay -->
    <div id="session-expired-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 10001; align-items: center; justify-content: center;">
        <div style="background: white; padding: 2rem; border-radius: 1rem; max-width: 350px; text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.15);">
            <h2 style="color: #1F2937; margin-bottom: 0.75rem; font-size: 1.375rem; font-weight: 700;">Session Expired</h2>
            <p style="color: #6B7280; margin-bottom: 1.5rem; font-size: 0.9375rem;">Please log in again to continue.</p>
            <button onclick="window.location.href='/login'" style="padding: 0.75rem 1.5rem; background: #BFDCDC; color: #115D4F; border: none; border-radius: 0.75rem; font-size: 0.9375rem; font-weight: 600; cursor: pointer; width: 100%; font-family: var(--font-ui);">
                Log In
            </button>
        </div>
    </div>
    
    <!-- Global session expiry handler for API calls -->
    <script>
    (function() {
        let sessionExpiredShown = false;
        
        const originalFetch = window.fetch;
        window.fetch = function(url, options) {
            return originalFetch.apply(this, arguments).then(function(response) {
                // Clone response so we can read it and still return original
                const cloned = response.clone();
                
                // Only check JSON responses
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    cloned.json().then(function(data) {
                        if (data.error === 'session_expired' && !sessionExpiredShown) {
                            sessionExpiredShown = true;
                            // Freeze UI and show modal
                            document.body.classList.add('frozen');
                            document.getElementById('session-expired-overlay').style.display = 'flex';
                        }
                    }).catch(function() {});
                }
                
                return response;
            });
        };
    })();
    </script>
    
    <!-- Double-click protection for all forms -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('form').forEach(function(form) {
            form.addEventListener('submit', function(e) {
                const submitBtns = form.querySelectorAll('button[type="submit"], input[type="submit"]');
                
                // Defer to allow other handlers to call preventDefault() first
                setTimeout(function() {
                    // Skip if submission was prevented (validation failed)
                    if (e.defaultPrevented) return;
                    
                    submitBtns.forEach(function(btn) {
                        if (btn.disabled) return;
                        btn.dataset.originalText = btn.textContent;
                        btn.disabled = true;
                        btn.textContent = 'Please wait...';
                    });
                }, 0);
            });
        });
        
        // Re-enable buttons if page loaded from back-forward cache
        window.addEventListener('pageshow', function(e) {
            if (e.persisted) {
                document.querySelectorAll('button[type="submit"][disabled], input[type="submit"][disabled]').forEach(function(btn) {
                    btn.disabled = false;
                    if (btn.dataset.originalText) {
                        btn.textContent = btn.dataset.originalText;
                    }
                });
            }
        });
    });
    </script>
    
    {% block extra_js %}{% endblock %}
    
    <!-- Initialize Choices.js on all select elements -->
    <script>
    // Global map to store Choices instances by element ID
    window.choicesInstances = {};
    
    /**
     * Update options for a Choices-enabled select element
     * @param {string} selectId - The ID of the select element
     * @param {Array} options - Array of {value, label, selected} objects
     * @param {boolean} clearFirst - Whether to clear existing options first (default: true)
     */
    window.updateChoicesOptions = function(selectId, options, clearFirst = true) {
        const instance = window.choicesInstances[selectId];
        if (instance) {
            if (clearFirst) {
                instance.clearChoices();
            }
            instance.setChoices(options, 'value', 'label', false);
        } else {
            // Fallback for non-Choices selects
            const select = document.getElementById(selectId);
            if (select) {
                if (clearFirst) {
                    select.innerHTML = '';
                }
                options.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt.value;
                    option.textContent = opt.label;
                    if (opt.selected) option.selected = true;
                    select.appendChild(option);
                });
            }
        }
    };
    
    /**
     * Set selected value for a Choices-enabled select
     * @param {string} selectId - The ID of the select element
     * @param {string} value - The value to select
     */
    window.setChoicesValue = function(selectId, value) {
        const instance = window.choicesInstances[selectId];
        if (instance) {
            instance.setChoiceByValue(value);
        } else {
            const select = document.getElementById(selectId);
            if (select) select.value = value;
        }
    };
    
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize Choices on all select elements except those with .no-choices class
        document.querySelectorAll('select:not(.no-choices)').forEach(function(select) {
            const instance = new Choices(select, {
                searchEnabled: false,
                itemSelectText: '',
                shouldSort: false,
                allowHTML: false
            });
            // Store instance if element has an ID
            if (select.id) {
                window.choicesInstances[select.id] = instance;
            }
        });
        
        // Server connection monitor
        let disconnected = false;
        const overlay = document.getElementById('server-disconnected-overlay');
        
        async function checkHeartbeat() {
            try {
                const response = await fetch('/api/heartbeat', { method: 'GET', cache: 'no-store' });
                if (response.ok && disconnected) {
                    // Reconnected
                    disconnected = false;
                    overlay.style.display = 'none';
                }
            } catch (e) {
                if (!disconnected) {
                    disconnected = true;
                    overlay.style.display = 'flex';
                }
            }
        }
        
        // Check every 5 seconds
        setInterval(checkHeartbeat, 5000);
    });
    </script>
    
    <!-- Server disconnected overlay -->
    <div id="server-disconnected-overlay" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 99999; justify-content: center; align-items: center;">
        <div style="background: white; padding: 2rem; border-radius: 1rem; text-align: center; max-width: 400px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
            <div style="font-size: 2rem; margin-bottom: 1rem;">⚠️</div>
            <h2 style="margin: 0 0 0.5rem 0; color: #1a202c;">Server Disconnected</h2>
            <p style="margin: 0; color: #4a5568;">The EdgeCase server has stopped. Please restart it to continue.</p>
        </div>
    </div>
    
    <script>lucide.createIcons();</script>
</body>
</html>
