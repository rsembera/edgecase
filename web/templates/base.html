<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}EdgeCase Equalizer{% endblock %}</title>
    
    <!-- Shared styles -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/shared.css') }}">

    <!-- Favicons-->
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicons/favicon.ico') }}">
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='favicons/favicon.svg') }}">
    <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='favicons/apple-touch-icon.png') }}">
    <link rel="icon" type="image/png" sizes="96x96" href="{{ url_for('static', filename='favicons/favicon-96x96.png') }}">
    
    <style>
        /* Self-hosted Lexend fonts */
        @font-face {
            font-family: 'Lexend';
            src: url("{{ url_for('static', filename='fonts/Lexend-Light.ttf') }}") format('truetype');
            font-weight: 300;
        }
        @font-face {
            font-family: 'Lexend';
            src: url("{{ url_for('static', filename='fonts/Lexend-Regular.ttf') }}") format('truetype');
            font-weight: 400;
        }
        @font-face {
            font-family: 'Lexend';
            src: url("{{ url_for('static', filename='fonts/Lexend-Medium.ttf') }}") format('truetype');
            font-weight: 500;
        }
        @font-face {
            font-family: 'Lexend';
            src: url("{{ url_for('static', filename='fonts/Lexend-SemiBold.ttf') }}") format('truetype');
            font-weight: 600;
        }
        @font-face {
            font-family: 'Lexend';
            src: url("{{ url_for('static', filename='fonts/Lexend-Bold.ttf') }}") format('truetype');
            font-weight: 700;
        }

        /* Base reset */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        /* Body defaults */
        body {
            font-family: 'Lexend', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            line-height: 1.6;
            color: #111827;
            background: #EDF2F5;
            font-size: 1.125rem; /* 18px base */
        }
        
        /* Main content container */
        main {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        /* Tutti-Frutti theme - colored stat cards (main view only) */
        body.tutti-frutti .stat-card:nth-child(1) { background: #C8D8E0; }
        body.tutti-frutti .stat-card:nth-child(2) { background: #DCD3E8; }
        body.tutti-frutti .stat-card:nth-child(3) { background: #E9CFCF; }
        body.tutti-frutti .stat-card:nth-child(4) { background: #CFE7DA; }
        body.tutti-frutti .stat-card:nth-child(5) { background: #F5DEB0; }
        body.tutti-frutti .stat-card:nth-child(6) { background: #DCD3E8; }
    </style>
    {% block extra_css %}{% endblock %}
</head>
<body>
    <main>
        {% block content %}{% endblock %}
    </main>

    <!-- Server disconnect overlay -->
    <div id="disconnect-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 10000; align-items: center; justify-content: center;">
        <div style="background: white; padding: 2rem; border-radius: 1rem; max-width: 350px; text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.15);">
            <h2 style="color: #1F2937; margin-bottom: 0.75rem; font-size: 1.375rem; font-weight: 700;">Server Disconnected</h2>
            <p style="color: #6B7280; margin-bottom: 1.5rem; font-size: 0.9375rem;">The server has stopped. Refresh the page to reconnect.</p>
            <button onclick="location.reload()" style="padding: 0.75rem 1.5rem; background: #BFDCDC; color: #115D4F; border: none; border-radius: 0.75rem; font-size: 0.9375rem; font-weight: 600; cursor: pointer; width: 100%; font-family: 'Lexend', sans-serif;">
                Refresh Page
            </button>
        </div>
    </div>
    
    <style>
        body.frozen > *:not(#disconnect-overlay) {
            pointer-events: none;
            opacity: 0.6;
            user-select: none;
        }
    </style>
    
    <script>
        // Server disconnect detection
        let disconnectShown = false;
        
        function freezeUI() {
            if (!disconnectShown) {
                disconnectShown = true;
                document.body.classList.add('frozen');
                document.getElementById('disconnect-overlay').style.display = 'flex';
            }
        }
        
        // Override form submission to check connectivity first
        const originalSubmit = HTMLFormElement.prototype.submit;
        HTMLFormElement.prototype.submit = function() {
            const form = this;
            
            fetch('/', { method: 'HEAD', cache: 'no-store' })
                .then(response => {
                    if (response.ok) {
                        originalSubmit.call(form);
                    } else {
                        freezeUI();
                    }
                })
                .catch(() => {
                    freezeUI();
                });
        };
        
        // Intercept link clicks
        document.addEventListener('click', function(e) {
            const link = e.target.closest('a');
            if (link && link.href && link.href.startsWith(window.location.origin) && !link.target) {
                e.preventDefault();
                
                fetch(link.href, { method: 'HEAD', cache: 'no-store' })
                    .then(response => {
                        if (response.ok) {
                            window.location.href = link.href;
                        } else {
                            freezeUI();
                        }
                    })
                    .catch(() => {
                        freezeUI();
                    });
            }
        }, true);
    </script>
    
    <script>
    function applyTheme() {
        const cardStyle = localStorage.getItem('cardStyle') || 'strait-laced';
        const backgroundStyle = localStorage.getItem('backgroundStyle') || 'suit-grey';
        
        // Apply card style
        const cardThemes = ['tutti-frutti', 'ocean-breeze', 'sunset-glow', 'garden-path'];
        // Remove all theme classes first
        cardThemes.forEach(theme => document.body.classList.remove(theme));
        // Add the selected theme (strait-laced has no class)
        if (cardThemes.includes(cardStyle)) {
            document.body.classList.add(cardStyle);
        }
        
        // Apply background
            const solidBackgrounds = {
                'suit-grey': '#C5CDD3',
                'warm-stone': '#D4CEC5',
                'sage-mist': '#C8D1C8',
                'soft-cream': '#E5E1D8'
            };

            if (solidBackgrounds[backgroundStyle]) {
                document.body.style.backgroundImage = 'none';
                document.body.style.backgroundColor = solidBackgrounds[backgroundStyle];
            } else {
            // Parse the background value (system:filename or user:filename)
            let bgPath;
            if (backgroundStyle.startsWith('system:')) {
                const filename = backgroundStyle.replace('system:', '');
                bgPath = `/static/img/${filename}`;
            } else if (backgroundStyle.startsWith('user:')) {
                const filename = backgroundStyle.replace('user:', '');
                bgPath = `/static/user_backgrounds/${filename}`;
            } else {
                // Legacy format (no prefix) - assume system
                bgPath = `/static/img/${backgroundStyle}`;
            }
            
            document.body.style.backgroundImage = `url('${bgPath}')`;
            document.body.style.backgroundSize = 'cover';
            document.body.style.backgroundPosition = 'center';
            document.body.style.backgroundAttachment = 'fixed';
        }
    }
        
        // Apply theme immediately
        applyTheme();
    </script>
    
<!-- Lucide Icons -->
    <script src="{{ url_for('static', filename='js/lucide.min.js') }}"></script>
    
    {% block extra_js %}{% endblock %}
    
    <script>lucide.createIcons();</script>
</body>
</html>