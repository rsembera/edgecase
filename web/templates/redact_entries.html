{% extends "base.html" %}

{% block title %}Redaction - EdgeCase Equalizer{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/redact.css') }}">
{% endblock %}

{% block content %}

<div class="card">
    <div class="entry-header">
        <div>
            <h2><i data-lucide="shield-alert" class="page-icon"></i>Redaction</h2>
            <div class="text-muted">
                <div class="client-info-line">
                    <span class="type-badge" style="background-color: {{ client.type.color }}">
                        {{ client.type.name }}
                    </span>
                </div>
                <div class="client-info-line">
                    {{ client.first_name }} {% if client.middle_name %}{{ client.middle_name }}{% endif %} {{ client.last_name }}
                </div>
                <div>
                    File #{{ client.file_number }}
                </div>
            </div>
        </div>
        <a href="{{ url_for('clients.client_file', client_id=client.id) }}" class="btn">
            <i data-lucide="arrow-left" class="icon-sm"></i> Back
        </a>
    </div>
    
    <div class="warning-box mb-2">
        <i data-lucide="alert-triangle" class="icon-sm"></i>
        <p>Redaction permanently removes content while preserving the audit trail.</p>
    </div>
    
    {% if entries %}
    <table class="redact-table">
        <thead>
            <tr>
                <th>Date</th>
                <th>Class</th>
                <th>Description</th>
                <th>Reason</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            {% for entry in entries %}
            <tr>
                <td class="text-muted">
                    {% if entry.class == 'session' %}
                        {{ entry.session_date|timestamp_to_date }}
                    {% elif entry.class == 'communication' %}
                        {{ entry.comm_date|timestamp_to_date }}
                    {% elif entry.class == 'absence' %}
                        {{ entry.absence_date|timestamp_to_date }}
                    {% elif entry.class == 'item' %}
                        {{ entry.item_date|timestamp_to_date if entry.item_date else '-' }}
                    {% endif %}
                </td>
                <td>
                    {% if entry.class == 'session' %}
                        <span class="session-badge {% if entry.is_consultation %}consultation{% else %}session{% endif %}">
                            {% if entry.is_consultation %}Consultation{% else %}Session{% endif %}
                        </span>
                    {% elif entry.class == 'communication' %}
                        <span class="session-badge session-badge-communication">Communication</span>
                    {% elif entry.class == 'absence' %}
                        <span class="session-badge session-badge-absence">Absence</span>
                    {% elif entry.class == 'item' %}
                        <span class="session-badge session-badge-item">Item</span>
                    {% endif %}
                </td>
                <td>
                    {% if entry.description|length > 30 %}
                        {{ entry.description[:30] }}...
                    {% else %}
                        {{ entry.description }}
                    {% endif %}
                </td>
                <td>
                    <form method="POST" action="{{ url_for('entries.redact_entry', client_id=client.id, entry_id=entry.id) }}" 
                          class="redact-inline-form" onsubmit="return confirmRedaction(this);">
                        <input type="text" 
                               name="reason" 
                               placeholder="Reason for redaction"
                               required
                               minlength="10"
                               class="redact-reason-input">
                    </form>
                </td>
                <td>
                    <button type="submit" form="redact-form-{{ entry.id }}" class="btn btn-danger btn-sm">
                        Redact
                    </button>
                    <form id="redact-form-{{ entry.id }}" method="POST" 
                          action="{{ url_for('entries.redact_entry', client_id=client.id, entry_id=entry.id) }}"
                          onsubmit="return confirmRedaction(this);"
                          style="display: none;">
                        <input type="hidden" name="reason" class="reason-mirror-{{ entry.id }}">
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty-state">
        <p class="text-muted">No locked entries available for redaction.</p>
        <p class="text-muted small">Only locked Session, Communication, Absence, and Item entries can be redacted.</p>
    </div>
    {% endif %}
</div>

<!-- Confirmation Modal -->
<div id="redact-confirm-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <h3><i data-lucide="alert-triangle" class="icon-sm icon-danger"></i> Confirm Redaction</h3>
        <p>This action <strong>permanently removes all content</strong> from this entry. The entry will be marked as [REDACTED] and cannot be restored.</p>
        <p>Are you sure you want to proceed?</p>
        <div class="modal-actions">
            <button type="button" class="btn btn-secondary" onclick="cancelRedaction()">Cancel</button>
            <button type="button" class="btn btn-danger" onclick="proceedWithRedaction()">Yes, Redact</button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let pendingForm = null;

// Mirror reason input to hidden form
document.querySelectorAll('.redact-reason-input').forEach(input => {
    const row = input.closest('tr');
    const entryId = row.querySelector('form[id^="redact-form-"]').id.replace('redact-form-', '');
    const hiddenInput = document.querySelector(`.reason-mirror-${entryId}`);
    
    input.addEventListener('input', () => {
        hiddenInput.value = input.value;
    });
    
    // Also handle Enter key in the input
    input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            hiddenInput.value = input.value;
            const form = document.getElementById(`redact-form-${entryId}`);
            if (input.value.length >= 10) {
                confirmRedaction(form);
            }
        }
    });
});

function confirmRedaction(form) {
    const reasonInput = form.querySelector('input[name="reason"]');
    if (!reasonInput.value || reasonInput.value.length < 10) {
        // Find the visible input and focus it
        const row = form.closest('tr') || document.querySelector(`tr:has(form[action="${form.action}"])`);
        if (row) {
            const visibleInput = row.querySelector('.redact-reason-input');
            if (visibleInput) {
                visibleInput.focus();
                visibleInput.reportValidity();
            }
        }
        return false;
    }
    pendingForm = form;
    document.getElementById('redact-confirm-modal').style.display = 'flex';
    return false;
}

function cancelRedaction() {
    pendingForm = null;
    document.getElementById('redact-confirm-modal').style.display = 'none';
}

function proceedWithRedaction() {
    if (pendingForm) {
        pendingForm.submit();
    }
}

// Close modal on escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        cancelRedaction();
    }
});

// Close modal on overlay click
document.getElementById('redact-confirm-modal').addEventListener('click', function(e) {
    if (e.target === this) {
        cancelRedaction();
    }
});
</script>
{% endblock %}
