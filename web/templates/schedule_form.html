{% extends "base.html" %}

{% block title %}Schedule Appointment - {{ client.first_name }} {{ client.last_name }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/schedule_form.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/pickers.css') }}">
{% endblock %}

{% block content %}

<div class="card schedule-card">
    <div class="schedule-header">
        <div>
            <h2><i data-lucide="calendar-plus" class="page-icon"></i>Schedule Appointment</h2>
            <div class="text-muted">
                <div class="client-info-line">
                    <span class="type-badge" style="background-color: {{ client_type['color'] }}">
                        {{ client_type['name'] }}
                    </span>
                </div>
                <div class="client-info-line">
                    {{ client['first_name'] }} {% if client['middle_name'] %}{{ client['middle_name'] }} {% endif %}{{ client['last_name'] }}
                </div>
                <div>
                    File #{{ client['file_number'] }}
                </div>
            </div>
        </div>
    </div>
    
    <form method="POST" id="schedule-form">
        <!-- Quick Entry -->
        <div class="form-group quick-entry-group">
            <label for="quick_entry">Quick Entry</label>
            <input type="text" 
                   id="quick_entry" 
                   placeholder="e.g., Friday at 2pm, next Tuesday 3:30, Nov 28 6:15pm"
                   autocomplete="off">
            <div id="parse-preview" class="parse-preview"></div>
            <p class="helper-text">Type naturally - date and time will auto-fill below</p>
        </div>
        
        <hr class="schedule-divider">
        
        <!-- Date and Time -->
        <div class="two-column-grid">
            <div class="form-group">
                <label>Date *</label>
                <div id="schedule-date-picker"></div>
                <input type="hidden" id="schedule_date" name="date" value="{{ today_year }}-{{ '%02d'|format(today_month) }}-{{ '%02d'|format(today_day) }}" required>
            </div>
            <div class="form-group">
                <label>Time *</label>
                <div id="schedule-time-picker"></div>
                <input type="hidden" id="appointment_time" name="appointment_time" value="10:00 AM" required>
            </div>
        </div>
        
        <!-- Modality and Format -->
        <div class="two-column-grid">
            <div class="form-group">
                <label for="modality">Modality *</label>
                <select id="modality" name="modality" required>
                    <option value="">Select modality...</option>
                    <option value="in-person">In-Person</option>
                    <option value="videoconference">Videoconference</option>
                    <option value="telephone">Telephone</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="format">Format *</label>
                <select id="format" name="format" required>
                    <option value="individual">Individual</option>
                    <option value="couples">Couples</option>
                    <option value="family">Family</option>
                    <option value="group">Group</option>
                </select>
            </div>
        </div>
        
        <!-- Consultation checkbox -->
        <div class="form-group">
            <label class="checkbox-label">
                <input type="checkbox" id="is_consultation" name="is_consultation">
                <span>Initial consultation</span>
            </label>
        </div>
        
        <!-- Duration and Repeat side by side -->
        <div class="two-column-grid">
            <div class="form-group">
                <label for="duration">Duration (minutes) *</label>
                <input type="number" 
                       id="duration" 
                       name="duration" 
                       value="{{ individual_duration }}" 
                       min="1" 
                       max="180" 
                       step="5"
                       required>
            </div>
            <div class="form-group">
                <label for="repeat">Repeat</label>
                <select id="repeat" name="repeat">
                    <option value="none">Does not repeat</option>
                    <option value="weekly">Weekly</option>
                    <option value="biweekly">Every 2 weeks</option>
                    <option value="monthly">Monthly</option>
                </select>
            </div>
        </div>
        
        <!-- Meeting Link (full width) -->
        <div class="form-group">
            <label for="meet_link">Meeting Link</label>
            <input type="url" 
                   id="meet_link" 
                   name="meet_link" 
                   placeholder="https://meet.google.com/...">
            <p class="helper-text">Optional - for video sessions</p>
        </div>
        
        <!-- Alerts side by side -->
        <div class="two-column-grid">
            <div class="form-group">
                <label for="alert1">First Alert</label>
                <select id="alert1" name="alert1">
                    <option value="none">No alert</option>
                    <option value="0">At time of event</option>
                    <option value="5">5 minutes before</option>
                    <option value="15" selected>15 minutes before</option>
                    <option value="30">30 minutes before</option>
                    <option value="60">1 hour before</option>
                    <option value="120">2 hours before</option>
                    <option value="1440">1 day before</option>
                </select>
            </div>
            <div class="form-group">
                <label for="alert2">Second Alert</label>
                <select id="alert2" name="alert2">
                    <option value="none" selected>No alert</option>
                    <option value="0">At time of event</option>
                    <option value="5">5 minutes before</option>
                    <option value="15">15 minutes before</option>
                    <option value="30">30 minutes before</option>
                    <option value="60">1 hour before</option>
                    <option value="120">2 hours before</option>
                    <option value="1440">1 day before</option>
                </select>
            </div>
        </div>
        
        <!-- Notes -->
        <div class="form-group">
            <label for="notes">Notes</label>
            <textarea id="notes" 
                      name="notes" 
                      rows="3" 
                      placeholder="Any notes about this appointment..."></textarea>
        </div>
    </form>
    
    <!-- Buttons OUTSIDE the form -->
    <div class="schedule-form-actions">
        <a href="{{ url_for('clients.client_file', client_id=client.id) }}" class="btn btn-secondary">Cancel</a>
        <button type="submit" form="schedule-form" class="btn">
            <i data-lucide="calendar-plus"></i>
            Add to Calendar
        </button>
    </div>
</div>

<!-- Missing Link Group Modal -->
<div id="missing-link-modal" class="modal">
    <div class="modal-content" style="max-width: 450px;">
        <h3>Link Group Required</h3>
        <p id="missing-link-message"></p>
        <div class="modal-actions">
            <a href="{{ url_for('links.manage_links') }}" class="btn btn-secondary">Go to Link Groups</a>
            <button type="button" class="btn" onclick="document.getElementById('missing-link-modal').classList.remove('active')">Stay Here</button>
        </div>
    </div>
</div>

<!-- Hidden data for JavaScript -->
<script id="schedule-data" type="application/json">
{
    "todayYear": {{ today_year }},
    "todayMonth": {{ today_month }},
    "todayDay": {{ today_day }},
    "timeFormat": "{{ time_format }}",
    "durations": {
        "individual": {{ individual_duration }},
        "consultation": {{ consultation_duration }},
        "linkGroups": {{ link_group_durations | tojson }}
    },
    "linkGroupMembers": {{ link_group_members | tojson }}
}
</script>

{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/pickers.js') }}"></script>
<script src="{{ url_for('static', filename='js/schedule_form.js') }}"></script>
{% endblock %}
