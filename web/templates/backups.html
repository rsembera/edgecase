{% extends "base.html" %}
{% block title %}Backups - EdgeCase Equalizer{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/backups.css') }}">
{% endblock %}

{% block content %}
<div class="card">
    <div class="page-header">
        <div>
            <h2><i data-lucide="hard-drive-download" class="page-icon"></i>Backup & Restore</h2>
            <p class="page-subtitle">Protect your data with regular backups</p>
        </div>
    </div>
    
    <!-- Status and Actions -->
    <div class="backup-top-section">
        <div class="backup-status-box">
            <div class="status-row">
                <span class="status-label">Last Backup</span>
                <span class="status-value" id="last-backup-display">Loading...</span>
            </div>
            <div class="status-row">
                <span class="status-label">Total Backups</span>
                <span class="status-value" id="backup-count">-</span>
            </div>
        </div>
        <div class="backup-actions">
            <button class="btn" id="backup-now-btn" onclick="performBackup()">
                <span class="btn-text">Backup Now</span>
                <span class="btn-spinner hidden"></span>
            </button>
        </div>
    </div>
    
    <!-- Message area -->
    <div id="backup-message" class="backup-message hidden"></div>
    
    <!-- Restore pending alert -->
    <div id="restore-pending-alert" class="alert-warning hidden">
        <div class="alert-warning-content">
            <i data-lucide="alert-triangle" class="alert-icon"></i>
            <span>Restore pending: <strong id="pending-restore-point"></strong> will be restored on next restart.</span>
        </div>
        <button class="btn-cancel" onclick="cancelRestore()">Cancel Restore</button>
    </div>
    
    <!-- Settings Section -->
    <div class="settings-section">
        <h2>Backup Settings</h2>
        <div class="form-row">
            <div class="form-group">
                <label for="backup-frequency">Automatic Backups</label>
                <select id="backup-frequency">
                    <option value="startup">Every Startup</option>
                    <option value="daily">Daily</option>
                    <option value="weekly">Weekly</option>
                    <option value="manual">Manual Only</option>
                </select>
            </div>
            <div class="form-group">
                <label for="backup-retention">Keep Backups For</label>
                <select id="backup-retention">
                    <option value="1_month">1 Month</option>
                    <option value="6_months">6 Months</option>
                    <option value="1_year">1 Year</option>
                    <option value="forever">Forever</option>
                </select>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label for="backup-location">Backup Location</label>
                <select id="backup-location">
                    <option value="default">Default (~/edgecase/backups)</option>
                </select>
                <div id="location-path" class="location-path"></div>
            </div>
            <div class="form-group"></div>
        </div>
        <div class="form-row">
            <div class="form-group form-group-wide">
                <label for="post-backup-command">Post-Backup Command (optional)</label>
                <input type="text" id="post-backup-command" placeholder="e.g., rsync -av ~/edgecase/backups/ pi@raspberrypi.local:~/backups/">
                <p class="field-help">Command to run after each backup, such as an rsync script for remote sync.</p>
            </div>
        </div>
    </div>
    
    <!-- Backup History -->
    <div class="history-section">
        <h2>Backups</h2>
        <p class="backup-legend">
            <span class="legend-item"><span class="backup-type-badge badge-full">Full</span> Complete backup</span>
            <span class="legend-item"><span class="backup-type-badge badge-incr">Incr</span> Changes only (depends on Full)</span>
            <span class="legend-item"><span class="backup-type-badge badge-safety">Safety</span> Pre-restore backup</span>
        </p>
        <p class="backup-explainer">
            EdgeCase automatically chooses between full and incremental backups. Full backups are created weekly or when no recent full backup exists. Incremental backups capture only changes since the last backup. Backups older than your retention period are automatically deleted.
        </p>
        <div id="backup-list" class="backup-list">
            <div class="backup-list-empty">Loading backups...</div>
        </div>
    </div>
    
    <!-- Restore Section -->
    <div class="restore-section">
        <h2>Restore from Backup</h2>
        <p>Select a backup to restore. A safety backup will be created automatically before restoring.</p>
        <div class="restore-row">
            <select id="restore-point-select">
                <option value="">Select a backup...</option>
            </select>
            <button id="prepare-restore-btn" class="btn btn-restore-action" disabled>Restore</button>
        </div>
    </div>
    
    <!-- Bottom buttons -->
    <div class="bottom-buttons">
        <a href="{{ url_for('clients.index') }}" class="btn"><i data-lucide="arrow-left" class="icon-md"></i> Back</a>
    </div>
</div>

<!-- Restore Confirmation Modal -->
<div id="restore-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <h3>Confirm Restore</h3>
        <p>You are about to restore from:</p>
        <div id="modal-restore-point" class="restore-point-name"></div>
        <div class="warning-text">
            <i data-lucide="alert-triangle" class="warning-icon"></i>
            <span>Your current data will be replaced with the backup data. A safety backup will be created first.</span>
        </div>
        <div class="modal-buttons">
            <button class="btn btn-modal-cancel" onclick="hideRestoreModal()">Cancel</button>
            <button class="btn btn-confirm" onclick="confirmRestore()">Restore</button>
        </div>
    </div>
</div>

<script src="{{ url_for('static', filename='js/backups.js') }}"></script>
<script>
    // Initialize Lucide icons
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
</script>
{% endblock %}
