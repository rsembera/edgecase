{% extends "base.html" %}

{% block title %}Clients - EdgeCase Equalizer{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/main_view.css') }}">
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/main_view.js') }}"></script>
{% endblock %}

{% block content %}

<!-- Stats Cards - Now 6 cards in 2 rows of 3 -->
<div class="stats-container" id="stats-container">
    <div class="stat-card blue" draggable="true" data-card-id="active-clients">
        <div class="stat-number">{{ active_count }}</div>
        <div class="stat-label">Active Clients</div>
    </div>
    <div class="stat-card purple" draggable="true" data-card-id="sessions-month">
        <div class="stat-number">{{ sessions_this_month }}</div>
        <div class="stat-label">Sessions This Month</div>
    </div>
    <div class="stat-card coral" draggable="true" data-card-id="pending-invoices">
        <div class="stat-number">{{ pending_invoices }}</div>
        <div class="stat-label">Pending Invoices</div>
    </div>
    <div class="stat-card mint" draggable="true" data-card-id="billable-month">
        <div class="stat-number">{{ currency|currency_symbol }}{{ "%.2f"|format(billable_this_month|default(0)) }}</div>
        <div class="stat-label">Unbilled This Month</div>
    </div>
    <div class="stat-card peach" draggable="true" data-card-id="current-time">
        <div class="stat-number" id="current-time">{{ current_time }}</div>
        <div class="stat-label" id="current-date">{{ current_date }}</div>
    </div>
    <div class="stat-card lavender nav-card" draggable="true" data-card-id="navigation">
    <div class="grid-2-col">
        <a href="{{ url_for('settings.settings_page') }}" class="nav-btn peach">
            <i data-lucide="sliders-horizontal" class="icon-sm icon-inline"></i>Settings
        </a>
        <a href="{{ url_for('backups.backups_page') }}" class="nav-btn sage">
            <i data-lucide="hard-drive-download" class="icon-sm icon-inline"></i>Backup
        </a>
        <a href="{{ url_for('ledger.ledger') }}" class="nav-btn teal">
            <i data-lucide="wallet" class="icon-sm icon-inline"></i>Ledger
        </a>
        <a href="{{ url_for('statements.outstanding_statements') }}" class="nav-btn purple">
            <i data-lucide="file-text" class="icon-sm icon-inline"></i>Statements
        </a>
    </div>
</div>
</div>

<!-- Controls Bar -->
<div class="controls-bar">
    <div class="controls-left">
        <!-- Filter Dropdown -->
        <div class="dropdown-wrapper">
            <button class="dropdown-btn" id="filter-button">
                Filter: {{ type_filter|length }} type{{ 's' if type_filter|length != 1 else '' }} ▾
            </button>
            <div id="filter-dropdown" class="dropdown-menu-positioned min-width-200" style="display: none;">
                <div id="filter-form">
                    <input type="hidden" name="sort" value="{{ sort_by }}">
                    <input type="hidden" name="order" value="{{ sort_order }}">
                    <input type="hidden" name="search" value="{{ search }}">
                    <input type="hidden" name="view" value="{{ view_mode }}">
                    {% for client_type in all_types %}
                    <label class="dropdown-label">
                        <input type="checkbox" name="type" value="{{ client_type.id }}" 
                               {% if client_type.id|string in type_filter %}checked{% endif %}>
                        <span>{{ client_type.name }}</span>
                    </label>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <!-- Sort Dropdown -->
        <div class="dropdown-wrapper">
            <button class="dropdown-btn" onclick="toggleDropdown('sort-dropdown')">
                Sort: {{ sort_by|replace('_', ' ')|title }} ▾
            </button>
            <div id="sort-dropdown" class="dropdown-menu-positioned min-width-200" style="display: none;">
                <a href="?sort=last_name&order={{ 'desc' if sort_by == 'last_name' and sort_order == 'asc' else 'asc' }}{% for t in type_filter %}&type={{ t }}{% endfor %}&search={{ search }}&view={{ view_mode }}" 
                   class="dropdown-item dropdown-item-sm">
                    Last Name {{ '↓' if sort_by == 'last_name' and sort_order == 'desc' else '↑' if sort_by == 'last_name' else '' }}
                </a>
                <a href="?sort=first_name&order={{ 'desc' if sort_by == 'first_name' and sort_order == 'asc' else 'asc' }}{% for t in type_filter %}&type={{ t }}{% endfor %}&search={{ search }}&view={{ view_mode }}" 
                   class="dropdown-item dropdown-item-sm">
                    First Name {{ '↓' if sort_by == 'first_name' and sort_order == 'desc' else '↑' if sort_by == 'first_name' else '' }}
                </a>
                <a href="?sort=file_number&order={{ 'desc' if sort_by == 'file_number' and sort_order == 'asc' else 'asc' }}{% for t in type_filter %}&type={{ t }}{% endfor %}&search={{ search }}&view={{ view_mode }}" 
                   class="dropdown-item dropdown-item-sm">
                    File Number {{ '↓' if sort_by == 'file_number' and sort_order == 'desc' else '↑' if sort_by == 'file_number' else '' }}
                </a>
                <a href="?sort=last_session&order={{ 'desc' if sort_by == 'last_session' and sort_order == 'asc' else 'asc' }}{% for t in type_filter %}&type={{ t }}{% endfor %}&search={{ search }}&view={{ view_mode }}" 
                   class="dropdown-item dropdown-item-sm">
                    Last Session {{ '↓' if sort_by == 'last_session' and sort_order == 'desc' else '↑' if sort_by == 'last_session' else '' }}
                </a>
                <a href="?sort=created&order={{ 'desc' if sort_by == 'created' and sort_order == 'asc' else 'asc' }}{% for t in type_filter %}&type={{ t }}{% endfor %}&search={{ search }}&view={{ view_mode }}" 
                   class="dropdown-item dropdown-item-sm">
                    Created {{ '↓' if sort_by == 'created' and sort_order == 'desc' else '↑' if sort_by == 'created' else '' }}
                </a>
            </div>
        </div>

        <!-- Search -->
        <form method="get" class="search-box">
            {% for t in type_filter %}<input type="hidden" name="type" value="{{ t }}">{% endfor %}
            <input type="hidden" name="sort" value="{{ sort_by }}">
            <input type="hidden" name="order" value="{{ sort_order }}">
            <input type="hidden" name="view" value="{{ view_mode }}">
            <span class="search-icon"><i data-lucide="search"></i></span>
            <input type="text" name="search" placeholder="Search clients..." value="{{ search }}">
            <button type="button" class="clear-search" style="display: none;"><i data-lucide="x"></i></button>
        </form>
        
        <!-- View Toggle (JS-powered, no reload) -->
        <div class="view-toggle">
            <button type="button" class="view-toggle-btn" id="view-detailed-btn" onclick="setViewMode('detailed')">
                Detailed
            </button>
            <button type="button" class="view-toggle-btn" id="view-compact-btn" onclick="setViewMode('compact')">
                Compact
            </button>
        </div>
    </div>
    
    <div class="flex-center-gap">
        
        <!-- Manage Dropdown -->
        <div class="dropdown-wrapper">
            <button class="dropdown-btn" onclick="toggleDropdown('manage-dropdown')">
                <i data-lucide="settings"></i> Manage ▾
            </button>
            <div id="manage-dropdown" class="dropdown-menu-positioned align-right padding-sm min-width-160" style="display: none;">
                <a href="{{ url_for('clients.add_client') }}" class="dropdown-item">
                    <i data-lucide="plus" class="icon-sm icon-inline"></i>Add Client
                </a>
                <a href="{{ url_for('types.manage_types') }}" class="dropdown-item">
                    <i data-lucide="tag" class="icon-sm icon-inline"></i>Edit Types
                </a>
                <a href="{{ url_for('links.manage_links') }}" class="dropdown-item">
                    <i data-lucide="link" class="icon-sm icon-inline"></i>Edit Links
                </a>

                <div class="dropdown-separator"></div>

                <a href="{{ url_for('clients.deleted_clients') }}" class="dropdown-item">
                    <i data-lucide="archive" class="icon-sm icon-inline"></i>Deleted
                </a>

                <div class="dropdown-separator"></div>
                
                <a href="{{ url_for('auth.logout') }}" class="dropdown-item dropdown-item-danger">
                    <i data-lucide="log-out" class="icon-sm icon-inline"></i>Logout
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Payment Status Legend -->
<div class="legend-card">
    <div class="legend-section">
        <div class="legend-item">
            <div class="legend-dot paid"></div>
            <span>Paid / Up to date</span>
        </div>
        <div class="legend-item">
            <div class="legend-dot pending"></div>
            <span>Payment pending</span>
        </div>
        <div class="legend-item">
            <div class="legend-dot overdue"></div>
            <span>Overdue (30+ days)</span>
        </div>
    </div>
    <div class="legend-section">
        <div class="legend-item">
            <span><u>Underlined</u> = Preferred contact</span>
        </div>
        <div class="legend-item">
            <i data-lucide="alert-triangle" class="icon-warning"></i> <span>= Do not leave message</span>
        </div>
    </div>
</div>

<!-- Clients List -->
{% if clients %}
    <!-- Column Headers (visibility controlled by JS view mode) -->
    <div class="column-headers" id="column-headers">
        <div class="col-status">Status/Type</div>
        <div class="col-type"></div>
        <div class="col-file">File #</div>
        <div class="col-name">Name</div>
        <div class="col-contact">Contact</div>
        <div class="col-dates">Created / Last Session</div>
    </div>
    
    <div class="clients-container" id="clients-container">
        {% for client in clients %}
        <div class="client-card" 
            style="background-color: {{ client.type.bubble_color or '#FBFCFD' }}"
            data-type-id="{{ client.type_id }}"
            onclick="window.location='{{ url_for('clients.client_file', client_id=client.id) }}'">
            
            <!-- Detailed View Content -->
            <div class="detailed-content">
                <div class="payment-dot {{ client.payment_status }}"></div>
                <span class="type-badge" style="background-color: {{ client.type.color }}">
                    {{ client.type.name }}
                </span>
                <span class="file-number">{{ client.file_number }}</span>
                <div class="name-group">
                    {% if client.is_linked %}<span class="link-icon" title="Linked to other clients"><i data-lucide="link" class="icon-sm"></i></span>{% endif %}
                    <span class="client-name">{{ client.last_name }}, {{ client.first_name }}{% if client.middle_name %} {{ client.middle_name }}{% endif %}</span>
                </div>
                <div class="contact-info">
                    {% if client.email %}
                    <a href="mailto:{{ client.email }}" class="contact-link {{ 'preferred' if client.preferred_contact == 'email' else '' }}" onclick="event.stopPropagation()">
                        <i data-lucide="mail" class="icon-sm icon-middle"></i><span>{{ client.email }}</span>
                    </a>
                    {% endif %}
                    {% if client.display_phone %}
                    <span class="phone-with-warning">
                        <a href="{% if client.contact_type == 'text' %}sms:{% else %}tel:{% endif %}{{ client.display_phone }}" 
                           class="contact-link {{ 'preferred' if client.preferred_contact in ['call_cell', 'call_home', 'call_work', 'text'] else '' }}" 
                           onclick="event.stopPropagation()">
                            {{ client.contact_icon|safe }}<span>{{ client.display_phone }}</span></a>{% if client.ok_to_leave_message == 'no' %}<i data-lucide="alert-triangle" class="icon-warning"></i>{% endif %}
                    </span>
                    {% endif %}
                </div>
                <div class="dates">
                    <span class="text-secondary-sm">{{ client.created_at|timestamp_to_date }}</span>
                    <span class="text-divider">/</span>
                    <span class="text-secondary-sm">{{ client.last_session|timestamp_to_date if client.last_session else 'Never' }}</span>
                </div>
            </div>
            
            <!-- Compact View Content -->
            <div class="compact-content">
                <div class="card-header">
                    <div class="payment-dot {{ client.payment_status }}"></div>
                    <span class="type-badge" style="background-color: {{ client.type.color }}">
                        {{ client.type.name }}
                    </span>
                    <span class="text-secondary-sm">{{ client.file_number }}</span>
                </div>
                <div class="client-name">{% if client.is_linked %}<span class="link-icon" title="Linked to other clients"><i data-lucide="link" class="icon-sm"></i></span>{% endif %}{{ client.last_name }}, {{ client.first_name }}{% if client.middle_name %} {{ client.middle_name }}{% endif %}</div>
                <div class="contact-row">
                    {% if client.email %}
                    <a href="mailto:{{ client.email }}" class="contact-link {{ 'preferred' if client.preferred_contact == 'email' else '' }}" onclick="event.stopPropagation()">
                        <i data-lucide="mail" class="icon-sm icon-middle"></i><span>{{ client.email }}</span>
                    </a>
                    {% endif %}
                    {% if client.display_phone %}
                    <span class="phone-with-warning">
                        <a href="{% if client.contact_type == 'text' %}sms:{% else %}tel:{% endif %}{{ client.display_phone }}" 
                           class="contact-link {{ 'preferred' if client.preferred_contact in ['call_cell', 'call_home', 'call_work', 'text'] else '' }}" 
                           onclick="event.stopPropagation()">
                            {{ client.contact_icon|safe }}<span>{{ client.display_phone }}</span></a>{% if client.ok_to_leave_message == 'no' %}<i data-lucide="alert-triangle" class="icon-warning"></i>{% endif %}
                    </span>
                    {% endif %}
                </div>
                <div class="dates-row">
                    <span>Created: {{ client.created_at|timestamp_to_date }}</span>
                    <span>•</span>
                    <span>Last Session: {{ client.last_session|timestamp_to_date if client.last_session else 'Never' }}</span>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
{% else %}
<div class="empty-state">
    <h3>No Clients Yet</h3>
    <p>Add your first client to get started.</p>
    <p class="empty-state-actions">
        <a href="{{ url_for('clients.add_client') }}" class="btn">+ Add Client</a>
    </p>
</div>
{% endif %}

<!-- ============================================================ -->
<!-- BACKUP WARNING MODAL                                         -->
<!-- ============================================================ -->
{% if backup_warning %}
<div id="backup-warning-modal" class="modal" style="display: flex;">
    <div class="modal-content warning-border">
        <h3 class="modal-header-flex">
            <i data-lucide="alert-triangle" class="icon-warning-lg"></i>
            Automatic Backup Failed
        </h3>
        <p>
            The automatic backup could not be completed. Please check your backup settings.
        </p>
        <p class="warning-box">
            <strong>Error:</strong> {{ backup_warning }}
        </p>
        <div class="modal-actions space-between">
            <button onclick="document.getElementById('backup-warning-modal').style.display='none'" class="btn btn-secondary">Dismiss</button>
            <a href="{{ url_for('settings.settings_page') }}#backups" class="btn btn-primary btn-with-icon">
                <i data-lucide="settings" class="icon-sm"></i>
                Check Settings
            </a>
        </div>
    </div>
</div>
<script>
    // Re-initialize Lucide icons for the modal
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
</script>
{% endif %}

<!-- ============================================================ -->
<!-- RETENTION REVIEW MODAL                                       -->
<!-- ============================================================ -->

<!-- Retention Review Modal -->
<div id="retention-modal" class="modal-overlay">
    <div class="modal-content max-w-700 warning-border">
        <h3 class="modal-title">
            <i data-lucide="alert-triangle" class="icon-inline-alert"></i>
            File Retention Review Required
        </h3>
        <p class="modal-body-text">
            The following client files have exceeded their retention period and are due for deletion. 
            Select the files you wish to permanently delete. An archive record will be kept for audit purposes.
        </p>
        
        <div id="retention-list" class="scrollable-list">
            <!-- Populated by JavaScript -->
        </div>
        
        <p class="warning-box mb-lg">
            <strong>Warning:</strong> This action cannot be undone. All entries, attachments, and client data will be permanently deleted.
        </p>
        
        <div class="flex-between-gap">
            <button onclick="deleteSelectedClients()" id="delete-selected-btn" class="btn-disabled" disabled>Delete Selected (0)</button>
            <button onclick="closeRetentionModal()" class="btn">Review Later</button>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="delete-confirm-modal" class="modal-overlay darker">
    <div class="modal-content max-w-450 danger-border">
        <h3 class="modal-title">Confirm Permanent Deletion</h3>
        <p class="modal-body-text mb-lg">
            Are you sure you want to permanently delete <strong id="delete-count"></strong> client file(s)? This cannot be undone.
        </p>
        <div class="flex-between-gap">
            <button onclick="cancelDeletion()" class="btn">Cancel</button>
            <button onclick="confirmDeletion()" class="btn-danger-solid">Delete Permanently</button>
        </div>
    </div>
</div>


{% endblock %}
