{% extends "base.html" %}

{% block title %}Clients - EdgeCase Equalizer{% endblock %}

{% block extra_css %}
<style>
    /* Override base styles for new design */
    body {
        background: #F5F7FA;
    }
    
    /* Stats cards */
    .stats-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .stat-card {
        background: white;
        border-radius: 1rem;
        padding: 1.5rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        transition: transform 0.2s;
    }
    
    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    }
    
    .stat-number {
        font-size: 2.5rem;
        font-weight: 700;
        color: #1F2937;
        margin-bottom: 0.25rem;
    }
    
    .stat-label {
        font-size: 0.875rem;
        color: #6B7280;
        font-weight: 500;
    }
    
    /* Controls area */
    .controls-bar {
        background: white;
        border-radius: 1rem;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
    }
    
    .controls-left {
        display: flex;
        gap: 1rem;
        align-items: center;
        flex-wrap: wrap;
    }
    
    .search-box {
        position: relative;
    }
    
    .search-box input {
        padding: 0.75rem 2.5rem 0.75rem 1rem;
        border: 2px solid #E5E7EB;
        border-radius: 0.75rem;
        font-size: 0.875rem;
        width: 300px;
        transition: all 0.2s;
    }
    
    .search-box input:focus {
        outline: none;
        border-color: #00aa88;
        box-shadow: 0 0 0 3px rgba(0,170,136,0.1);
    }
    
    .search-icon {
        position: absolute;
        right: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        color: #9CA3AF;
        font-size: 1.125rem;
    }
    
    /* Dropdown buttons */
    .dropdown-btn {
        padding: 0.75rem 1.25rem;
        background: white;
        border: 2px solid #E5E7EB;
        border-radius: 0.75rem;
        font-size: 0.875rem;
        font-weight: 500;
        color: #374151;
        cursor: pointer;
        transition: all 0.2s;
        position: relative;
    }
    
    .dropdown-btn:hover {
        border-color: #00aa88;
        color: #00aa88;
    }
    
    /* Client cards */
    .clients-container {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }
    
    .client-card {
        background: white;
        border-radius: 1rem;
        padding: 1.5rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        transition: all 0.2s;
        cursor: pointer;
    }
    
    .client-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    }
    
    /* Detailed view - single line */
    .client-card.detailed-view {
        display: flex;
        align-items: center;
        gap: 1.5rem;
        padding: 1rem 1.5rem;
    }
    
    .client-card.detailed-view .payment-dot {
        flex-shrink: 0;
    }
    
    .client-card.detailed-view .type-badge {
        flex-shrink: 0;
    }
    
    .client-card.detailed-view .client-name {
        font-weight: 600;
        color: #1F2937;
        flex-shrink: 0;
        min-width: 200px;
    }
    
    .client-card.detailed-view .contact-info {
        display: flex;
        gap: 1.5rem;
        flex-shrink: 0;
    }
    
    .client-card.detailed-view .dates {
        display: flex;
        gap: 1.5rem;
        margin-left: auto;
        flex-shrink: 0;
    }
    
    /* Compact view - three lines */
    .client-card.compact-view {
        padding: 1.5rem;
    }
    
    .client-card.compact-view .card-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1rem;
    }
    
    .client-card.compact-view .client-name {
        font-size: 1.25rem;
        font-weight: 700;
        color: #1F2937;
        margin-bottom: 0.75rem;
    }
    
    .client-card.compact-view .contact-row {
        display: flex;
        gap: 2rem;
        margin-bottom: 0.5rem;
    }
    
    .client-card.compact-view .dates-row {
        display: flex;
        gap: 2rem;
        font-size: 0.875rem;
        color: #6B7280;
    }
    
    /* Payment status dots */
    .payment-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        flex-shrink: 0;
    }
    
    .payment-dot.paid { background: #10B981; }
    .payment-dot.pending { background: #F59E0B; }
    .payment-dot.overdue { background: #EF4444; }
    
    /* Type badges with soft pastels */
    .type-badge {
        padding: 0.375rem 0.75rem;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        font-weight: 600;
        white-space: nowrap;
    }
    
    /* Soft pastel backgrounds based on type */
    .type-mint { background: #D5F5F0; color: #0F766E; }
    .type-yellow { background: #FFF4D6; color: #B45309; }
    .type-pink { background: #FFE5F0; color: #BE185D; }
    .type-purple { background: #EDE7F6; color: #6D28D9; }
    
    /* Contact links */
    .contact-link {
        color: #374151;
        text-decoration: none;
        font-size: 0.875rem;
        transition: color 0.2s;
    }
    
    .contact-link:hover {
        color: #00aa88;
    }
    
    .contact-link.preferred {
        font-weight: 600;
        text-decoration: underline;
    }
    
    /* View toggle */
    .view-toggle {
        display: flex;
        gap: 0.5rem;
        background: #F3F4F6;
        padding: 0.25rem;
        border-radius: 0.75rem;
    }
    
    .view-toggle-btn {
        padding: 0.5rem 1rem;
        border: none;
        background: transparent;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        font-weight: 500;
        color: #6B7280;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .view-toggle-btn.active {
        background: white;
        color: #00aa88;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    /* Add client button */
    .btn-primary {
        padding: 0.75rem 1.5rem;
        background: #00aa88;
        color: white;
        border: none;
        border-radius: 0.75rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        text-decoration: none;
        display: inline-block;
    }
    
    .btn-primary:hover {
        background: #008f73;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0,170,136,0.3);
    }
</style>
{% endblock %}

{% block content %}

<!-- Stats Cards -->
<div class="stats-container">
    <div class="stat-card">
        <div class="stat-number">{{ active_count }}</div>
        <div class="stat-label">Active Clients</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ sessions_this_week }}</div>
        <div class="stat-label">Sessions This Week</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ pending_invoices }}</div>
        <div class="stat-label">Pending Invoices</div>
    </div>
</div>

<!-- Controls Bar -->
<div class="controls-bar">
    <div class="controls-left">
        <!-- Filter Dropdown -->
        <div style="position: relative;">
            <button class="dropdown-btn" onclick="toggleDropdown('filter-dropdown')">
                Filter: {{ type_filter|length }} type{{ 's' if type_filter|length != 1 else '' }} ‚ñæ
            </button>
            <div id="filter-dropdown" style="display: none; position: absolute; top: 100%; left: 0; margin-top: 0.5rem; background: white; border-radius: 0.75rem; box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 1rem; min-width: 250px; z-index: 100;">
                <form method="get" id="filter-form">
                    <input type="hidden" name="sort" value="{{ sort_by }}">
                    <input type="hidden" name="order" value="{{ sort_order }}">
                    <input type="hidden" name="search" value="{{ search }}">
                    <input type="hidden" name="view" value="{{ view_mode }}">
                    {% for client_type in all_types %}
                    <label style="display: block; margin-bottom: 0.75rem; cursor: pointer;">
                        <input type="checkbox" name="type" value="{{ client_type.id }}" 
                               {% if client_type.id|string in type_filter %}checked{% endif %}
                               onchange="document.getElementById('filter-form').submit()">
                        <span style="margin-left: 0.5rem; font-size: 0.875rem;">{{ client_type.name }}</span>
                    </label>
                    {% endfor %}
                </form>
            </div>
        </div>
        
        <!-- Sort Dropdown -->
        <div style="position: relative;">
            <button class="dropdown-btn" onclick="toggleDropdown('sort-dropdown')">
                Sort: {{ sort_by|replace('_', ' ')|title }} ‚ñæ
            </button>
            <div id="sort-dropdown" style="display: none; position: absolute; top: 100%; left: 0; margin-top: 0.5rem; background: white; border-radius: 0.75rem; box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 1rem; min-width: 200px; z-index: 100;">
                <a href="?sort=last_name&order={{ 'desc' if sort_by == 'last_name' and sort_order == 'asc' else 'asc' }}{% for t in type_filter %}&type={{ t }}{% endfor %}&search={{ search }}&view={{ view_mode }}" 
                   style="display: block; padding: 0.5rem; color: #374151; text-decoration: none; border-radius: 0.5rem; font-size: 0.875rem;" 
                   onmouseover="this.style.background='#F3F4F6'" onmouseout="this.style.background='transparent'">
                    Last Name {{ '‚Üì' if sort_by == 'last_name' and sort_order == 'desc' else '‚Üë' if sort_by == 'last_name' else '' }}
                </a>
                <a href="?sort=first_name&order={{ 'desc' if sort_by == 'first_name' and sort_order == 'asc' else 'asc' }}{% for t in type_filter %}&type={{ t }}{% endfor %}&search={{ search }}&view={{ view_mode }}" 
                   style="display: block; padding: 0.5rem; color: #374151; text-decoration: none; border-radius: 0.5rem; font-size: 0.875rem;" 
                   onmouseover="this.style.background='#F3F4F6'" onmouseout="this.style.background='transparent'">
                    First Name {{ '‚Üì' if sort_by == 'first_name' and sort_order == 'desc' else '‚Üë' if sort_by == 'first_name' else '' }}
                </a>
                <a href="?sort=file_number&order={{ 'desc' if sort_by == 'file_number' and sort_order == 'asc' else 'asc' }}{% for t in type_filter %}&type={{ t }}{% endfor %}&search={{ search }}&view={{ view_mode }}" 
                   style="display: block; padding: 0.5rem; color: #374151; text-decoration: none; border-radius: 0.5rem; font-size: 0.875rem;" 
                   onmouseover="this.style.background='#F3F4F6'" onmouseout="this.style.background='transparent'">
                    File Number {{ '‚Üì' if sort_by == 'file_number' and sort_order == 'desc' else '‚Üë' if sort_by == 'file_number' else '' }}
                </a>
                <a href="?sort=last_session&order={{ 'desc' if sort_by == 'last_session' and sort_order == 'asc' else 'asc' }}{% for t in type_filter %}&type={{ t }}{% endfor %}&search={{ search }}&view={{ view_mode }}" 
                   style="display: block; padding: 0.5rem; color: #374151; text-decoration: none; border-radius: 0.5rem; font-size: 0.875rem;" 
                   onmouseover="this.style.background='#F3F4F6'" onmouseout="this.style.background='transparent'">
                    Last Session {{ '‚Üì' if sort_by == 'last_session' and sort_order == 'desc' else '‚Üë' if sort_by == 'last_session' else '' }}
                </a>
                <a href="?sort=created&order={{ 'desc' if sort_by == 'created' and sort_order == 'asc' else 'asc' }}{% for t in type_filter %}&type={{ t }}{% endfor %}&search={{ search }}&view={{ view_mode }}" 
                   style="display: block; padding: 0.5rem; color: #374151; text-decoration: none; border-radius: 0.5rem; font-size: 0.875rem;" 
                   onmouseover="this.style.background='#F3F4F6'" onmouseout="this.style.background='transparent'">
                    Created {{ '‚Üì' if sort_by == 'created' and sort_order == 'desc' else '‚Üë' if sort_by == 'created' else '' }}
                </a>
            </div>
        </div>
        
        <!-- View Toggle -->
        <div class="view-toggle">
            <a href="?view=detailed{% for t in type_filter %}&type={{ t }}{% endfor %}&sort={{ sort_by }}&order={{ sort_order }}&search={{ search }}" 
               class="view-toggle-btn {{ 'active' if view_mode == 'detailed' else '' }}">
                Detailed
            </a>
            <a href="?view=compact{% for t in type_filter %}&type={{ t }}{% endfor %}&sort={{ sort_by }}&order={{ sort_order }}&search={{ search }}" 
               class="view-toggle-btn {{ 'active' if view_mode == 'compact' else '' }}">
                Compact
            </a>
        </div>
    </div>
    
    <div style="display: flex; align-items: center; gap: 1rem;">
        <!-- Search -->
        <form method="get" class="search-box">
            {% for t in type_filter %}<input type="hidden" name="type" value="{{ t }}">{% endfor %}
            <input type="hidden" name="sort" value="{{ sort_by }}">
            <input type="hidden" name="order" value="{{ sort_order }}">
            <input type="hidden" name="view" value="{{ view_mode }}">
            <input type="text" name="search" placeholder="Search clients..." value="{{ search }}">
            <span class="search-icon">üîç</span>
        </form>
        
        <!-- Add Client Button -->
        <a href="{{ url_for('add_client') }}" class="btn-primary">+ Add Client</a>
    </div>
</div>

<!-- Clients List -->
{% if clients %}
<div class="clients-container">
    {% for client in clients %}
    <div class="client-card {{ view_mode }}-view" onclick="window.location='{{ url_for('client_file', client_id=client.id) }}'">
        {% if view_mode == 'detailed' %}
            <!-- Detailed View: Single horizontal line -->
            <div class="payment-dot {{ client.payment_status }}"></div>
            <span class="type-badge type-{% if client.type.name == 'Active' %}mint{% elif client.type.name == 'Inactive' %}yellow{% else %}pink{% endif %}">
                {{ client.type.name }}
            </span>
            <span style="color: #6B7280; font-size: 0.875rem; flex-shrink: 0;">#{{ client.file_number }}</span>
            <span class="client-name">{{ client.last_name }}, {{ client.first_name }}{% if client.middle_name %} {{ client.middle_name }}{% endif %}</span>
            <div class="contact-info">
                {% if client.email %}
                <a href="mailto:{{ client.email }}" class="contact-link {{ 'preferred' if client.preferred_contact == 'email' else '' }}" onclick="event.stopPropagation()">
                    üìß {{ client.email }}
                </a>
                {% endif %}
                {% if client.display_phone %}
                <a href="{% if client.contact_type == 'text' %}sms:{% else %}tel:{% endif %}{{ client.display_phone }}" 
                   class="contact-link {{ 'preferred' if client.preferred_contact in ['call_cell', 'call_home', 'call_work', 'text'] else '' }}" 
                   onclick="event.stopPropagation()">
                    {{ client.contact_icon }} {{ client.display_phone }}
                    {% if client.ok_to_leave_message == 'no' %}‚ö†Ô∏è{% endif %}
                </a>
                {% endif %}
            </div>
            <div class="dates">
                <span style="color: #6B7280; font-size: 0.875rem;">Last: {{ client.last_session|timestamp_to_date if client.last_session else 'Never' }}</span>
                <span style="color: #6B7280; font-size: 0.875rem;">Created: {{ client.created_at|timestamp_to_date }}</span>
            </div>
        {% else %}
            <!-- Compact View: Three-line card -->
            <div class="card-header">
                <div class="payment-dot {{ client.payment_status }}"></div>
                <span class="type-badge type-{% if client.type.name == 'Active' %}mint{% elif client.type.name == 'Inactive' %}yellow{% else %}pink{% endif %}">
                    {{ client.type.name }}
                </span>
                <span style="color: #6B7280; font-size: 0.875rem;">#{{ client.file_number }}</span>
            </div>
            <div class="client-name">{{ client.last_name }}, {{ client.first_name }}{% if client.middle_name %} {{ client.middle_name }}{% endif %}</div>
            <div class="contact-row">
                {% if client.email %}
                <a href="mailto:{{ client.email }}" class="contact-link {{ 'preferred' if client.preferred_contact == 'email' else '' }}" onclick="event.stopPropagation()">
                    üìß {{ client.email }}
                </a>
                {% endif %}
                {% if client.display_phone %}
                <a href="{% if client.contact_type == 'text' %}sms:{% else %}tel:{% endif %}{{ client.display_phone }}" 
                   class="contact-link {{ 'preferred' if client.preferred_contact in ['call_cell', 'call_home', 'call_work', 'text'] else '' }}" 
                   onclick="event.stopPropagation()">
                    {{ client.contact_icon }} {{ client.display_phone }}
                    {% if client.ok_to_leave_message == 'no' %}‚ö†Ô∏è{% endif %}
                </a>
                {% endif %}
            </div>
            <div class="dates-row">
                <span>Last Session: {{ client.last_session|timestamp_to_date if client.last_session else 'Never' }}</span>
                <span>‚Ä¢</span>
                <span>Created: {{ client.created_at|timestamp_to_date }}</span>
            </div>
        {% endif %}
    </div>
    {% endfor %}
</div>
{% else %}
<div style="text-align: center; padding: 4rem; background: white; border-radius: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
    <p style="color: #6B7280; font-size: 1.125rem; margin-bottom: 1.5rem;">No clients found.</p>
    <a href="{{ url_for('add_client') }}" class="btn-primary">+ Add Your First Client</a>
</div>
{% endif %}

<script>
function toggleDropdown(id) {
    const dropdown = document.getElementById(id);
    // Close all other dropdowns
    document.querySelectorAll('[id$="-dropdown"]').forEach(d => {
        if (d.id !== id) d.style.display = 'none';
    });
    dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
}

// Close dropdowns when clicking outside
document.addEventListener('click', function(event) {
    if (!event.target.closest('.dropdown-btn') && !event.target.closest('[id$="-dropdown"]')) {
        document.querySelectorAll('[id$="-dropdown"]').forEach(d => d.style.display = 'none');
    }
});
</script>

{% endblock %}