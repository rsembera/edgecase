{% extends "base.html" %}

{% block title %}Clients - EdgeCase Equalizer{% endblock %}

{% block extra_css %}
<style>
    /* Override base styles for new design */
    body {
        background: #F5F7FA;
    }
    
    /* Stats cards row - now 4 cards */
    .stats-container {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .stat-card {
        border-radius: 1rem;
        padding: 1.5rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        transition: transform 0.2s;
    }
    
    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    }
    
    /* Pastel backgrounds for stat cards */
    .stat-card.blue { background: #E0F2FE; }
    .stat-card.purple { background: #EDE9FE; }
    .stat-card.coral { background: #FED7D7; }
    .stat-card.lavender { background: #F3E8FF; }
    
    .stat-number {
        font-size: 2.5rem;
        font-weight: 700;
        color: #1F2937;
        margin-bottom: 0.25rem;
    }
    
    .stat-label {
        font-size: 0.875rem;
        color: #6B7280;
        font-weight: 500;
    }
    
    /* Navigation card (4th card) */
    .nav-card {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }
    
    .nav-card h2 {
        font-size: 1.25rem;
        font-weight: 700;
        color: #1F2937;
        margin-bottom: 0.5rem;
    }
    
    .nav-btn {
        display: block;
        padding: 0.625rem 1rem;
        border-radius: 0.5rem;
        text-align: center;
        text-decoration: none;
        font-size: 0.875rem;
        font-weight: 600;
        transition: all 0.2s;
    }
    
    .nav-btn.teal {
        background: #CCFBF1;
        color: #115E59;
    }
    
    .nav-btn.teal:hover {
        background: #99F6E4;
    }
    
    .nav-btn.rose {
        background: #FFE4E6;
        color: #881337;
    }
    
    .nav-btn.rose:hover {
        background: #FECDD3;
    }
    
    /* Controls area */
    .controls-bar {
        background: white;
        border-radius: 1rem;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
    }
    
    .controls-left {
        display: flex;
        gap: 1rem;
        align-items: center;
        flex-wrap: wrap;
    }
    
    .search-box {
        position: relative;
    }
    
    .search-box input {
        padding: 0.75rem 2.5rem 0.75rem 1rem;
        border: 2px solid #E5E7EB;
        border-radius: 0.75rem;
        font-size: 0.875rem;
        width: 300px;
        transition: all 0.2s;
    }
    
    .search-box input:focus {
        outline: none;
        border-color: #00aa88;
        box-shadow: 0 0 0 3px rgba(0,170,136,0.1);
    }
    
    .search-icon {
        position: absolute;
        right: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        color: #9CA3AF;
        font-size: 1.125rem;
    }
    
    /* Dropdown buttons */
    .dropdown-btn {
        padding: 0.75rem 1.25rem;
        background: white;
        border: 2px solid #E5E7EB;
        border-radius: 0.75rem;
        font-size: 0.875rem;
        font-weight: 500;
        color: #374151;
        cursor: pointer;
        transition: all 0.2s;
        position: relative;
    }
    
    .dropdown-btn:hover {
        border-color: #00aa88;
        color: #00aa88;
    }
    
    /* View toggle */
    .view-toggle {
        display: flex;
        background: #F3F4F6;
        border-radius: 0.75rem;
        padding: 0.25rem;
        gap: 0.25rem;
    }
    
    .view-toggle-btn {
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        font-weight: 500;
        color: #6B7280;
        text-decoration: none;
        transition: all 0.2s;
    }
    
    .view-toggle-btn.active {
        background: white;
        color: #00aa88;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .btn-primary {
        padding: 0.75rem 1.5rem;
        background: #00aa88;
        color: white;
        text-decoration: none;
        border-radius: 0.75rem;
        font-size: 0.875rem;
        font-weight: 600;
        transition: all 0.2s;
        display: inline-block;
    }
    
    .btn-primary:hover {
        background: #008f73;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0,170,136,0.3);
    }
    
    /* Column headers - CRITICAL: These widths must match client card fields */
    .column-headers {
        position: sticky;
        top: 0;
        background: white;
        border-radius: 1rem;
        padding: 0.875rem 1.25rem;
        margin-bottom: 0.75rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        display: flex;
        align-items: center;
        z-index: 10;
        font-size: 0.6875rem;
        font-weight: 600;
        color: #9CA3AF;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    
    /* Column widths - MATCH THESE IN CLIENT CARDS */
    .col-status { 
        width: 12px; 
        flex-shrink: 0; 
        margin-right: 1rem;
    }
    
    .col-type { 
        width: 80px; 
        flex-shrink: 0; 
        margin-right: 1rem;
    }
    
    .col-file { 
        width: 140px; 
        flex-shrink: 0; 
        margin-right: 1rem;
    }
    
    .col-name { 
        width: 250px; 
        flex-shrink: 0; 
        margin-right: 1rem;
    }
    
    .col-contact { 
        flex: 1; 
        min-width: 200px;
        margin-right: 1rem;
    }
    
    .col-dates { 
        width: 220px; 
        flex-shrink: 0; 
        text-align: right;
    }
    
    /* Client cards */
    .clients-container {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }
    
    .client-card {
        border-radius: 1rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        transition: all 0.2s;
        cursor: pointer;
    }
    
    .client-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    }
    
    /* Pastel backgrounds based on type - different from stat cards */
    .client-card.type-mint { background: #F0F9F7; }
    .client-card.type-yellow { background: #FFFBEB; }
    .client-card.type-pink { background: #FFF5F7; }
    .client-card.type-purple { background: #F5F3FF; }
    
    /* Detailed view - single line with EXACT column alignment */
    .client-card.detailed-view {
        display: flex;
        align-items: center;
        padding: 0.875rem 1.25rem;
    }
    
    /* Match column widths EXACTLY */
    .client-card.detailed-view .payment-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        flex-shrink: 0;
        margin-right: 1rem;
    }
    
    .client-card.detailed-view .type-badge {
        width: 80px;
        flex-shrink: 0;
        margin-right: 1rem;
        padding: 0.25rem 0.5rem;
        border-radius: 0.375rem;
        font-size: 0.75rem;
        font-weight: 600;
        text-align: center;
    }
    
    .client-card.detailed-view .file-number {
        width: 140px;
        flex-shrink: 0;
        margin-right: 1rem;
        color: #6B7280;
        font-size: 0.875rem;
    }
    
    .client-card.detailed-view .client-name {
        width: 250px;
        flex-shrink: 0;
        margin-right: 1rem;
        font-weight: 600;
        color: #1F2937;
        font-size: 0.9375rem;
    }
    
    .client-card.detailed-view .contact-info {
        flex: 1;
        min-width: 200px;
        margin-right: 1rem;
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
    }
    
    .client-card.detailed-view .dates {
        width: 220px;
        flex-shrink: 0;
        display: flex;
        gap: 0.5rem;
        justify-content: flex-end;
        align-items: center;
    }
    
    /* Payment status dots */
    .payment-dot.paid { background: #10B981; }
    .payment-dot.pending { background: #F59E0B; }
    .payment-dot.overdue { background: #EF4444; }
    
    /* Type badges with specific colors */
    .type-badge.type-mint { background: #CCFBF1; color: #115E59; }
    .type-badge.type-yellow { background: #FEF3C7; color: #92400E; }
    .type-badge.type-pink { background: #FCE7F3; color: #9F1239; }
    .type-badge.type-purple { background: #E9D5FF; color: #6B21A8; }
    
    /* Contact links */
    .contact-link {
        color: #6B7280;
        text-decoration: none;
        font-size: 0.875rem;
        transition: color 0.2s;
    }
    
    .contact-link:hover {
        color: #00aa88;
    }
    
    .contact-link.preferred {
        text-decoration: underline;
        color: #374151;
    }
    
    /* Compact view - multi-line card */
    .client-card.compact-view {
        padding: 1rem 1.25rem;
    }
    
    .card-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 0.5rem;
    }
    
    .card-header .payment-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
    }
    
    .card-header .type-badge {
        padding: 0.25rem 0.5rem;
        border-radius: 0.375rem;
        font-size: 0.75rem;
        font-weight: 600;
    }
    
    .compact-view .client-name {
        font-size: 1.125rem;
        font-weight: 600;
        color: #1F2937;
        margin-bottom: 0.5rem;
    }
    
    .contact-row {
        display: flex;
        gap: 1rem;
        margin-bottom: 0.5rem;
        flex-wrap: wrap;
    }
    
    .dates-row {
        display: flex;
        gap: 0.5rem;
        font-size: 0.875rem;
        color: #6B7280;
    }
</style>
{% endblock %}

{% block content %}

<!-- Stats Cards - Now 4 cards -->
<div class="stats-container">
    <div class="stat-card blue">
        <div class="stat-number">{{ active_count }}</div>
        <div class="stat-label">Active Clients</div>
    </div>
    <div class="stat-card purple">
        <div class="stat-number">{{ sessions_this_week }}</div>
        <div class="stat-label">Sessions This Week</div>
    </div>
    <div class="stat-card coral">
        <div class="stat-number">{{ pending_invoices }}</div>
        <div class="stat-label">Pending Invoices</div>
    </div>
    <div class="stat-card lavender nav-card">
        <h2>EdgeCase Equalizer</h2>
        <a href="{{ url_for('manage_types') }}" class="nav-btn teal">Edit Client Types</a>
        <a href="#" class="nav-btn rose">Settings</a>
    </div>
</div>

<!-- Controls Bar -->
<div class="controls-bar">
    <div class="controls-left">
        <!-- Filter Dropdown -->
        <div style="position: relative;">
            <button class="dropdown-btn" onclick="toggleDropdown('filter-dropdown')">
                Filter: {{ type_filter|length }} type{{ 's' if type_filter|length != 1 else '' }} ‚ñæ
            </button>
            <div id="filter-dropdown" style="display: none; position: absolute; top: 100%; left: 0; margin-top: 0.5rem; background: white; border-radius: 0.75rem; box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 1rem; min-width: 200px; z-index: 100;">
                <form id="filter-form" method="get">
                    <input type="hidden" name="sort" value="{{ sort_by }}">
                    <input type="hidden" name="order" value="{{ sort_order }}">
                    <input type="hidden" name="search" value="{{ search }}">
                    <input type="hidden" name="view" value="{{ view_mode }}">
                    {% for client_type in all_types %}
                    <label style="display: block; padding: 0.5rem; cursor: pointer; border-radius: 0.5rem;" 
                           onmouseover="this.style.background='#F3F4F6'" 
                           onmouseout="this.style.background='transparent'">
                        <input type="checkbox" name="type" value="{{ client_type.id }}" 
                               {% if client_type.id|string in type_filter %}checked{% endif %}
                               onchange="document.getElementById('filter-form').submit()">
                        <span style="margin-left: 0.5rem; font-size: 0.875rem;">{{ client_type.name }}</span>
                    </label>
                    {% endfor %}
                </form>
            </div>
        </div>
        
        <!-- Sort Dropdown -->
        <div style="position: relative;">
            <button class="dropdown-btn" onclick="toggleDropdown('sort-dropdown')">
                Sort: {{ sort_by|replace('_', ' ')|title }} ‚ñæ
            </button>
            <div id="sort-dropdown" style="display: none; position: absolute; top: 100%; left: 0; margin-top: 0.5rem; background: white; border-radius: 0.75rem; box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 1rem; min-width: 200px; z-index: 100;">
                <a href="?sort=last_name&order={{ 'desc' if sort_by == 'last_name' and sort_order == 'asc' else 'asc' }}{% for t in type_filter %}&type={{ t }}{% endfor %}&search={{ search }}&view={{ view_mode }}" 
                   style="display: block; padding: 0.5rem; color: #374151; text-decoration: none; border-radius: 0.5rem; font-size: 0.875rem;" 
                   onmouseover="this.style.background='#F3F4F6'" onmouseout="this.style.background='transparent'">
                    Last Name {{ '‚Üì' if sort_by == 'last_name' and sort_order == 'desc' else '‚Üë' if sort_by == 'last_name' else '' }}
                </a>
                <a href="?sort=first_name&order={{ 'desc' if sort_by == 'first_name' and sort_order == 'asc' else 'asc' }}{% for t in type_filter %}&type={{ t }}{% endfor %}&search={{ search }}&view={{ view_mode }}" 
                   style="display: block; padding: 0.5rem; color: #374151; text-decoration: none; border-radius: 0.5rem; font-size: 0.875rem;" 
                   onmouseover="this.style.background='#F3F4F6'" onmouseout="this.style.background='transparent'">
                    First Name {{ '‚Üì' if sort_by == 'first_name' and sort_order == 'desc' else '‚Üë' if sort_by == 'first_name' else '' }}
                </a>
                <a href="?sort=file_number&order={{ 'desc' if sort_by == 'file_number' and sort_order == 'asc' else 'asc' }}{% for t in type_filter %}&type={{ t }}{% endfor %}&search={{ search }}&view={{ view_mode }}" 
                   style="display: block; padding: 0.5rem; color: #374151; text-decoration: none; border-radius: 0.5rem; font-size: 0.875rem;" 
                   onmouseover="this.style.background='#F3F4F6'" onmouseout="this.style.background='transparent'">
                    File Number {{ '‚Üì' if sort_by == 'file_number' and sort_order == 'desc' else '‚Üë' if sort_by == 'file_number' else '' }}
                </a>
                <a href="?sort=last_session&order={{ 'desc' if sort_by == 'last_session' and sort_order == 'asc' else 'asc' }}{% for t in type_filter %}&type={{ t }}{% endfor %}&search={{ search }}&view={{ view_mode }}" 
                   style="display: block; padding: 0.5rem; color: #374151; text-decoration: none; border-radius: 0.5rem; font-size: 0.875rem;" 
                   onmouseover="this.style.background='#F3F4F6'" onmouseout="this.style.background='transparent'">
                    Last Session {{ '‚Üì' if sort_by == 'last_session' and sort_order == 'desc' else '‚Üë' if sort_by == 'last_session' else '' }}
                </a>
                <a href="?sort=created&order={{ 'desc' if sort_by == 'created' and sort_order == 'asc' else 'asc' }}{% for t in type_filter %}&type={{ t }}{% endfor %}&search={{ search }}&view={{ view_mode }}" 
                   style="display: block; padding: 0.5rem; color: #374151; text-decoration: none; border-radius: 0.5rem; font-size: 0.875rem;" 
                   onmouseover="this.style.background='#F3F4F6'" onmouseout="this.style.background='transparent'">
                    Created {{ '‚Üì' if sort_by == 'created' and sort_order == 'desc' else '‚Üë' if sort_by == 'created' else '' }}
                </a>
            </div>
        </div>
        
        <!-- View Toggle -->
        <div class="view-toggle">
            <a href="?view=detailed{% for t in type_filter %}&type={{ t }}{% endfor %}&sort={{ sort_by }}&order={{ sort_order }}&search={{ search }}" 
               class="view-toggle-btn {{ 'active' if view_mode == 'detailed' else '' }}">
                Detailed
            </a>
            <a href="?view=compact{% for t in type_filter %}&type={{ t }}{% endfor %}&sort={{ sort_by }}&order={{ sort_order }}&search={{ search }}" 
               class="view-toggle-btn {{ 'active' if view_mode == 'compact' else '' }}">
                Compact
            </a>
        </div>
    </div>
    
    <div style="display: flex; align-items: center; gap: 1rem;">
        <!-- Search -->
        <form method="get" class="search-box">
            {% for t in type_filter %}<input type="hidden" name="type" value="{{ t }}">{% endfor %}
            <input type="hidden" name="sort" value="{{ sort_by }}">
            <input type="hidden" name="order" value="{{ sort_order }}">
            <input type="hidden" name="view" value="{{ view_mode }}">
            <input type="text" name="search" placeholder="Search clients..." value="{{ search }}">
            <span class="search-icon">üîç</span>
        </form>
        
        <!-- Add Client Button -->
        <a href="{{ url_for('add_client') }}" class="btn-primary">+ Add Client</a>
    </div>
</div>

<!-- Clients List -->
{% if clients %}
    <!-- Column Headers (only for detailed view) -->
    {% if view_mode == 'detailed' %}
    <div class="column-headers">
        <div class="col-status"></div>
        <div class="col-type">Type</div>
        <div class="col-file">File #</div>
        <div class="col-name">Name</div>
        <div class="col-contact">Contact</div>
        <div class="col-dates">Last Session / Created</div>
    </div>
    {% endif %}
    
    <div class="clients-container">
        {% for client in clients %}
        <div class="client-card {{ view_mode }}-view type-{% if client.type.name == 'Active' %}mint{% elif client.type.name == 'Inactive' %}yellow{% else %}pink{% endif %}" 
             onclick="window.location='{{ url_for('client_file', client_id=client.id) }}'">
            {% if view_mode == 'detailed' %}
                <!-- Detailed View: Single horizontal line with EXACT column alignment -->
                <div class="payment-dot {{ client.payment_status }}"></div>
                <span class="type-badge type-{% if client.type.name == 'Active' %}mint{% elif client.type.name == 'Inactive' %}yellow{% else %}pink{% endif %}">
                    {{ client.type.name }}
                </span>
                <span class="file-number">#{{ client.file_number }}</span>
                <span class="client-name">{{ client.last_name }}, {{ client.first_name }}{% if client.middle_name %} {{ client.middle_name }}{% endif %}</span>
                <div class="contact-info">
                    {% if client.email %}
                    <a href="mailto:{{ client.email }}" class="contact-link {{ 'preferred' if client.preferred_contact == 'email' else '' }}" onclick="event.stopPropagation()">
                        üìß {{ client.email }}
                    </a>
                    {% endif %}
                    {% if client.display_phone %}
                    <a href="{% if client.contact_type == 'text' %}sms:{% else %}tel:{% endif %}{{ client.display_phone }}" 
                       class="contact-link {{ 'preferred' if client.preferred_contact in ['call_cell', 'call_home', 'call_work', 'text'] else '' }}" 
                       onclick="event.stopPropagation()">
                        {{ client.contact_icon }} {{ client.display_phone }}
                        {% if client.ok_to_leave_message == 'no' %}‚ö†Ô∏è{% endif %}
                    </a>
                    {% endif %}
                </div>
                <div class="dates">
                    <span style="color: #6B7280; font-size: 0.875rem;">{{ client.last_session|timestamp_to_date if client.last_session else 'Never' }}</span>
                    <span style="color: #9CA3AF;">/</span>
                    <span style="color: #6B7280; font-size: 0.875rem;">{{ client.created_at|timestamp_to_date }}</span>
                </div>
            {% else %}
                <!-- Compact View: Multi-line card -->
                <div class="card-header">
                    <div class="payment-dot {{ client.payment_status }}"></div>
                    <span class="type-badge type-{% if client.type.name == 'Active' %}mint{% elif client.type.name == 'Inactive' %}yellow{% else %}pink{% endif %}">
                        {{ client.type.name }}
                    </span>
                    <span style="color: #6B7280; font-size: 0.875rem;">#{{ client.file_number }}</span>
                </div>
                <div class="client-name">{{ client.last_name }}, {{ client.first_name }}{% if client.middle_name %} {{ client.middle_name }}{% endif %}</div>
                <div class="contact-row">
                    {% if client.email %}
                    <a href="mailto:{{ client.email }}" class="contact-link {{ 'preferred' if client.preferred_contact == 'email' else '' }}" onclick="event.stopPropagation()">
                        üìß {{ client.email }}
                    </a>
                    {% endif %}
                    {% if client.display_phone %}
                    <a href="{% if client.contact_type == 'text' %}sms:{% else %}tel:{% endif %}{{ client.display_phone }}" 
                       class="contact-link {{ 'preferred' if client.preferred_contact in ['call_cell', 'call_home', 'call_work', 'text'] else '' }}" 
                       onclick="event.stopPropagation()">
                        {{ client.contact_icon }} {{ client.display_phone }}
                        {% if client.ok_to_leave_message == 'no' %}‚ö†Ô∏è{% endif %}
                    </a>
                    {% endif %}
                </div>
                <div class="dates-row">
                    <span>Last Session: {{ client.last_session|timestamp_to_date if client.last_session else 'Never' }}</span>
                    <span>‚Ä¢</span>
                    <span>Created: {{ client.created_at|timestamp_to_date }}</span>
                </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
{% else %}
<div style="text-align: center; padding: 4rem; background: white; border-radius: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
    <p style="color: #6B7280; font-size: 1.125rem; margin-bottom: 1.5rem;">No clients found.</p>
    <a href="{{ url_for('add_client') }}" class="btn-primary">+ Add Your First Client</a>
</div>
{% endif %}

<script>
function toggleDropdown(id) {
    const dropdown = document.getElementById(id);
    // Close all other dropdowns
    document.querySelectorAll('[id$="-dropdown"]').forEach(d => {
        if (d.id !== id) d.style.display = 'none';
    });
    dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
}

// Close dropdowns when clicking outside
document.addEventListener('click', function(event) {
    if (!event.target.closest('.dropdown-btn') && !event.target.closest('[id$="-dropdown"]')) {
        document.querySelectorAll('[id$="-dropdown"]').forEach(d => d.style.display = 'none');
    }
});
</script>

{% endblock %}