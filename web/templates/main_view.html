{% extends "base.html" %}

{% block title %}Clients - EdgeCase Equalizer{% endblock %}

{% block extra_css %}
<style>
    /* Override base styles for new design */
    body {
        background: #EDF2F5; /* Solid muted gray background */
        font-size: 19px !important; /* Force bigger font */
    }
    
    /* Ensure all text elements inherit the larger size */
    body * {
        font-size: inherit;
    }
    
    /* Stats cards row - now 6 cards in 2 rows of 3 */
    .stats-container {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .stat-card {
        border-radius: 1rem;
        padding: 1.5rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        transition: transform 0.2s;
        background: #FFFFFF; /* All cards white by default */
    }
    
    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    }
    
    /* Drag and drop styles */
    .stat-card {
        cursor: move;
        cursor: grab;
    }
    
    .stat-card:active {
        cursor: grabbing;
    }
    
    .stat-card.dragging {
        opacity: 0.5;
    }
    
    .stat-card.drag-over {
        border: 2px dashed #00aa88;
    }
    
    .stat-number {
        font-size: 2.5rem;
        font-weight: 700;
        color: #111827;
        margin-bottom: 0.25rem;
    }
    
    .stat-label {
        font-size: 1.125rem; /* Much bigger - 18px */
        color: #5B6571;
        font-weight: 600;
    }
    
    /* Navigation card (4th card) */
    .nav-card {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }
    
    .nav-card h2 {
        font-size: 1.25rem;
        font-weight: 700;
        color: #111827;
        margin-bottom: 0.5rem;
    }
    
    .nav-btn {
        display: block;
        padding: 0.625rem 1rem;
        border-radius: 0.5rem;
        text-align: center;
        text-decoration: none;
        font-size: 0.875rem;
        font-weight: 600;
        transition: all 0.2s;
    }
    
    .nav-btn.teal {
        background: #BFDCDC;
        color: #115D4F;
    }
    
    .nav-btn.teal:hover {
        background: #9FCFC0;
    }
    
    .nav-btn.rose {
        background: #E7CFD4;
        color: #6A243E;
    }
    
    .nav-btn.rose:hover {
        background: #E1B6BF;
    }
    
    /* Controls area */
    .controls-bar {
        background: #E3E9EE; /* Muted blue */
        border-radius: 1rem;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
    }
    
    .controls-left {
        display: flex;
        gap: 1rem;
        align-items: center;
        flex-wrap: wrap;
    }
    
    .search-box {
        position: relative;
    }
    
    .search-box input {
        padding: 0.75rem 2.5rem 0.75rem 1rem;
        border: 2px solid #DEE2E6;
        border-radius: 0.75rem;
        font-size: 0.875rem;
        width: 300px;
        transition: all 0.2s;
    }
    
    .search-box input:focus {
        outline: none;
        border-color: #1F8F74;
        box-shadow: 0 0 0 3px rgba(31,143,116,0.06);
    }
    
    .search-icon {
        position: absolute;
        right: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        color: #9CA3AF;
        font-size: 1.125rem;
    }
    
    /* Dropdown buttons */
    .dropdown-btn {
        padding: 0.75rem 1.25rem;
        background: #FBFCFD;
        border: 2px solid #DEE2E6;
        border-radius: 0.75rem;
        font-size: 0.875rem;
        font-weight: 500;
        color: #323B45;
        cursor: pointer;
        transition: all 0.2s;
        position: relative;
    }
    
    .dropdown-btn:hover {
        border-color: #1F8F74;
        color: #1F8F74;
    }
    
    /* View toggle */
    .view-toggle {
        display: flex;
        background: #F2F4F5;
        border-radius: 0.75rem;
        padding: 0.25rem;
        gap: 0.25rem;
    }
    
    .view-toggle-btn {
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        font-weight: 500;
        color: #5B6571;
        text-decoration: none;
        transition: all 0.2s;
    }
    
    .view-toggle-btn.active {
        background: #FBFCFD;
        color: #1F8F74;
        box-shadow: 0 1px 3px rgba(0,0,0,0.06);
    }
    
    .btn-primary {
        padding: 0.75rem 1.5rem;
        background: #BFDCDC;
        color: #115D4F;
        text-decoration: none;
        border-radius: 0.75rem;
        font-size: 0.875rem;
        font-weight: 600;
        transition: all 0.2s;
        display: inline-block;
    }
    
    .btn-primary:hover {
        background: #9FCFC0;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(191,220,220,0.3);
    }
    
    /* Column headers - CRITICAL: These widths must match client card fields */
    .column-headers {
        position: sticky;
        top: 0;
        background: #DEE2EA; /* Muted lavender */
        border-radius: 1rem;
        padding: 0.875rem 1.25rem;
        margin-bottom: 0.75rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        display: flex;
        align-items: center;
        z-index: 10;
        font-size: 0.6875rem;
        font-weight: 600;
        color: #55607D; /* Muted indigo text */
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    
    .payment-legend {
        display: flex;
        gap: 1.5rem;
        font-size: 0.625rem;
        font-weight: 500;
        color: #6B7AA1;
        text-transform: none;
        letter-spacing: normal;
        margin-right: 2rem;
    }
    
    .payment-legend-item {
        display: flex;
        align-items: center;
        gap: 0.375rem;
    }
    
    .payment-legend-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
    }
    
    /* Column widths - MATCH THESE IN CLIENT CARDS */
    .col-status { 
        width: 12px; 
        flex-shrink: 0; 
        margin-right: 1rem;
    }
    
    .col-type { 
        width: 80px; 
        flex-shrink: 0; 
        margin-right: 1rem;
    }
    
    .col-file { 
        width: 140px; 
        flex-shrink: 0; 
        margin-right: 1rem;
    }
    
    .col-name { 
        width: 250px; 
        flex-shrink: 0; 
        margin-right: 1rem;
    }
    
    .col-contact { 
        flex: 1; 
        min-width: 200px;
        margin-right: 1rem;
    }
    
    .col-dates { 
        width: 220px; 
        flex-shrink: 0; 
        text-align: right;
    }
    
    /* Client cards */
    .clients-container {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }
    
    .client-card {
        border-radius: 1rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        transition: all 0.2s;
        cursor: pointer;
    }
    
    .client-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    }
    
    /* Pastel backgrounds based on type - muted palette */
    .client-card.type-mint { background: #CFE7DA; }    /* Muted mint */
    .client-card.type-yellow { background: #FAF0DF; }  /* Muted cream */
    .client-card.type-pink { background: #F0DBE3; }    /* Muted rose */
    .client-card.type-purple { background: #DCD7E9; }  /* Muted lavender */
    
    /* Detailed view - single line with EXACT column alignment */
    .client-card.detailed-view {
        display: flex;
        align-items: center;
        padding: 0.875rem 1.25rem;
    }
    
    /* Match column widths EXACTLY */
    .client-card.detailed-view .payment-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        flex-shrink: 0;
        margin-right: 1rem;
    }
    
    .client-card.detailed-view .type-badge {
        width: 80px;
        flex-shrink: 0;
        margin-right: 1rem;
        padding: 0.25rem 0.5rem;
        border-radius: 0.375rem;
        font-size: 0.75rem;
        font-weight: 600;
        text-align: center;
    }
    
    .client-card.detailed-view .file-number {
        width: 140px;
        flex-shrink: 0;
        margin-right: 1rem;
        color: #6B7280;
        font-size: 0.875rem;
    }
    
    .client-card.detailed-view .client-name {
        width: 250px;
        flex-shrink: 0;
        margin-right: 1rem;
        font-weight: 600;
        color: #111827;
        font-size: 0.9375rem;
    }
    
    .client-card.detailed-view .contact-info {
        flex: 1;
        min-width: 200px;
        margin-right: 1rem;
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
    }
    
    .client-card.detailed-view .dates {
        width: 220px;
        flex-shrink: 0;
        display: flex;
        gap: 0.5rem;
        justify-content: flex-end;
        align-items: center;
    }
    
    /* Payment status dots */
    .payment-dot.paid { background: #17976C; }
    .payment-dot.pending { background: #D68A09; }
    .payment-dot.overdue { background: #C93A3A; }
    
    /* Type badges with specific colors - muted palette */
    .type-badge.type-mint { background: #AFCFBF; color: #0E5346; }
    .type-badge.type-yellow { background: #F5DEB0; color: #5A4823; }
    .type-badge.type-pink { background: #E8C7D6; color: #642639; }
    .type-badge.type-purple { background: #C9BFE8; color: #3F3358; }
    
    /* Contact links */
    .contact-link {
        color: #5B6571;
        text-decoration: none;
        font-size: 0.875rem;
        transition: color 0.2s;
    }
    
    .contact-link:hover {
        color: #1F8F74;
    }
    
    .contact-link.preferred {
        color: #323B45;
    }
    
    /* Underline only the text part, not the icon */
    .contact-link.preferred span {
        text-decoration: underline;
    }
    
    /* Compact view - multi-line card */
    .client-card.compact-view {
        padding: 1rem 1.25rem;
    }
    
    .card-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 0.5rem;
    }
    
    .card-header .payment-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
    }
    
    .card-header .type-badge {
        padding: 0.25rem 0.5rem;
        border-radius: 0.375rem;
        font-size: 0.75rem;
        font-weight: 600;
    }
    
    .compact-view .client-name {
        font-size: 1.125rem;
        font-weight: 600;
        color: #111827;
        margin-bottom: 0.5rem;
    }
    
    .contact-row {
        display: flex;
        gap: 1rem;
        margin-bottom: 0.5rem;
        flex-wrap: wrap;
    }
    
    .dates-row {
        display: flex;
        gap: 0.5rem;
        font-size: 0.875rem;
        color: #5B6571;
    }
    
    /* Legend card at bottom */
    .legend-card {
        background: #DEE2EA; /* Same as column headers */
        border-radius: 1rem;
        padding: 1rem 1.5rem;
        margin-top: 2rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 2rem;
        position: sticky;
        bottom: 0;
        z-index: 10;
    }
    
    .legend-section {
        display: flex;
        gap: 2rem;
        align-items: center;
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.6875rem;
        color: #55607D;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    
    .legend-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        flex-shrink: 0;
    }
</style>
{% endblock %}

{% block content %}

<!-- Stats Cards - Now 6 cards in 2 rows of 3 -->
<div class="stats-container" id="stats-container">
    <div class="stat-card blue" draggable="true" data-card-id="active-clients">
        <div class="stat-number">{{ active_count }}</div>
        <div class="stat-label">Active Clients</div>
    </div>
    <div class="stat-card purple" draggable="true" data-card-id="sessions-week">
        <div class="stat-number">{{ sessions_this_week }}</div>
        <div class="stat-label">Sessions This Week</div>
    </div>
    <div class="stat-card coral" draggable="true" data-card-id="pending-invoices">
        <div class="stat-number">{{ pending_invoices }}</div>
        <div class="stat-label">Pending Invoices</div>
    </div>
    <div class="stat-card mint" draggable="true" data-card-id="billable-month">
        <div class="stat-number">${{ billable_this_month|default(0)|round(2) }}</div>
        <div class="stat-label">Billable This Month</div>
    </div>
    <div class="stat-card peach" draggable="true" data-card-id="current-time">
        <div class="stat-number" id="current-time">{{ current_time }}</div>
        <div class="stat-label" id="current-date">{{ current_date }}</div>
    </div>
    <div class="stat-card lavender nav-card" draggable="true" data-card-id="navigation">
        <a href="{{ url_for('settings_page') }}" class="nav-btn rose">Settings</a>
        <a href="{{ url_for('manage_types') }}" class="nav-btn teal">Edit Client Types</a>
    </div>
</div>

<!-- Controls Bar -->
<div class="controls-bar">
    <div class="controls-left">
        <!-- Filter Dropdown -->
        <div style="position: relative;">
            <button class="dropdown-btn" onclick="toggleDropdown('filter-dropdown')">
                Filter: {{ type_filter|length }} type{{ 's' if type_filter|length != 1 else '' }} ‚ñæ
            </button>
            <div id="filter-dropdown" style="display: none; position: absolute; top: 100%; left: 0; margin-top: 0.5rem; background: white; border-radius: 0.75rem; box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 1rem; min-width: 200px; z-index: 100;">
                <form id="filter-form" method="get">
                    <input type="hidden" name="sort" value="{{ sort_by }}">
                    <input type="hidden" name="order" value="{{ sort_order }}">
                    <input type="hidden" name="search" value="{{ search }}">
                    <input type="hidden" name="view" value="{{ view_mode }}">
                    {% for client_type in all_types %}
                    <label style="display: block; padding: 0.5rem; cursor: pointer; border-radius: 0.5rem;" 
                           onmouseover="this.style.background='#F3F4F6'" 
                           onmouseout="this.style.background='transparent'">
                        <input type="checkbox" name="type" value="{{ client_type.id }}" 
                               {% if client_type.id|string in type_filter %}checked{% endif %}
                               onchange="document.getElementById('filter-form').submit()">
                        <span style="margin-left: 0.5rem; font-size: 0.875rem;">{{ client_type.name }}</span>
                    </label>
                    {% endfor %}
                </form>
            </div>
        </div>
        
        <!-- Sort Dropdown -->
        <div style="position: relative;">
            <button class="dropdown-btn" onclick="toggleDropdown('sort-dropdown')">
                Sort: {{ sort_by|replace('_', ' ')|title }} ‚ñæ
            </button>
            <div id="sort-dropdown" style="display: none; position: absolute; top: 100%; left: 0; margin-top: 0.5rem; background: white; border-radius: 0.75rem; box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 1rem; min-width: 200px; z-index: 100;">
                <a href="?sort=last_name&order={{ 'desc' if sort_by == 'last_name' and sort_order == 'asc' else 'asc' }}{% for t in type_filter %}&type={{ t }}{% endfor %}&search={{ search }}&view={{ view_mode }}" 
                   style="display: block; padding: 0.5rem; color: #374151; text-decoration: none; border-radius: 0.5rem; font-size: 0.875rem;" 
                   onmouseover="this.style.background='#F3F4F6'" onmouseout="this.style.background='transparent'">
                    Last Name {{ '‚Üì' if sort_by == 'last_name' and sort_order == 'desc' else '‚Üë' if sort_by == 'last_name' else '' }}
                </a>
                <a href="?sort=first_name&order={{ 'desc' if sort_by == 'first_name' and sort_order == 'asc' else 'asc' }}{% for t in type_filter %}&type={{ t }}{% endfor %}&search={{ search }}&view={{ view_mode }}" 
                   style="display: block; padding: 0.5rem; color: #374151; text-decoration: none; border-radius: 0.5rem; font-size: 0.875rem;" 
                   onmouseover="this.style.background='#F3F4F6'" onmouseout="this.style.background='transparent'">
                    First Name {{ '‚Üì' if sort_by == 'first_name' and sort_order == 'desc' else '‚Üë' if sort_by == 'first_name' else '' }}
                </a>
                <a href="?sort=file_number&order={{ 'desc' if sort_by == 'file_number' and sort_order == 'asc' else 'asc' }}{% for t in type_filter %}&type={{ t }}{% endfor %}&search={{ search }}&view={{ view_mode }}" 
                   style="display: block; padding: 0.5rem; color: #374151; text-decoration: none; border-radius: 0.5rem; font-size: 0.875rem;" 
                   onmouseover="this.style.background='#F3F4F6'" onmouseout="this.style.background='transparent'">
                    File Number {{ '‚Üì' if sort_by == 'file_number' and sort_order == 'desc' else '‚Üë' if sort_by == 'file_number' else '' }}
                </a>
                <a href="?sort=last_session&order={{ 'desc' if sort_by == 'last_session' and sort_order == 'asc' else 'asc' }}{% for t in type_filter %}&type={{ t }}{% endfor %}&search={{ search }}&view={{ view_mode }}" 
                   style="display: block; padding: 0.5rem; color: #374151; text-decoration: none; border-radius: 0.5rem; font-size: 0.875rem;" 
                   onmouseover="this.style.background='#F3F4F6'" onmouseout="this.style.background='transparent'">
                    Last Session {{ '‚Üì' if sort_by == 'last_session' and sort_order == 'desc' else '‚Üë' if sort_by == 'last_session' else '' }}
                </a>
                <a href="?sort=created&order={{ 'desc' if sort_by == 'created' and sort_order == 'asc' else 'asc' }}{% for t in type_filter %}&type={{ t }}{% endfor %}&search={{ search }}&view={{ view_mode }}" 
                   style="display: block; padding: 0.5rem; color: #374151; text-decoration: none; border-radius: 0.5rem; font-size: 0.875rem;" 
                   onmouseover="this.style.background='#F3F4F6'" onmouseout="this.style.background='transparent'">
                    Created {{ '‚Üì' if sort_by == 'created' and sort_order == 'desc' else '‚Üë' if sort_by == 'created' else '' }}
                </a>
            </div>
        </div>
        
        <!-- View Toggle -->
        <div class="view-toggle">
            <a href="?view=detailed{% for t in type_filter %}&type={{ t }}{% endfor %}&sort={{ sort_by }}&order={{ sort_order }}&search={{ search }}" 
               class="view-toggle-btn {{ 'active' if view_mode == 'detailed' else '' }}">
                Detailed
            </a>
            <a href="?view=compact{% for t in type_filter %}&type={{ t }}{% endfor %}&sort={{ sort_by }}&order={{ sort_order }}&search={{ search }}" 
               class="view-toggle-btn {{ 'active' if view_mode == 'compact' else '' }}">
                Compact
            </a>
        </div>
    </div>
    
    <div style="display: flex; align-items: center; gap: 1rem;">
        <!-- Search -->
        <form method="get" class="search-box">
            {% for t in type_filter %}<input type="hidden" name="type" value="{{ t }}">{% endfor %}
            <input type="hidden" name="sort" value="{{ sort_by }}">
            <input type="hidden" name="order" value="{{ sort_order }}">
            <input type="hidden" name="view" value="{{ view_mode }}">
            <input type="text" name="search" placeholder="Search clients..." value="{{ search }}">
            <span class="search-icon">üîç</span>
        </form>
        
        <!-- Add Client Button -->
        <a href="{{ url_for('add_client') }}" class="btn-primary">+ Add Client</a>
    </div>
</div>

<!-- Clients List -->
{% if clients %}
    <!-- Column Headers (only for detailed view) -->
    {% if view_mode == 'detailed' %}
    <div class="column-headers">
        <div class="col-status">Status/Type</div>
        <div class="col-type"></div>
        <div class="col-file">File #</div>
        <div class="col-name">Name</div>
        <div class="col-contact">Contact</div>
        <div class="col-dates">Last Session / Created</div>
    </div>
    {% endif %}
    
    <div class="clients-container">
        {% for client in clients %}
        <div class="client-card {{ view_mode }}-view type-{% if client.type.name == 'Active' %}mint{% elif client.type.name == 'Inactive' %}yellow{% else %}pink{% endif %}" 
             onclick="window.location='{{ url_for('client_file', client_id=client.id) }}'">
            {% if view_mode == 'detailed' %}
                <!-- Detailed View: Single horizontal line with EXACT column alignment -->
                <div class="payment-dot {{ client.payment_status }}"></div>
                <span class="type-badge type-{% if client.type.name == 'Active' %}mint{% elif client.type.name == 'Inactive' %}yellow{% else %}pink{% endif %}">
                    {{ client.type.name }}
                </span>
                <span class="file-number">{{ client.file_number }}</span>
                <span class="client-name">{{ client.last_name }}, {{ client.first_name }}{% if client.middle_name %} {{ client.middle_name }}{% endif %}</span>
                <div class="contact-info">
                    {% if client.email %}
                    <a href="mailto:{{ client.email }}" class="contact-link {{ 'preferred' if client.preferred_contact == 'email' else '' }}" onclick="event.stopPropagation()">
                        üìß <span>{{ client.email }}</span>
                    </a>
                    {% endif %}
                    {% if client.display_phone %}
                    <a href="{% if client.contact_type == 'text' %}sms:{% else %}tel:{% endif %}{{ client.display_phone }}" 
                       class="contact-link {{ 'preferred' if client.preferred_contact in ['call_cell', 'call_home', 'call_work', 'text'] else '' }}" 
                       onclick="event.stopPropagation()">
                        {{ client.contact_icon }} <span>{{ client.display_phone }}{% if client.ok_to_leave_message == 'no' %} ‚ö†Ô∏è{% endif %}</span>
                    </a>
                    {% endif %}
                </div>
                <div class="dates">
                    <span style="color: #6B7280; font-size: 0.875rem;">{{ client.last_session|timestamp_to_date if client.last_session else 'Never' }}</span>
                    <span style="color: #9CA3AF;">/</span>
                    <span style="color: #6B7280; font-size: 0.875rem;">{{ client.created_at|timestamp_to_date }}</span>
                </div>
            {% else %}
                <!-- Compact View: Multi-line card -->
                <div class="card-header">
                    <div class="payment-dot {{ client.payment_status }}"></div>
                    <span class="type-badge type-{% if client.type.name == 'Active' %}mint{% elif client.type.name == 'Inactive' %}yellow{% else %}pink{% endif %}">
                        {{ client.type.name }}
                    </span>
                    <span style="color: #6B7280; font-size: 0.875rem;">{{ client.file_number }}</span>
                </div>
                <div class="client-name">{{ client.last_name }}, {{ client.first_name }}{% if client.middle_name %} {{ client.middle_name }}{% endif %}</div>
                <div class="contact-row">
                    {% if client.email %}
                    <a href="mailto:{{ client.email }}" class="contact-link {{ 'preferred' if client.preferred_contact == 'email' else '' }}" onclick="event.stopPropagation()">
                        üìß <span>{{ client.email }}</span>
                    </a>
                    {% endif %}
                    {% if client.display_phone %}
                    <a href="{% if client.contact_type == 'text' %}sms:{% else %}tel:{% endif %}{{ client.display_phone }}" 
                       class="contact-link {{ 'preferred' if client.preferred_contact in ['call_cell', 'call_home', 'call_work', 'text'] else '' }}" 
                       onclick="event.stopPropagation()">
                        {{ client.contact_icon }} <span>{{ client.display_phone }}{% if client.ok_to_leave_message == 'no' %} ‚ö†Ô∏è{% endif %}</span>
                    </a>
                    {% endif %}
                </div>
                <div class="dates-row">
                    <span>Last Session: {{ client.last_session|timestamp_to_date if client.last_session else 'Never' }}</span>
                    <span>‚Ä¢</span>
                    <span>Created: {{ client.created_at|timestamp_to_date }}</span>
                </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    
    <!-- Legend Card -->
    <div class="legend-card">
        <div class="legend-section">
            <div class="legend-item">
                <div class="legend-dot" style="background: #17976C;"></div>
                <span>Paid / Up to date</span>
            </div>
            <div class="legend-item">
                <div class="legend-dot" style="background: #D68A09;"></div>
                <span>Payment pending</span>
            </div>
            <div class="legend-item">
                <div class="legend-dot" style="background: #C93A3A;"></div>
                <span>Overdue (30+ days)</span>
            </div>
        </div>
        <div class="legend-section">
            <div class="legend-item">
                <span><u>Underlined</u> = Preferred contact</span>
            </div>
            <div class="legend-item">
                <span>‚ö†Ô∏è = Do not leave message</span>
            </div>
        </div>
    </div>
{% else %}
<div style="text-align: center; padding: 4rem; background: white; border-radius: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
    <p style="color: #6B7280; font-size: 1.125rem; margin-bottom: 1.5rem;">No clients found.</p>
    <a href="{{ url_for('add_client') }}" class="btn-primary">+ Add Your First Client</a>
</div>
{% endif %}


<script>
function toggleDropdown(id) {
    const dropdown = document.getElementById(id);
    // Close all other dropdowns
    document.querySelectorAll('[id$="-dropdown"]').forEach(d => {
        if (d.id !== id) d.style.display = 'none';
    });
    dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
}

// Close dropdowns when clicking outside
document.addEventListener('click', function(event) {
    if (!event.target.closest('.dropdown-btn') && !event.target.closest('[id$="-dropdown"]')) {
        document.querySelectorAll('[id$="-dropdown"]').forEach(d => d.style.display = 'none');
    }
});

// Live clock update - synchronized with system clock
function updateClock() {
    const now = new Date();
    
    // Format time: "12:45 PM"
    let hours = now.getHours();
    const minutes = now.getMinutes();
    const ampm = hours >= 12 ? 'PM' : 'AM';
    hours = hours % 12;
    hours = hours ? hours : 12; // 0 should be 12
    const minutesStr = minutes < 10 ? '0' + minutes : minutes;
    const timeStr = `${hours}:${minutesStr} ${ampm}`;
    
    // Format date: "November 9, 2025"
    const months = ['January', 'February', 'March', 'April', 'May', 'June',
                   'July', 'August', 'September', 'October', 'November', 'December'];
    const dateStr = `${months[now.getMonth()]} ${now.getDate()}, ${now.getFullYear()}`;
    
    // Update DOM
    const timeEl = document.getElementById('current-time');
    const dateEl = document.getElementById('current-date');
    if (timeEl) timeEl.textContent = timeStr;
    if (dateEl) dateEl.textContent = dateStr;
}

// Update immediately on page load
updateClock();

// Synchronize with system clock - update at the start of each second
function syncClock() {
    const now = new Date();
    const msUntilNextSecond = 1000 - now.getMilliseconds();
    
    setTimeout(function() {
        updateClock();
        // After first sync, update every second
        setInterval(updateClock, 1000);
    }, msUntilNextSecond);
}

syncClock();

// ===== DRAG AND DROP FUNCTIONALITY =====

let draggedCard = null;

// Get all draggable cards
const cards = document.querySelectorAll('.stat-card[draggable="true"]');

// Load saved order from localStorage
function loadCardOrder() {
    const savedOrder = localStorage.getItem('cardOrder');
    if (savedOrder) {
        const orderArray = JSON.parse(savedOrder);
        const container = document.getElementById('stats-container');
        
        // Reorder cards based on saved order
        orderArray.forEach(cardId => {
            const card = container.querySelector(`[data-card-id="${cardId}"]`);
            if (card) {
                container.appendChild(card);
            }
        });
    }
}

// Save card order to localStorage
function saveCardOrder() {
    const container = document.getElementById('stats-container');
    const cards = container.querySelectorAll('.stat-card[data-card-id]');
    const order = Array.from(cards).map(card => card.dataset.cardId);
    localStorage.setItem('cardOrder', JSON.stringify(order));
}

// Drag event handlers
cards.forEach(card => {
    card.addEventListener('dragstart', function(e) {
        draggedCard = this;
        this.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html', this.innerHTML);
    });
    
    card.addEventListener('dragend', function(e) {
        this.classList.remove('dragging');
        // Remove drag-over class from all cards
        cards.forEach(c => c.classList.remove('drag-over'));
        // Save the new order
        saveCardOrder();
    });
    
    card.addEventListener('dragover', function(e) {
        if (e.preventDefault) {
            e.preventDefault();
        }
        e.dataTransfer.dropEffect = 'move';
        
        // Add visual feedback
        if (this !== draggedCard) {
            this.classList.add('drag-over');
        }
        
        return false;
    });
    
    card.addEventListener('dragleave', function(e) {
        this.classList.remove('drag-over');
    });
    
    card.addEventListener('drop', function(e) {
        if (e.stopPropagation) {
            e.stopPropagation();
        }
        
        // Don't drop on itself
        if (draggedCard !== this) {
            // Swap the cards
            const container = document.getElementById('stats-container');
            const allCards = Array.from(container.querySelectorAll('.stat-card'));
            const draggedIndex = allCards.indexOf(draggedCard);
            const targetIndex = allCards.indexOf(this);
            
            if (draggedIndex < targetIndex) {
                this.parentNode.insertBefore(draggedCard, this.nextSibling);
            } else {
                this.parentNode.insertBefore(draggedCard, this);
            }
        }
        
        this.classList.remove('drag-over');
        return false;
    });
});

// Load saved order on page load
loadCardOrder();
</script>

{% endblock %}