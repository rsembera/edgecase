{% extends "base.html" %}

{% block title %}Clients - EdgeCase Equalizer{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/main_view.css') }}">
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/main_view.js') }}"></script>
{% endblock %}

{% block content %}

<!-- Stats Cards - Now 6 cards in 2 rows of 3 -->
<div class="stats-container" id="stats-container">
    <div class="stat-card blue" draggable="true" data-card-id="active-clients">
        <div class="stat-number">{{ active_count }}</div>
        <div class="stat-label">Active Clients</div>
    </div>
    <div class="stat-card purple" draggable="true" data-card-id="sessions-week">
        <div class="stat-number">{{ sessions_this_week }}</div>
        <div class="stat-label">Sessions This Week</div>
    </div>
    <div class="stat-card coral" draggable="true" data-card-id="pending-invoices">
        <div class="stat-number">{{ pending_invoices }}</div>
        <div class="stat-label">Pending Invoices</div>
    </div>
    <div class="stat-card mint" draggable="true" data-card-id="billable-month">
        <div class="stat-number">${{ "%.2f"|format(billable_this_month|default(0)) }}</div>
        <div class="stat-label">Billable This Month</div>
    </div>
    <div class="stat-card peach" draggable="true" data-card-id="current-time">
        <div class="stat-number" id="current-time">{{ current_time }}</div>
        <div class="stat-label" id="current-date">{{ current_date }}</div>
    </div>
    <div class="stat-card lavender nav-card" draggable="true" data-card-id="navigation">
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
        <a href="{{ url_for('settings.settings_page') }}" class="nav-btn peach">
            <i data-lucide="sliders-horizontal" style="width: 16px; height: 16px; vertical-align: -2px; margin-right: 0.35rem;"></i>Settings
        </a>
        <a href="#" class="nav-btn sage" onclick="alert('Backup coming in Phase 2!'); return false;">
            <i data-lucide="hard-drive-download" style="width: 16px; height: 16px; vertical-align: -2px; margin-right: 0.35rem;"></i>Backup
        </a>
        <a href="{{ url_for('ledger.ledger') }}" class="nav-btn teal">
            <i data-lucide="wallet" style="width: 16px; height: 16px; vertical-align: -2px; margin-right: 0.35rem;"></i>Ledger
        </a>
        <a href="{{ url_for('statements.outstanding_statements') }}" class="nav-btn purple">
            <i data-lucide="file-text" style="width: 16px; height: 16px; vertical-align: -2px; margin-right: 0.35rem;"></i>Statements
        </a>
    </div>
</div>
</div>

<!-- Controls Bar -->
<div class="controls-bar">
    <div class="controls-left">
        <!-- Filter Dropdown -->
        <div style="position: relative;">
            <button class="dropdown-btn" id="filter-button">
                Filter: {{ type_filter|length }} type{{ 's' if type_filter|length != 1 else '' }} ▾
            </button>
            <div id="filter-dropdown" style="display: none; position: absolute; top: 100%; left: 0; margin-top: 0.5rem; background: white; border-radius: 0.75rem; box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 1rem; min-width: 200px; z-index: 100;">
                <div id="filter-form">
                    <input type="hidden" name="sort" value="{{ sort_by }}">
                    <input type="hidden" name="order" value="{{ sort_order }}">
                    <input type="hidden" name="search" value="{{ search }}">
                    <input type="hidden" name="view" value="{{ view_mode }}">
                    {% for client_type in all_types %}
                    <label style="display: block; padding: 0.5rem; cursor: pointer; border-radius: 0.5rem;" 
                           onmouseover="this.style.background='#F3F4F6'" 
                           onmouseout="this.style.background='transparent'">
                        <input type="checkbox" name="type" value="{{ client_type.id }}" 
                               {% if client_type.id|string in type_filter %}checked{% endif %}>
                        <span style="margin-left: 0.5rem; font-size: 0.875rem;">{{ client_type.name }}</span>
                    </label>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <!-- Sort Dropdown -->
        <div style="position: relative;">
            <button class="dropdown-btn" onclick="toggleDropdown('sort-dropdown')">
                Sort: {{ sort_by|replace('_', ' ')|title }} ▾
            </button>
            <div id="sort-dropdown" style="display: none; position: absolute; top: 100%; left: 0; margin-top: 0.5rem; background: white; border-radius: 0.75rem; box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 1rem; min-width: 200px; z-index: 100;">
                <a href="?sort=last_name&order={{ 'desc' if sort_by == 'last_name' and sort_order == 'asc' else 'asc' }}{% for t in type_filter %}&type={{ t }}{% endfor %}&search={{ search }}&view={{ view_mode }}" 
                   style="display: block; padding: 0.5rem; color: #374151; text-decoration: none; border-radius: 0.5rem; font-size: 0.875rem;" 
                   onmouseover="this.style.background='#F3F4F6'" onmouseout="this.style.background='transparent'">
                    Last Name {{ '↓' if sort_by == 'last_name' and sort_order == 'desc' else '↑' if sort_by == 'last_name' else '' }}
                </a>
                <a href="?sort=first_name&order={{ 'desc' if sort_by == 'first_name' and sort_order == 'asc' else 'asc' }}{% for t in type_filter %}&type={{ t }}{% endfor %}&search={{ search }}&view={{ view_mode }}" 
                   style="display: block; padding: 0.5rem; color: #374151; text-decoration: none; border-radius: 0.5rem; font-size: 0.875rem;" 
                   onmouseover="this.style.background='#F3F4F6'" onmouseout="this.style.background='transparent'">
                    First Name {{ '↓' if sort_by == 'first_name' and sort_order == 'desc' else '↑' if sort_by == 'first_name' else '' }}
                </a>
                <a href="?sort=file_number&order={{ 'desc' if sort_by == 'file_number' and sort_order == 'asc' else 'asc' }}{% for t in type_filter %}&type={{ t }}{% endfor %}&search={{ search }}&view={{ view_mode }}" 
                   style="display: block; padding: 0.5rem; color: #374151; text-decoration: none; border-radius: 0.5rem; font-size: 0.875rem;" 
                   onmouseover="this.style.background='#F3F4F6'" onmouseout="this.style.background='transparent'">
                    File Number {{ '↓' if sort_by == 'file_number' and sort_order == 'desc' else '↑' if sort_by == 'file_number' else '' }}
                </a>
                <a href="?sort=last_session&order={{ 'desc' if sort_by == 'last_session' and sort_order == 'asc' else 'asc' }}{% for t in type_filter %}&type={{ t }}{% endfor %}&search={{ search }}&view={{ view_mode }}" 
                   style="display: block; padding: 0.5rem; color: #374151; text-decoration: none; border-radius: 0.5rem; font-size: 0.875rem;" 
                   onmouseover="this.style.background='#F3F4F6'" onmouseout="this.style.background='transparent'">
                    Last Session {{ '↓' if sort_by == 'last_session' and sort_order == 'desc' else '↑' if sort_by == 'last_session' else '' }}
                </a>
                <a href="?sort=created&order={{ 'desc' if sort_by == 'created' and sort_order == 'asc' else 'asc' }}{% for t in type_filter %}&type={{ t }}{% endfor %}&search={{ search }}&view={{ view_mode }}" 
                   style="display: block; padding: 0.5rem; color: #374151; text-decoration: none; border-radius: 0.5rem; font-size: 0.875rem;" 
                   onmouseover="this.style.background='#F3F4F6'" onmouseout="this.style.background='transparent'">
                    Created {{ '↓' if sort_by == 'created' and sort_order == 'desc' else '↑' if sort_by == 'created' else '' }}
                </a>
            </div>
        </div>

        <!-- Search -->
        <form method="get" class="search-box">
            {% for t in type_filter %}<input type="hidden" name="type" value="{{ t }}">{% endfor %}
            <input type="hidden" name="sort" value="{{ sort_by }}">
            <input type="hidden" name="order" value="{{ sort_order }}">
            <input type="hidden" name="view" value="{{ view_mode }}">
            <span class="search-icon"><i data-lucide="search"></i></span>
            <input type="text" name="search" placeholder="Search clients..." value="{{ search }}">
            <button type="button" class="clear-search" style="display: none;"><i data-lucide="x"></i></button>
        </form>
        
        <!-- View Toggle -->
        <div class="view-toggle">
            <a href="?view=detailed{% for t in type_filter %}&type={{ t }}{% endfor %}&sort={{ sort_by }}&order={{ sort_order }}&search={{ search }}" 
               class="view-toggle-btn {{ 'active' if view_mode == 'detailed' else '' }}">
                Detailed
            </a>
            <a href="?view=compact{% for t in type_filter %}&type={{ t }}{% endfor %}&sort={{ sort_by }}&order={{ sort_order }}&search={{ search }}" 
               class="view-toggle-btn {{ 'active' if view_mode == 'compact' else '' }}">
                Compact
            </a>
        </div>
    </div>
    
    <div style="display: flex; align-items: center; gap: 1rem;">
        
        <!-- Manage Dropdown -->
        <div style="position: relative;">
            <button class="dropdown-btn" onclick="toggleDropdown('manage-dropdown')">
                <i data-lucide="settings"></i> Manage ▾
            </button>
            <div id="manage-dropdown" style="display: none; position: absolute; top: 100%; right: 0; margin-top: 0.5rem; background: white; border-radius: 0.75rem; box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 0.5rem; min-width: 160px; z-index: 100;">
                <a href="{{ url_for('clients.add_client') }}" 
                style="display: block; padding: 0.75rem 1rem; text-decoration: none; color: #2d3748; border-radius: 0.5rem; font-size: 0.9375rem;"
                onmouseover="this.style.background='#F3F4F6'" 
                onmouseout="this.style.background='transparent'">
                    <i data-lucide="plus" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 0.5rem;"></i>Add Client
                </a>
                <a href="{{ url_for('types.manage_types') }}" 
                   style="display: block; padding: 0.75rem 1rem; text-decoration: none; color: #2d3748; border-radius: 0.5rem; font-size: 0.9375rem;"
                   onmouseover="this.style.background='#F3F4F6'" 
                   onmouseout="this.style.background='transparent'">
                    <i data-lucide="tag" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 0.5rem;"></i>Edit Types
                </a>
                <a href="{{ url_for('links.manage_links') }}" 
                   style="display: block; padding: 0.75rem 1rem; text-decoration: none; color: #2d3748; border-radius: 0.5rem; font-size: 0.9375rem;"
                   onmouseover="this.style.background='#F3F4F6'" 
                   onmouseout="this.style.background='transparent'">
                    <i data-lucide="link" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 0.5rem;"></i>Edit Links
                </a>

                <hr style="margin: 0.5rem 0; border: none; border-top: 1px solid #E2E8F0;">

                <a href="{{ url_for('clients.deleted_clients') }}" 
                style="display: block; padding: 0.75rem 1rem; text-decoration: none; color: #2d3748; border-radius: 0.5rem; font-size: 0.9375rem;"
                onmouseover="this.style.background='#F3F4F6'" 
                onmouseout="this.style.background='transparent'">
                    <i data-lucide="archive" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 0.5rem;"></i>Deleted
                </a>

            </div>
        </div>
    </div>
</div>

<!-- Clients List -->
{% if clients %}
    <!-- Column Headers (only for detailed view) -->
    {% if view_mode == 'detailed' %}
    <div class="column-headers">
        <div class="col-status">Status/Type</div>
        <div class="col-type"></div>
        <div class="col-file">File #</div>
        <div class="col-name">Name</div>
        <div class="col-contact">Contact</div>
        <div class="col-dates">Last Session / Created</div>
    </div>
    {% endif %}
    
    <div class="clients-container">
        {% for client in clients %}
        <div class="client-card {{ view_mode }}-view" 
            style="background-color: {{ client.type.bubble_color or '#FBFCFD' }}"
            data-type-id="{{ client.type_id }}"
            onclick="window.location='{{ url_for('clients.client_file', client_id=client.id) }}'">
            {% if view_mode == 'detailed' %}
                <!-- Detailed View: Single horizontal line with EXACT column alignment -->
                <div class="payment-dot {{ client.payment_status }}"></div>
                <span class="type-badge" style="background-color: {{ client.type.color }}">
                    {{ client.type.name }}
                </span>
                <span class="file-number">{{ client.file_number }}</span>
                {% if client.is_linked %}<span class="link-icon" title="Linked to other clients"><i data-lucide="link" style="width: 14px; height: 14px;"></i></span>{% endif %}
                <span class="client-name">{{ client.last_name }}, {{ client.first_name }}{% if client.middle_name %} {{ client.middle_name }}{% endif %}</span>
                <div class="contact-info">
                    {% if client.email %}
                    <a href="mailto:{{ client.email }}" class="contact-link {{ 'preferred' if client.preferred_contact == 'email' else '' }}" onclick="event.stopPropagation()">
                        <i data-lucide="mail" style="width: 14px; height: 14px; vertical-align: middle;"></i> <span>{{ client.email }}</span>
                    </a>
                    {% endif %}
                    {% if client.display_phone %}
                    <a href="{% if client.contact_type == 'text' %}sms:{% else %}tel:{% endif %}{{ client.display_phone }}" 
                       class="contact-link {{ 'preferred' if client.preferred_contact in ['call_cell', 'call_home', 'call_work', 'text'] else '' }}" 
                       onclick="event.stopPropagation()">
                        {{ client.contact_icon|safe }} <span>{{ client.display_phone }}</span>{% if client.ok_to_leave_message == 'no' %} <i data-lucide="alert-triangle" style="width: 14px; height: 14px; vertical-align: middle; color: #D97706;"></i>{% endif %}
                    </a>
                    {% endif %}
                </div>
                <div class="dates">
                    <span style="color: #6B7280; font-size: 0.875rem;">{{ client.last_session|timestamp_to_date if client.last_session else 'Never' }}</span>
                    <span style="color: #9CA3AF;">/</span>
                    <span style="color: #6B7280; font-size: 0.875rem;">{{ client.created_at|timestamp_to_date }}</span>
                </div>
            {% else %}
                <!-- Compact View: Multi-line card -->
                <div class="card-header">
                    <div class="payment-dot {{ client.payment_status }}"></div>
                    <span class="type-badge" style="background-color: {{ client.type.color }}">
                        {{ client.type.name }}
                    </span>
                    <span style="color: #6B7280; font-size: 0.875rem;">{{ client.file_number }}</span>
                    {% if client.is_linked %}<span class="link-icon" title="Linked to other clients"><i data-lucide="link" style="width: 14px; height: 14px;"></i></span>{% endif %}
                </div>
                <div class="client-name">{{ client.last_name }}, {{ client.first_name }}{% if client.middle_name %} {{ client.middle_name }}{% endif %}</div>
                <div class="contact-row">
                    {% if client.email %}
                    <a href="mailto:{{ client.email }}" class="contact-link {{ 'preferred' if client.preferred_contact == 'email' else '' }}" onclick="event.stopPropagation()">
                        <i data-lucide="mail" style="width: 14px; height: 14px; vertical-align: middle;"></i> <span>{{ client.email }}</span>
                    </a>
                    {% endif %}
                    {% if client.display_phone %}
                    <a href="{% if client.contact_type == 'text' %}sms:{% else %}tel:{% endif %}{{ client.display_phone }}" 
                       class="contact-link {{ 'preferred' if client.preferred_contact in ['call_cell', 'call_home', 'call_work', 'text'] else '' }}" 
                       onclick="event.stopPropagation()">
                        {{ client.contact_icon|safe }} <span>{{ client.display_phone }}</span>{% if client.ok_to_leave_message == 'no' %} <i data-lucide="alert-triangle" style="width: 14px; height: 14px; vertical-align: middle; color: #D97706;"></i>{% endif %}
                    </a>
                    {% endif %}
                </div>
                <div class="dates-row">
                    <span>Last Session: {{ client.last_session|timestamp_to_date if client.last_session else 'Never' }}</span>
                    <span>•</span>
                    <span>Created: {{ client.created_at|timestamp_to_date }}</span>
                </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    
    <!-- Legend Card -->
    <div class="legend-card">
        <div class="legend-section">
            <div class="legend-item">
                <div class="legend-dot" style="background: #17976C;"></div>
                <span>Paid / Up to date</span>
            </div>
            <div class="legend-item">
                <div class="legend-dot" style="background: #D68A09;"></div>
                <span>Payment pending</span>
            </div>
            <div class="legend-item">
                <div class="legend-dot" style="background: #C93A3A;"></div>
                <span>Overdue (30+ days)</span>
            </div>
        </div>
        <div class="legend-section">
            <div class="legend-item">
                <span><u>Underlined</u> = Preferred contact</span>
            </div>
            <div class="legend-item">
                <i data-lucide="alert-triangle" style="width: 14px; height: 14px; vertical-align: middle; color: #D97706;"></i> <span>= Do not leave message</span>
            </div>
        </div>
    </div>
{% else %}
<div style="text-align: center; padding: 4rem; background: white; border-radius: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
    <p style="color: #6B7280; font-size: 1.125rem; margin-bottom: 1.5rem;">No clients found.</p>
</div>
{% endif %}

<!-- ============================================================ -->
<!-- RETENTION REVIEW MODAL                                       -->
<!-- Add this HTML to main_view.html, before the closing </body>  -->
<!-- ============================================================ -->

<!-- Retention Review Modal -->
<div id="retention-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); z-index: 9999; align-items: center; justify-content: center;">
    <div style="background: white; padding: 2rem; border-radius: 0.75rem; max-width: 700px; width: 90%; box-shadow: 0 4px 12px rgba(0,0,0,0.2); border-top: 4px solid #D97706;">
        <h3 style="color: #111827; margin-bottom: 1rem; font-size: 1.25rem; font-weight: 600;">
            <i data-lucide="alert-triangle" style="width: 20px; height: 20px; vertical-align: middle; color: #D97706; margin-right: 0.35rem;"></i>
            File Retention Review Required
        </h3>
        <p style="color: #4B5563; margin-bottom: 1rem; line-height: 1.6;">
            The following client files have exceeded their retention period and are due for deletion. 
            Select the files you wish to permanently delete. An archive record will be kept for audit purposes.
        </p>
        
        <div id="retention-list" style="max-height: 300px; overflow-y: auto; margin-bottom: 1rem; border: 1px solid #E5E7EB; border-radius: 0.5rem;">
            <!-- Populated by JavaScript -->
        </div>
        
        <p class="warning-text" style="color: #92400E; background: #FEF3C7; padding: 0.75rem; border-radius: 0.5rem; margin-bottom: 1.5rem; font-size: 0.875rem;">
            <strong>Warning:</strong> This action cannot be undone. All entries, attachments, and client data will be permanently deleted.
        </p>
        
        <div class="modal-actions" style="display: flex; justify-content: space-between; gap: 0.75rem;">
            <button onclick="deleteSelectedClients()" id="delete-selected-btn" style="padding: 0.625rem 1.25rem; background: #9CA3AF; color: white; border: none; border-radius: 0.5rem; font-size: 0.9375rem; font-weight: 500; cursor: not-allowed;" disabled>Delete Selected (0)</button>
            <button onclick="closeRetentionModal()" class="btn">Review Later</button>
        </div>
    </div>
</div>

<style>
/* Retention list item styles */
.retention-item {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    padding: 0.75rem;
    border-bottom: 1px solid #E5E7EB;
    background: #FAFAFA;
}

.retention-item:last-child {
    border-bottom: none;
}

.retention-item:hover {
    background: #F3F4F6;
}

.retention-item input[type="checkbox"] {
    margin-top: 0.25rem;
    width: 18px;
    height: 18px;
    cursor: pointer;
}

.retention-item-details {
    flex: 1;
}

.retention-item-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.25rem;
}

.retention-item-name {
    font-weight: 600;
    color: #1A2B3C;
}

.retention-item-file-number {
    font-size: 0.875rem;
    color: #5B6571;
    font-family: monospace;
}

.retention-item-dates {
    display: flex;
    gap: 1.5rem;
    font-size: 0.8125rem;
    color: #6B7280;
}

.minor-badge {
    font-size: 0.75rem;
    background: #DBEAFE;
    color: #1E40AF;
    padding: 0.125rem 0.375rem;
    border-radius: 4px;
    margin-left: 0.5rem;
}
</style>

<!-- Delete Confirmation Modal -->
<div id="delete-confirm-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 2rem; border-radius: 0.75rem; max-width: 450px; width: 90%; box-shadow: 0 4px 12px rgba(0,0,0,0.2); border-top: 4px solid #DC2626;">
        <h3 style="color: #111827; margin-bottom: 1rem; font-size: 1.25rem; font-weight: 600;">Confirm Permanent Deletion</h3>
        <p style="color: #4B5563; margin-bottom: 1.5rem; line-height: 1.6;">
            Are you sure you want to permanently delete <strong id="delete-count"></strong> client file(s)? This cannot be undone.
        </p>
        <div style="display: flex; justify-content: space-between; gap: 0.75rem;">
            <button onclick="cancelDeletion()" class="btn">Cancel</button>
            <button onclick="confirmDeletion()" style="padding: 0.625rem 1.25rem; background: #DC2626; color: white; border: none; border-radius: 0.5rem; font-size: 0.9375rem; font-weight: 500; cursor: pointer;">Delete Permanently</button>
        </div>
    </div>
</div>


{% endblock %}
