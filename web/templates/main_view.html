{% extends "base.html" %}

{% block title %}Clients - EdgeCase Equalizer{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/main_view.css') }}">
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/main_view.js') }}"></script>
{% endblock %}

{% block content %}

<!-- Stats Cards - Now 6 cards in 2 rows of 3 -->
<div class="stats-container" id="stats-container">
    <div class="stat-card blue" draggable="true" data-card-id="active-clients">
        <div class="stat-number">{{ active_count }}</div>
        <div class="stat-label">Active Clients</div>
    </div>
    <div class="stat-card purple" draggable="true" data-card-id="sessions-week">
        <div class="stat-number">{{ sessions_this_week }}</div>
        <div class="stat-label">Sessions This Week</div>
    </div>
    <div class="stat-card coral" draggable="true" data-card-id="pending-invoices">
        <div class="stat-number">{{ pending_invoices }}</div>
        <div class="stat-label">Pending Invoices</div>
    </div>
    <div class="stat-card mint" draggable="true" data-card-id="billable-month">
        <div class="stat-number">${{ "%.2f"|format(billable_this_month|default(0)) }}</div>
        <div class="stat-label">Billable This Month</div>
    </div>
    <div class="stat-card peach" draggable="true" data-card-id="current-time">
        <div class="stat-number" id="current-time">{{ current_time }}</div>
        <div class="stat-label" id="current-date">{{ current_date }}</div>
    </div>
    <div class="stat-card lavender nav-card" draggable="true" data-card-id="navigation">
        <a href="{{ url_for('settings_page') }}" class="nav-btn rose">Settings</a>
        <a href="{{ url_for('financials') }}" class="nav-btn teal">Ledger</a>
    </div>
</div>

<!-- Controls Bar -->
<div class="controls-bar">
    <div class="controls-left">
        <!-- Filter Dropdown -->
        <div style="position: relative;">
            <button class="dropdown-btn" id="filter-button">
                Filter: {{ type_filter|length }} type{{ 's' if type_filter|length != 1 else '' }} ‚ñæ
            </button>
            <div id="filter-dropdown" style="display: none; position: absolute; top: 100%; left: 0; margin-top: 0.5rem; background: white; border-radius: 0.75rem; box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 1rem; min-width: 200px; z-index: 100;">
                <div id="filter-form">
                    <input type="hidden" name="sort" value="{{ sort_by }}">
                    <input type="hidden" name="order" value="{{ sort_order }}">
                    <input type="hidden" name="search" value="{{ search }}">
                    <input type="hidden" name="view" value="{{ view_mode }}">
                    {% for client_type in all_types %}
                    <label style="display: block; padding: 0.5rem; cursor: pointer; border-radius: 0.5rem;" 
                           onmouseover="this.style.background='#F3F4F6'" 
                           onmouseout="this.style.background='transparent'">
                        <input type="checkbox" name="type" value="{{ client_type.id }}" 
                               {% if client_type.id|string in type_filter %}checked{% endif %}>
                        <span style="margin-left: 0.5rem; font-size: 0.875rem;">{{ client_type.name }}</span>
                    </label>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <!-- Sort Dropdown -->
        <div style="position: relative;">
            <button class="dropdown-btn" onclick="toggleDropdown('sort-dropdown')">
                Sort: {{ sort_by|replace('_', ' ')|title }} ‚ñæ
            </button>
            <div id="sort-dropdown" style="display: none; position: absolute; top: 100%; left: 0; margin-top: 0.5rem; background: white; border-radius: 0.75rem; box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 1rem; min-width: 200px; z-index: 100;">
                <a href="?sort=last_name&order={{ 'desc' if sort_by == 'last_name' and sort_order == 'asc' else 'asc' }}{% for t in type_filter %}&type={{ t }}{% endfor %}&search={{ search }}&view={{ view_mode }}" 
                   style="display: block; padding: 0.5rem; color: #374151; text-decoration: none; border-radius: 0.5rem; font-size: 0.875rem;" 
                   onmouseover="this.style.background='#F3F4F6'" onmouseout="this.style.background='transparent'">
                    Last Name {{ '‚Üì' if sort_by == 'last_name' and sort_order == 'desc' else '‚Üë' if sort_by == 'last_name' else '' }}
                </a>
                <a href="?sort=first_name&order={{ 'desc' if sort_by == 'first_name' and sort_order == 'asc' else 'asc' }}{% for t in type_filter %}&type={{ t }}{% endfor %}&search={{ search }}&view={{ view_mode }}" 
                   style="display: block; padding: 0.5rem; color: #374151; text-decoration: none; border-radius: 0.5rem; font-size: 0.875rem;" 
                   onmouseover="this.style.background='#F3F4F6'" onmouseout="this.style.background='transparent'">
                    First Name {{ '‚Üì' if sort_by == 'first_name' and sort_order == 'desc' else '‚Üë' if sort_by == 'first_name' else '' }}
                </a>
                <a href="?sort=file_number&order={{ 'desc' if sort_by == 'file_number' and sort_order == 'asc' else 'asc' }}{% for t in type_filter %}&type={{ t }}{% endfor %}&search={{ search }}&view={{ view_mode }}" 
                   style="display: block; padding: 0.5rem; color: #374151; text-decoration: none; border-radius: 0.5rem; font-size: 0.875rem;" 
                   onmouseover="this.style.background='#F3F4F6'" onmouseout="this.style.background='transparent'">
                    File Number {{ '‚Üì' if sort_by == 'file_number' and sort_order == 'desc' else '‚Üë' if sort_by == 'file_number' else '' }}
                </a>
                <a href="?sort=last_session&order={{ 'desc' if sort_by == 'last_session' and sort_order == 'asc' else 'asc' }}{% for t in type_filter %}&type={{ t }}{% endfor %}&search={{ search }}&view={{ view_mode }}" 
                   style="display: block; padding: 0.5rem; color: #374151; text-decoration: none; border-radius: 0.5rem; font-size: 0.875rem;" 
                   onmouseover="this.style.background='#F3F4F6'" onmouseout="this.style.background='transparent'">
                    Last Session {{ '‚Üì' if sort_by == 'last_session' and sort_order == 'desc' else '‚Üë' if sort_by == 'last_session' else '' }}
                </a>
                <a href="?sort=created&order={{ 'desc' if sort_by == 'created' and sort_order == 'asc' else 'asc' }}{% for t in type_filter %}&type={{ t }}{% endfor %}&search={{ search }}&view={{ view_mode }}" 
                   style="display: block; padding: 0.5rem; color: #374151; text-decoration: none; border-radius: 0.5rem; font-size: 0.875rem;" 
                   onmouseover="this.style.background='#F3F4F6'" onmouseout="this.style.background='transparent'">
                    Created {{ '‚Üì' if sort_by == 'created' and sort_order == 'desc' else '‚Üë' if sort_by == 'created' else '' }}
                </a>
            </div>
        </div>
        
        <!-- View Toggle -->
        <div class="view-toggle">
            <a href="?view=detailed{% for t in type_filter %}&type={{ t }}{% endfor %}&sort={{ sort_by }}&order={{ sort_order }}&search={{ search }}" 
               class="view-toggle-btn {{ 'active' if view_mode == 'detailed' else '' }}">
                Detailed
            </a>
            <a href="?view=compact{% for t in type_filter %}&type={{ t }}{% endfor %}&sort={{ sort_by }}&order={{ sort_order }}&search={{ search }}" 
               class="view-toggle-btn {{ 'active' if view_mode == 'compact' else '' }}">
                Compact
            </a>
        </div>
    </div>
    
    <div style="display: flex; align-items: center; gap: 1rem;">
        <!-- Search -->
        <form method="get" class="search-box">
            {% for t in type_filter %}<input type="hidden" name="type" value="{{ t }}">{% endfor %}
            <input type="hidden" name="sort" value="{{ sort_by }}">
            <input type="hidden" name="order" value="{{ sort_order }}">
            <input type="hidden" name="view" value="{{ view_mode }}">
            <input type="text" name="search" placeholder="Search clients..." value="{{ search }}">
            <span class="search-icon">üîç</span>
            <button type="button" class="clear-search" style="display: none;">‚úï</button>
        </form>
        
        <!-- Add Client Button -->
        <a href="{{ url_for('manage_links') }}" class="btn-primary">Edit Links</a>
        <a href="{{ url_for('manage_types') }}" class="btn-primary">Edit Types</a>
        <a href="{{ url_for('add_client') }}" class="btn-primary">+ Client</a>
    </div>
</div>

<!-- Clients List -->
{% if clients %}
    <!-- Column Headers (only for detailed view) -->
    {% if view_mode == 'detailed' %}
    <div class="column-headers">
        <div class="col-status">Status/Type</div>
        <div class="col-type"></div>
        <div class="col-file">File #</div>
        <div class="col-name">Name</div>
        <div class="col-contact">Contact</div>
        <div class="col-dates">Last Session / Created</div>
    </div>
    {% endif %}
    
    <div class="clients-container">
        {% for client in clients %}
        <div class="client-card {{ view_mode }}-view" 
            style="background-color: {{ client.type.bubble_color or '#FBFCFD' }}"
            data-type-id="{{ client.type_id }}"
            onclick="window.location='{{ url_for('client_file', client_id=client.id) }}'">
            {% if view_mode == 'detailed' %}
                <!-- Detailed View: Single horizontal line with EXACT column alignment -->
                <div class="payment-dot {{ client.payment_status }}"></div>
                <span class="type-badge" style="background-color: {{ client.type.color }}">
                    {{ client.type.name }}
                </span>
                <span class="file-number">{{ client.file_number }}</span>
                {% if client.is_linked %}<span class="link-icon" title="Linked to other clients">üîó</span>{% endif %}
                <span class="client-name">{{ client.last_name }}, {{ client.first_name }}{% if client.middle_name %} {{ client.middle_name }}{% endif %}</span>
                <div class="contact-info">
                    {% if client.email %}
                    <a href="mailto:{{ client.email }}" class="contact-link {{ 'preferred' if client.preferred_contact == 'email' else '' }}" onclick="event.stopPropagation()">
                        üìß <span>{{ client.email }}</span>
                    </a>
                    {% endif %}
                    {% if client.display_phone %}
                    <a href="{% if client.contact_type == 'text' %}sms:{% else %}tel:{% endif %}{{ client.display_phone }}" 
                       class="contact-link {{ 'preferred' if client.preferred_contact in ['call_cell', 'call_home', 'call_work', 'text'] else '' }}" 
                       onclick="event.stopPropagation()">
                        {{ client.contact_icon }} <span>{{ client.display_phone }}{% if client.ok_to_leave_message == 'no' %} ‚ö†Ô∏è{% endif %}</span>
                    </a>
                    {% endif %}
                </div>
                <div class="dates">
                    <span style="color: #6B7280; font-size: 0.875rem;">{{ client.last_session|timestamp_to_date if client.last_session else 'Never' }}</span>
                    <span style="color: #9CA3AF;">/</span>
                    <span style="color: #6B7280; font-size: 0.875rem;">{{ client.created_at|timestamp_to_date }}</span>
                </div>
            {% else %}
                <!-- Compact View: Multi-line card -->
                <div class="card-header">
                    <div class="payment-dot {{ client.payment_status }}"></div>
                    <span class="type-badge" style="background-color: {{ client.type.color }}">
                        {{ client.type.name }}
                    </span>
                    <span style="color: #6B7280; font-size: 0.875rem;">{{ client.file_number }}</span>
                    {% if client.is_linked %}<span class="link-icon" title="Linked to other clients">üîó</span>{% endif %}
                </div>
                <div class="client-name">{{ client.last_name }}, {{ client.first_name }}{% if client.middle_name %} {{ client.middle_name }}{% endif %}</div>
                <div class="contact-row">
                    {% if client.email %}
                    <a href="mailto:{{ client.email }}" class="contact-link {{ 'preferred' if client.preferred_contact == 'email' else '' }}" onclick="event.stopPropagation()">
                        üìß <span>{{ client.email }}</span>
                    </a>
                    {% endif %}
                    {% if client.display_phone %}
                    <a href="{% if client.contact_type == 'text' %}sms:{% else %}tel:{% endif %}{{ client.display_phone }}" 
                       class="contact-link {{ 'preferred' if client.preferred_contact in ['call_cell', 'call_home', 'call_work', 'text'] else '' }}" 
                       onclick="event.stopPropagation()">
                        {{ client.contact_icon }} <span>{{ client.display_phone }}{% if client.ok_to_leave_message == 'no' %} ‚ö†Ô∏è{% endif %}</span>
                    </a>
                    {% endif %}
                </div>
                <div class="dates-row">
                    <span>Last Session: {{ client.last_session|timestamp_to_date if client.last_session else 'Never' }}</span>
                    <span>‚Ä¢</span>
                    <span>Created: {{ client.created_at|timestamp_to_date }}</span>
                </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    
    <!-- Legend Card -->
    <div class="legend-card">
        <div class="legend-section">
            <div class="legend-item">
                <div class="legend-dot" style="background: #17976C;"></div>
                <span>Paid / Up to date</span>
            </div>
            <div class="legend-item">
                <div class="legend-dot" style="background: #D68A09;"></div>
                <span>Payment pending</span>
            </div>
            <div class="legend-item">
                <div class="legend-dot" style="background: #C93A3A;"></div>
                <span>Overdue (30+ days)</span>
            </div>
        </div>
        <div class="legend-section">
            <div class="legend-item">
                <span><u>Underlined</u> = Preferred contact</span>
            </div>
            <div class="legend-item">
                <span>‚ö†Ô∏è = Do not leave message</span>
            </div>
        </div>
    </div>
{% else %}
<div style="text-align: center; padding: 4rem; background: white; border-radius: 1rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
    <p style="color: #6B7280; font-size: 1.125rem; margin-bottom: 1.5rem;">No clients found.</p>
</div>
{% endif %}




{% endblock %}