{% extends "base.html" %}

{% block title %}Profile - EdgeCase Equalizer{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/profile.css') }}">
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/profile.js') }}"></script>
{% endblock %}

{% block content %}
<div class="card profile-card">
    <div class="profile-header">
        <div>
            <h2><i data-lucide="user-round" class="page-icon"></i>Client Profile</h2>
            <div class="text-muted type-badge-wrapper">
                <span class="type-badge" 
                      id="profile-type-badge"
                      style="background-color: {{ client.type.color }};">
                    {{ client.type.name }}
                </span>
                <!-- Type change dropdown -->
                <div id="type-dropdown" class="type-dropdown" style="display: none;">
                    <form method="post" action="{{ url_for('clients.change_client_type', client_id=client.id) }}">
                        {% for type in all_types %}
                        {% if type.name != 'Deleted' %}
                        <label class="type-dropdown-label {% if type.id == client.type_id %}selected{% endif %}">
                            <input type="radio" name="type_id" value="{{ type.id }}" 
                                   {% if type.id == client.type_id %}checked{% endif %}
                                   onchange="this.form.submit()">
                            <span>{{ type.name }}</span>
                        </label>
                        {% endif %}
                        {% endfor %}
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Retention Info Box (only for Inactive clients) -->
    {% if retention_info %}
    <div class="retention-info-box {% if retention_info.is_due %}danger{% else %}warning{% endif %}">
        <div class="retention-content">
            <i data-lucide="{% if retention_info.is_due %}alert-triangle{% else %}clock{% endif %}" class="retention-icon {% if retention_info.is_due %}danger{% else %}warning{% endif %}"></i>
            <div class="retention-body">
                <h4 class="retention-title {% if retention_info.is_due %}danger{% else %}warning{% endif %}">
                    {% if retention_info.is_due %}Ready for Deletion{% else %}Retention Period Active{% endif %}
                </h4>
                <div class="retention-details">
                    <p><strong>Retention Period:</strong> {{ retention_info.retention_days }} day{% if retention_info.retention_days != 1 %}s{% endif %}</p>
                    <p><strong>Last Contact:</strong> {{ retention_info.last_contact }}</p>
                    <p><strong>Scheduled Deletion:</strong> {{ retention_info.retain_until }}</p>
                </div>
                <div class="retention-actions">
                    <button type="button" onclick="showDeleteConfirmModal()" class="btn btn-danger btn-small">
                        <i data-lucide="trash-2" class="btn-icon-sm"></i>
                        Delete Now
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <form method="post" id="profile-form">
    
    <div class="form-row">
            <div class="form-group">
                <label for="first_name">First Name</label>
                <input type="text" id="first_name" name="first_name" 
                       value="{{ client.first_name }}">
            </div>
            
            <div class="form-group">
                <label for="middle_name">Middle Name</label>
                <input type="text" id="middle_name" name="middle_name" 
                       value="{{ client.middle_name or '' }}">
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="last_name">Last Name</label>
                <input type="text" id="last_name" name="last_name" 
                       value="{{ client.last_name }}">
            </div>
            
            <div class="form-group">
                <label for="file_number">File Number</label>
                <input type="text" id="file_number" name="file_number" 
                       value="{{ client.file_number }}">
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="date_of_birth">Date of Birth</label>
                <div class="date-input-group">
                    <select id="dob_year" name="dob_year">
                        <option value="">Year</option>
                        {% for year in range(2024, 1899, -1) %}
                        <option value="{{ year }}" {% if profile and profile.date_of_birth and profile.date_of_birth[:4] == year|string %}selected{% endif %}>{{ year }}</option>
                        {% endfor %}
                    </select>
                    <select id="dob_month" name="dob_month">
                        <option value="">Month</option>
                        {% for month in range(1, 13) %}
                        <option value="{{ '%02d'|format(month) }}" {% if profile and profile.date_of_birth and profile.date_of_birth[5:7] == '%02d'|format(month) %}selected{% endif %}>{{ '%02d'|format(month) }}</option>
                        {% endfor %}
                    </select>
                    <select id="dob_day" name="dob_day">
                        <option value="">Day</option>
                        {% for day in range(1, 32) %}
                        <option value="{{ '%02d'|format(day) }}" {% if profile and profile.date_of_birth and profile.date_of_birth[8:10] == '%02d'|format(day) %}selected{% endif %}>{{ '%02d'|format(day) }}</option>
                        {% endfor %}
                    </select>
                </div>
                <input type="hidden" id="date_of_birth" name="date_of_birth" value="{{ profile.date_of_birth if profile else '' }}">
            </div>
            
            <div class="form-group">
                <label for="gender">Gender</label>
                <input type="text" id="gender" name="gender" 
                       value="{{ profile.content if profile and profile.content else '' }}"
                       placeholder="Optional">
            </div>
        </div>
        
        <div class="form-row-full">
            <div class="form-group">
                <label for="address">Address</label>
                <textarea id="address" name="address" rows="5" 
                          placeholder="123 Main Street&#10;Apt 4B&#10;Toronto, ON M5V 1A1&#10;Canada">{{ profile.address if profile else '' }}</textarea>
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="email">Email</label>
                <input type="email" id="email" name="email" 
                       value="{{ profile.email if profile else '' }}">
            </div>
            
            <div class="form-group">
                <label for="phone">Cell</label>
                <input type="tel" id="phone" name="phone" 
                       value="{{ profile.phone if profile else '' }}"
                       placeholder="(613) 555-1234"
                       class="phone-input">
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="home_phone">Home Phone</label>
                <input type="tel" id="home_phone" name="home_phone" 
                       value="{{ profile.home_phone if profile else '' }}"
                       placeholder="(613) 555-1234"
                       class="phone-input">
            </div>
            
            <div class="form-group">
                <label for="work_phone">Work Phone</label>
                <input type="tel" id="work_phone" name="work_phone" 
                       value="{{ profile.work_phone if profile else '' }}"
                       placeholder="(613) 555-1234"
                       class="phone-input">
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="text_number">Text Number</label>
                <select id="text_number" name="text_number">
                    <option value="none" {% if not profile or not profile.text_number or profile.text_number == 'none' %}selected{% endif %}>None (no texting)</option>
                    <option value="cell" {% if profile and profile.text_number == 'cell' %}selected{% endif %}>Cell</option>
                    <option value="home" {% if profile and profile.text_number == 'home' %}selected{% endif %}>Home Phone</option>
                    <option value="work" {% if profile and profile.text_number == 'work' %}selected{% endif %}>Work Phone</option>
                </select>
                <p class="help-text">Which number to use for text messages</p>
            </div>
            
            <div class="form-group">
                <label for="ok_to_leave_message">OK to Leave Message?</label>
                <select id="ok_to_leave_message" name="ok_to_leave_message">
                    <option value="">Select...</option>
                    <option value="yes" {% if profile and profile.ok_to_leave_message == 'yes' %}selected{% endif %}>Yes</option>
                    <option value="no" {% if profile and profile.ok_to_leave_message == 'no' %}selected{% endif %}>No</option>
                </select>
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="preferred_contact">Preferred Contact Method</label>
                <select id="preferred_contact" name="preferred_contact">
                    <option value="">Select...</option>
                    <option value="email" {% if profile and profile.preferred_contact == 'email' %}selected{% endif %}>Email</option>
                    <option value="call_cell" {% if profile and profile.preferred_contact == 'call_cell' %}selected{% endif %}>Call Cell</option>
                    <option value="call_home" {% if profile and profile.preferred_contact == 'call_home' %}selected{% endif %}>Call Home</option>
                    <option value="call_work" {% if profile and profile.preferred_contact == 'call_work' %}selected{% endif %}>Call Work</option>
                    <option value="text" {% if profile and profile.preferred_contact == 'text' %}selected{% endif %}>Text Message</option>
                </select>
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="emergency_contact_name">Emergency Contact Name</label>
                <input type="text" id="emergency_contact_name" name="emergency_contact_name" 
                       value="{{ profile.emergency_contact_name if profile else '' }}"
                       placeholder="Optional">
            </div>
            
            <div class="form-group">
                <label for="emergency_contact_phone">Emergency Contact Phone</label>
                <input type="tel" id="emergency_contact_phone" name="emergency_contact_phone" 
                       value="{{ profile.emergency_contact_phone if profile else '' }}"
                       placeholder="(613) 555-1234"
                       class="phone-input">
            </div>
        </div>
        
        <div class="form-row-full">
            <div class="form-group">
                <label for="emergency_contact_relationship">Emergency Contact Relationship</label>
                <input type="text" id="emergency_contact_relationship" name="emergency_contact_relationship" 
                       value="{{ profile.emergency_contact_relationship if profile else '' }}"
                       placeholder="e.g., Spouse, Parent, Friend">
            </div>
        </div>
        
        <div class="form-row-full">
            <div class="form-group">
                <label for="referral_source">Referral Source</label>
                <input type="text" id="referral_source" name="referral_source" 
                       value="{{ profile.referral_source if profile else '' }}"
                       placeholder="e.g., Referral, Online search, Insurance directory">
            </div>
        </div>
        
        <div class="form-row-full">
            <div class="form-group">
                <label for="additional_info">Additional Information</label>
                <textarea id="additional_info" name="additional_info" 
                          placeholder="Any other relevant information about the client...">{{ profile.additional_info if profile else '' }}</textarea>
                <p class="help-text">Supports Markdown formatting</p>
            </div>
        </div>
        
        <div class="form-row-full">
            <div class="form-group">
                <label for="meeting_link">Meeting Link</label>
                <input type="url" id="meeting_link" name="meeting_link" 
                       value="{{ profile.meeting_link or '' if profile else '' }}"
                       placeholder="https://meet.google.com/...">
                <p class="help-text">Default video conferencing link for scheduling appointments</p>
            </div>
        </div>
        
        <!-- Individual Session Fee Section -->
        <div class="section-divider"></div>
        <h3 class="section-heading">Individual Session Fee</h3>

        <div class="fee-grid">
            <div class="fee-field">
                <label for="session_base">Base Price</label>
                <input type="number" id="session_base" name="session_base" 
                    step="0.01" min="0"
                    value="{{ '%.2f' | format(profile.session_base) if profile and profile.session_base else '' }}"
                    placeholder="100.00">
                <small>Before tax</small>
            </div>
            
            <div class="fee-field">
                <label for="session_tax_rate">Tax Rate</label>
                <input type="number" id="session_tax_rate" name="session_tax_rate" 
                    step="0.01" min="0" max="100"
                    value="{{ '%.2f' | format(profile.session_tax_rate) if profile and profile.session_tax_rate else '' }}"
                    placeholder="13.00">
                <small>Percentage (%)</small>
            </div>
            
            <div class="fee-field">
                <label for="session_total">Total</label>
                <input type="number" id="session_total" name="session_total" 
                    step="0.01" min="0"
                    value="{{ '%.2f' | format(profile.session_total) if profile and profile.session_total else '' }}"
                    placeholder="113.00">
                <small>With tax</small>
            </div>
        </div>
        <p class="help-text">Fill any two fields and the third calculates automatically. Leave blank if client only attends couples/family/group sessions.</p>

        <!-- Default Session Duration -->
        <div class="form-row-full mt-2">
            <div class="form-group">
                <label for="default_session_duration">Default Session Duration (minutes)</label>
                <input type="number" id="default_session_duration" name="default_session_duration" 
                    step="5" min="0"
                    value="{{ profile.default_session_duration if profile and profile.default_session_duration else '' }}"
                    placeholder="50">
                <p class="help-text">Auto-populates duration field when creating individual sessions (optional)</p>
            </div>
        </div>

        <!-- Minor Client Checkbox -->
        <div class="form-row-full section-border-top">
            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="is_minor" name="is_minor" value="1"
                           {% if profile and profile.is_minor %}checked{% endif %}>
                    <span>Client is a minor (under age of majority)</span>
                </label>
            </div>
        </div>
        
        <!-- Guardian/Billing Section -->
        <div id="guardian-fields" style="display: {% if profile and profile.is_minor %}block{% else %}none{% endif %};">
            <h3 class="section-heading pt-2">
                Guardian/Billing Information
            </h3>
            
            <div class="guardian-info-box" style="margin-bottom: 1rem;">
                <div class="info-note">
                    <strong>Tip:</strong> Enter primary contact info (email, phone, preferred method) in the Contact section above. 
                    This section is for billing splits only.
                </div>
            </div>
            
            <!-- Calculated Guardian Amounts -->
            <div class="guardian-info-box">
                <div class="info-label">
                    <strong>Individual Session Fee:</strong> 
                    <span id="guardian-fee-display">
                    {% if profile and profile.session_total %}
                        ${{ '%.2f' | format(profile.session_total) }}
                    {% else %}
                        (Not set - configure above)
                    {% endif %}
                    </span>
                </div>
                <div id="guardian-amounts-display" class="info-note" style="margin-top: 0.5rem;">
                    <!-- Populated by JavaScript -->
                </div>
            </div>
            
            <!-- Guardian 1 (Primary) -->
            <h4 class="guardian-heading">Primary Guardian</h4>
            <div class="form-row">
                <div class="form-group">
                    <label for="guardian1_name">Name</label>
                    <input type="text" id="guardian1_name" name="guardian1_name"
                           value="{{ profile.guardian1_name if profile else '' }}"
                           placeholder="Guardian's full name">
                </div>
                
                <div class="form-group">
                    <label for="guardian1_email">Email</label>
                    <input type="email" id="guardian1_email" name="guardian1_email"
                           value="{{ profile.guardian1_email if profile else '' }}"
                           placeholder="For invoices">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="guardian1_phone">Phone</label>
                    <input type="tel" id="guardian1_phone" name="guardian1_phone"
                           value="{{ profile.guardian1_phone if profile else '' }}"
                           placeholder="(613) 555-1234"
                           class="phone-input guardian-phone">
                </div>
                
                <div class="form-group">
                    <label for="guardian1_amount">Pays (%)</label>
                    <input type="number" id="guardian1_amount" name="guardian1_amount"
                           step="1" min="0" max="100"
                           value="{{ profile.guardian1_pays_percent | int if profile and profile.guardian1_pays_percent else '' }}"
                           placeholder="60"
                           class="guardian-amount">
                </div>
            </div>
            
            <div class="form-row-full">
                <div class="form-group">
                    <label for="guardian1_address">Address</label>
                    <textarea id="guardian1_address" name="guardian1_address" rows="3"
                              placeholder="For invoices and statements">{{ profile.guardian1_address if profile else '' }}</textarea>
                </div>
            </div>
            
            <!-- Add Second Guardian Checkbox -->
            <div class="form-row-full">
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="has_guardian2" name="has_guardian2" value="1"
                               {% if profile and profile.has_guardian2 %}checked{% endif %}>
                        <span>Add second guardian</span>
                    </label>
                </div>
            </div>
            
            <!-- Guardian 2 (Secondary) -->
            <div id="guardian2-fields" style="display: {% if profile and profile.has_guardian2 %}block{% else %}none{% endif %};">
                <h4 class="guardian-heading">Secondary Guardian</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label for="guardian2_name">Name</label>
                        <input type="text" id="guardian2_name" name="guardian2_name"
                               value="{{ profile.guardian2_name if profile else '' }}"
                               placeholder="Guardian's full name">
                    </div>
                    
                    <div class="form-group">
                        <label for="guardian2_email">Email</label>
                        <input type="email" id="guardian2_email" name="guardian2_email"
                               value="{{ profile.guardian2_email if profile else '' }}"
                               placeholder="For invoices">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="guardian2_phone">Phone</label>
                        <input type="tel" id="guardian2_phone" name="guardian2_phone"
                               value="{{ profile.guardian2_phone if profile else '' }}"
                               placeholder="(613) 555-1234"
                               class="phone-input guardian-phone">
                    </div>
                    
                    <div class="form-group">
                        <label for="guardian2_amount">Pays (%)</label>
                        <input type="number" id="guardian2_amount" name="guardian2_amount"
                               step="1" min="0" max="100"
                               value="{{ profile.guardian2_pays_percent | int if profile and profile.guardian2_pays_percent else '' }}"
                               placeholder="40"
                               class="guardian-amount">
                    </div>
                </div>
                
                <div class="form-row-full">
                    <div class="form-group">
                        <label for="guardian2_address">Address</label>
                        <textarea id="guardian2_address" name="guardian2_address" rows="3"
                                  placeholder="For invoices and statements">{{ profile.guardian2_address if profile else '' }}</textarea>
                    </div>
                </div>
            </div>
        </div>

         <!-- Edit History (only shows if profile exists and is locked) -->
        {% if profile %}
            {% include 'components/edit_history.html' %}
        {% endif %}
        
        <!-- Form Buttons -->
        <div class="profile-form-actions">
            <a href="{{ url_for('clients.client_file', client_id=client.id) }}" class="btn btn-secondary">Cancel</a>
            <button type="submit" class="btn">Save Profile</button>
        </div>
    </form>
</div>

<!-- Validation error modal -->
<div id="validation-modal" class="modal-overlay" style="display: none;">
    <div class="validation-modal-content">
        <h3>Validation Error</h3>
        <div id="validation-errors" class="errors"></div>
        <button onclick="closeValidationModal()" class="btn-ok">
            OK
        </button>
    </div>
</div>

<!-- Delete confirmation modal (for retention deletion) -->
{% if retention_info %}
<div id="delete-confirm-modal" class="modal-overlay" style="display: none;">
    <div class="delete-modal-content">
        <h3>
            <i data-lucide="alert-triangle" class="page-icon icon-danger"></i>
            Permanently Delete Client?
        </h3>
        <p>
            This will permanently delete <strong>{{ client.first_name }} {{ client.last_name }}</strong> and all associated entries.
        </p>
        <p class="note">
            A minimal archive record will be kept for compliance purposes (file number, name, and dates only).
        </p>
        <div class="modal-actions">
            <button onclick="closeDeleteConfirmModal()" class="btn btn-secondary">Cancel</button>
            <button onclick="confirmDelete()" class="btn btn-danger">
                <i data-lucide="trash-2" class="btn-icon-sm"></i>
                Delete Permanently
            </button>
        </div>
    </div>
</div>

<script>
/**
 * Show the delete confirmation modal
 */
function showDeleteConfirmModal() {
    const modal = document.getElementById('delete-confirm-modal');
    modal.style.display = 'flex';
    lucide.createIcons();
}

/**
 * Close the delete confirmation modal
 */
function closeDeleteConfirmModal() {
    document.getElementById('delete-confirm-modal').style.display = 'none';
}

/**
 * Confirm and execute client deletion
 */
async function confirmDelete() {
    const clientId = {{ client.id }};
    
    try {
        const response = await fetch('/api/retention-delete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ client_ids: [clientId] })
        });
        
        if (response.ok) {
            window.location.href = '/';
        } else {
            const data = await response.json();
            alert('Error deleting client: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        alert('Error deleting client: ' + error.message);
    }
}

// Close modal on escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeDeleteConfirmModal();
    }
});

// Close modal on background click
document.getElementById('delete-confirm-modal')?.addEventListener('click', function(e) {
    if (e.target === this) {
        closeDeleteConfirmModal();
    }
});
</script>
{% endif %}

{% endblock %}
