{% extends "base.html" %}

{% block title %}Profile - {{ client.first_name }} {{ client.last_name }} - EdgeCase Equalizer{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/profile.css') }}">
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/profile.js') }}"></script>
{% endblock %}

{% block content %}
<div class="card" style="max-width: 900px; margin: 0 auto;">
    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 2rem;">
        <div>
            <h2>Client Profile</h2>
            <div style="color: #718096; position: relative; display: inline-block;">
                <span class="type-badge" 
                      id="profile-type-badge"
                      style="background-color: {{ client.type.color }}; cursor: pointer;">
                    {{ client.type.name }}
                </span>
                <!-- Type change dropdown -->
                <div id="type-dropdown" style="display: none; position: absolute; top: 100%; left: 0; margin-top: 0.5rem; background: white; border-radius: 0.75rem; box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 1rem; min-width: 200px; z-index: 100;">
                    <form method="post" action="{{ url_for('change_client_type', client_id=client.id) }}">
                        {% for type in all_types %}
                        {% if type.name != 'Deleted' %}
                        <label style="display: block; padding: 0.5rem; cursor: pointer; border-radius: 0.5rem; {% if type.id == client.type_id %}font-weight: 600; background: #F3F4F6;{% endif %}" 
                               onmouseover="if ({{ type.id }} != {{ client.type_id }}) this.style.background='#F3F4F6'" 
                               onmouseout="if ({{ type.id }} != {{ client.type_id }}) this.style.background='transparent'">
                            <input type="radio" name="type_id" value="{{ type.id }}" 
                                   {% if type.id == client.type_id %}checked{% endif %}
                                   onchange="this.form.submit()"
                                   style="margin-right: 0.5rem;">
                            <span style="font-size: 0.875rem;">{{ type.name }}</span>
                        </label>
                        {% endif %}
                        {% endfor %}
                    </form>
                </div>
            </div>
        </div>
    </div>

    <form method="post" id="profile-form" 
          data-type-base="{{' %.2f' | format(client.type.session_base_price) if client.type.session_base_price else '0.00' }}"
          data-type-tax="{{ '%.2f' | format(client.type.session_tax_rate) if client.type.session_tax_rate else '0.00' }}"
          data-type-total="{{ '%.2f' | format(client.type.session_fee) if client.type.session_fee else '0.00' }}">
    
    <div class="form-row">
            <div class="form-group">
                <label for="first_name">First Name</label>
                <input type="text" id="first_name" name="first_name" 
                       value="{{ client.first_name }}">
            </div>
            
            <div class="form-group">
                <label for="middle_name">Middle Name</label>
                <input type="text" id="middle_name" name="middle_name" 
                       value="{{ client.middle_name or '' }}">
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="last_name">Last Name</label>
                <input type="text" id="last_name" name="last_name" 
                       value="{{ client.last_name }}">
            </div>
            
            <div class="form-group">
                <label for="file_number">File Number</label>
                <input type="text" id="file_number" name="file_number" 
                       value="{{ client.file_number }}" readonly
                       style="background: #f7fafc; cursor: not-allowed;">
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="date_of_birth">Date of Birth</label>
                <div class="date-input-group">
                    <select id="dob_year" name="dob_year">
                        <option value="">Year</option>
                        {% for year in range(2024, 1899, -1) %}
                        <option value="{{ year }}" {% if profile and profile.date_of_birth and profile.date_of_birth[:4] == year|string %}selected{% endif %}>{{ year }}</option>
                        {% endfor %}
                    </select>
                    <select id="dob_month" name="dob_month">
                        <option value="">Month</option>
                        {% for month in range(1, 13) %}
                        <option value="{{ '%02d'|format(month) }}" {% if profile and profile.date_of_birth and profile.date_of_birth[5:7] == '%02d'|format(month) %}selected{% endif %}>{{ '%02d'|format(month) }}</option>
                        {% endfor %}
                    </select>
                    <select id="dob_day" name="dob_day">
                        <option value="">Day</option>
                        {% for day in range(1, 32) %}
                        <option value="{{ '%02d'|format(day) }}" {% if profile and profile.date_of_birth and profile.date_of_birth[8:10] == '%02d'|format(day) %}selected{% endif %}>{{ '%02d'|format(day) }}</option>
                        {% endfor %}
                    </select>
                </div>
                <input type="hidden" id="date_of_birth" name="date_of_birth" value="{{ profile.date_of_birth if profile else '' }}">
            </div>
            
            <div class="form-group">
                <label for="gender">Gender</label>
                <input type="text" id="gender" name="gender" 
                       value="{{ profile.content if profile and profile.content else '' }}"
                       placeholder="Optional">
            </div>
        </div>
        
        <div class="form-row-full">
            <div class="form-group">
                <label for="address">Address</label>
                <textarea id="address" name="address" rows="5" 
                          placeholder="123 Main Street&#10;Apt 4B&#10;Toronto, ON M5V 1A1&#10;Canada">{{ profile.address if profile else '' }}</textarea>
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="email">Email</label>
                <input type="email" id="email" name="email" 
                       value="{{ profile.email if profile else '' }}">
            </div>
            
            <div class="form-group">
                <label for="phone">Cell</label>
                <input type="tel" id="phone" name="phone" 
                       value="{{ profile.phone if profile else '' }}"
                       placeholder="(613) 555-1234"
                       class="phone-input">
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="home_phone">Home Phone</label>
                <input type="tel" id="home_phone" name="home_phone" 
                       value="{{ profile.home_phone if profile else '' }}"
                       placeholder="(613) 555-1234"
                       class="phone-input">
            </div>
            
            <div class="form-group">
                <label for="work_phone">Work Phone</label>
                <input type="tel" id="work_phone" name="work_phone" 
                       value="{{ profile.work_phone if profile else '' }}"
                       placeholder="(613) 555-1234"
                       class="phone-input">
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="text_number">Text Number</label>
                <select id="text_number" name="text_number">
                    <option value="none" {% if not profile or not profile.text_number or profile.text_number == 'none' %}selected{% endif %}>None (no texting)</option>
                    <option value="cell" {% if profile and profile.text_number == 'cell' %}selected{% endif %}>Cell</option>
                    <option value="home" {% if profile and profile.text_number == 'home' %}selected{% endif %}>Home Phone</option>
                    <option value="work" {% if profile and profile.text_number == 'work' %}selected{% endif %}>Work Phone</option>
                </select>
                <p class="help-text">Which number to use for text messages</p>
            </div>
            
            <div class="form-group">
                <label for="ok_to_leave_message">OK to Leave Message?</label>
                <select id="ok_to_leave_message" name="ok_to_leave_message">
                    <option value="">Select...</option>
                    <option value="yes" {% if profile and profile.ok_to_leave_message == 'yes' %}selected{% endif %}>Yes</option>
                    <option value="no" {% if profile and profile.ok_to_leave_message == 'no' %}selected{% endif %}>No</option>
                </select>
            </div>
        </div>
        
        <div class="form-row-full">
            <div class="form-group">
                <label for="preferred_contact">Preferred Contact Method</label>
                <select id="preferred_contact" name="preferred_contact">
                    <option value="">Select...</option>
                    <option value="email" {% if profile and profile.preferred_contact == 'email' %}selected{% endif %}>Email</option>
                    <option value="call_cell" {% if profile and profile.preferred_contact == 'call_cell' %}selected{% endif %}>Call Cell</option>
                    <option value="call_home" {% if profile and profile.preferred_contact == 'call_home' %}selected{% endif %}>Call Home</option>
                    <option value="call_work" {% if profile and profile.preferred_contact == 'call_work' %}selected{% endif %}>Call Work</option>
                    <option value="text" {% if profile and profile.preferred_contact == 'text' %}selected{% endif %}>Text Message</option>
                </select>
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="emergency_contact_name">Emergency Contact Name</label>
                <input type="text" id="emergency_contact_name" name="emergency_contact_name" 
                       value="{{ profile.emergency_contact_name if profile else '' }}"
                       placeholder="Optional">
            </div>
            
            <div class="form-group">
                <label for="emergency_contact_phone">Emergency Contact Phone</label>
                <input type="tel" id="emergency_contact_phone" name="emergency_contact_phone" 
                       value="{{ profile.emergency_contact_phone if profile else '' }}"
                       placeholder="(613) 555-1234"
                       class="phone-input">
            </div>
        </div>
        
        <div class="form-row-full">
            <div class="form-group">
                <label for="emergency_contact_relationship">Emergency Contact Relationship</label>
                <input type="text" id="emergency_contact_relationship" name="emergency_contact_relationship" 
                       value="{{ profile.emergency_contact_relationship if profile else '' }}"
                       placeholder="e.g., Spouse, Parent, Friend">
            </div>
        </div>
        
        <div class="form-row-full">
            <div class="form-group">
                <label for="referral_source">How did you hear about this practice?</label>
                <input type="text" id="referral_source" name="referral_source" 
                       value="{{ profile.referral_source if profile else '' }}"
                       placeholder="e.g., Referral, Online search, Insurance directory">
            </div>
        </div>
        
        <div class="form-row-full">
            <div class="form-group">
                <label for="additional_info">Additional Information</label>
                <textarea id="additional_info" name="additional_info" 
                          placeholder="Any other relevant information about the client...">{{ profile.additional_info if profile else '' }}</textarea>
                <p class="help-text">Supports Markdown formatting</p>
            </div>
        </div>
        
        <!-- Fee Override Section -->
        <div class="section-divider"></div>
        <h3 class="section-heading">Fee Override</h3>
        
        <div class="form-row-full">
            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="fee_override_enabled" name="fee_override_enabled" value="1"
                           {% if profile and profile.fee_override_base %}checked{% endif %}>
                    <span>Override default fees from Client Type</span>
                </label>
                <p class="help-text">Use custom fees for this client instead of the {{ client.type.name }} type defaults ({{ '%.2f' | format(client.type.session_base_price) if client.type.session_base_price else '0.00' }} base + {{ '%.2f' | format(client.type.session_tax_rate) if client.type.session_tax_rate else '0.00' }}% tax = ${{ '%.2f' | format(client.type.session_fee) if client.type.session_fee else '0.00' }})</p>
            </div>
        </div>
        
        <div id="fee-override-fields" style="display: {% if profile and profile.fee_override_base %}block{% else %}none{% endif %};">
            <div class="fee-grid">
                <div class="fee-field">
                    <label for="fee_override_base">Base Price</label>
                    <input type="number" id="fee_override_base" name="fee_override_base" 
                           step="0.01" min="0"
                           value="{{ '%.2f' | format(profile.fee_override_base) if profile and profile.fee_override_base else '' }}"
                           placeholder="100.00">
                    <small>Before tax</small>
                </div>
                
                <div class="fee-field">
                    <label for="fee_override_tax_rate">Tax Rate</label>
                    <input type="number" id="fee_override_tax_rate" name="fee_override_tax_rate" 
                           step="0.01" min="0" max="100"
                           value="{{ '%.2f' | format(profile.fee_override_tax_rate) if profile and profile.fee_override_tax_rate else '' }}"
                           placeholder="13.00">
                    <small>Percentage (%)</small>
                </div>
                
                <div class="fee-field">
                    <label for="fee_override_total">Total</label>
                    <input type="number" id="fee_override_total" name="fee_override_total" 
                           step="0.01" min="0"
                           value="{{ '%.2f' | format(profile.fee_override_total) if profile and profile.fee_override_total else '' }}"
                           placeholder="113.00">
                    <small>With tax</small>
                </div>
            </div>
            <p class="help-text">Fill any two fields and the third calculates automatically</p>
        </div>

<!-- Minor Client Checkbox -->
        <div class="form-row-full" style="margin-top: 2rem; padding-top: 1.5rem;">
            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="is_minor" name="is_minor" value="1"
                           {% if profile and profile.is_minor %}checked{% endif %}>
                    <span>Client is a minor (under age of majority)</span>
                </label>
            </div>
        </div>
        
        <!-- Guardian/Billing Section -->
        <div id="guardian-fields" style="display: {% if profile and profile.is_minor %}block{% else %}none{% endif %};">
            <h3 style="color: #111827; font-size: 1.25rem; margin-bottom: 1rem; padding-top: 1.5rem;">
                Guardian/Billing Information
            </h3>
            
            <!-- Total Session Fee Display for Reference -->
            <div style="background: #F3F4F6; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem;">
                <div style="font-size: 0.875rem; color: #6B7280;">
                    <strong>Session Fee:</strong> 
                    {% if profile and profile.fee_override_total %}
                        ${{ '%.2f' | format(profile.fee_override_total) }} (Profile Override)
                    {% else %}
                        (From Client Type)
                    {% endif %}
                </div>
                <div style="font-size: 0.75rem; color: #9CA3AF; margin-top: 0.25rem;">
                    Guardian percentages will apply to all billable entries (sessions, items, absences)
                </div>
            </div>
            
            <!-- Guardian 1 (Primary) -->
            <h4 class="guardian-heading">Primary Guardian</h4>
            <div class="form-row">
                <div class="form-group">
                    <label for="guardian1_name">Name</label>
                    <input type="text" id="guardian1_name" name="guardian1_name"
                           value="{{ profile.guardian1_name if profile else '' }}"
                           placeholder="Guardian's full name">
                </div>
                
                <div class="form-group">
                    <label for="guardian1_email">Email</label>
                    <input type="email" id="guardian1_email" name="guardian1_email"
                           value="{{ profile.guardian1_email if profile else '' }}"
                           placeholder="For invoices">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="guardian1_phone">Phone</label>
                    <input type="tel" id="guardian1_phone" name="guardian1_phone"
                           value="{{ profile.guardian1_phone if profile else '' }}"
                           placeholder="(613) 555-1234"
                           class="phone-input guardian-phone">
                </div>
                
                <div class="form-group">
                    <label for="guardian1_amount">Pays (%)</label>
                    <input type="number" id="guardian1_amount" name="guardian1_amount"
                           step="0.1" min="0" max="100"
                           value="{{ '%.1f' | format(profile.guardian1_pays_percent) if profile and profile.guardian1_pays_percent else '' }}"
                           placeholder="60.0"
                           class="guardian-amount">
                </div>
            </div>
            
            <div class="form-row-full">
                <div class="form-group">
                    <label for="guardian1_address">Address</label>
                    <textarea id="guardian1_address" name="guardian1_address" rows="3"
                              placeholder="For invoices and statements">{{ profile.guardian1_address if profile else '' }}</textarea>
                </div>
            </div>
            
            <!-- Add Second Guardian Checkbox -->
            <div class="form-row-full">
                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="has_guardian2" name="has_guardian2" value="1"
                               {% if profile and profile.has_guardian2 %}checked{% endif %}>
                        <span>Add second guardian</span>
                    </label>
                </div>
            </div>
            
            <!-- Guardian 2 (Secondary) -->
            <div id="guardian2-fields" style="display: {% if profile and profile.has_guardian2 %}block{% else %}none{% endif %};">
                <h4 class="guardian-heading">Secondary Guardian</h4>
                <div class="form-row">
                    <div class="form-group">
                        <label for="guardian2_name">Name</label>
                        <input type="text" id="guardian2_name" name="guardian2_name"
                               value="{{ profile.guardian2_name if profile else '' }}"
                               placeholder="Guardian's full name">
                    </div>
                    
                    <div class="form-group">
                        <label for="guardian2_email">Email</label>
                        <input type="email" id="guardian2_email" name="guardian2_email"
                               value="{{ profile.guardian2_email if profile else '' }}"
                               placeholder="For invoices">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="guardian2_phone">Phone</label>
                        <input type="tel" id="guardian2_phone" name="guardian2_phone"
                               value="{{ profile.guardian2_phone if profile else '' }}"
                               placeholder="(613) 555-1234"
                               class="phone-input guardian-phone">
                    </div>
                    
                    <div class="form-group">
                        <label for="guardian2_amount">Pays (%)</label>
                        <input type="number" id="guardian2_amount" name="guardian2_amount"
                               step="0.1" min="0" max="100"
                               value="{{ '%.1f' | format(profile.guardian2_pays_percent) if profile and profile.guardian2_pays_percent else '' }}"
                               placeholder="40.0"
                               class="guardian-amount">
                    </div>
                </div>
                
                <div class="form-row-full">
                    <div class="form-group">
                        <label for="guardian2_address">Address</label>
                        <textarea id="guardian2_address" name="guardian2_address" rows="3"
                                  placeholder="For invoices and statements">{{ profile.guardian2_address if profile else '' }}</textarea>
                    </div>
                </div>
            </div>
            
            <!-- Validation Warning -->
            <div id="guardian-validation" style="display: none; background: #FEF2F2; border: 1px solid #FCA5A5; border-radius: 0.5rem; padding: 1rem; margin-top: 1rem;">
                <div style="color: #991B1B; font-weight: 600; margin-bottom: 0.5rem;">⚠️ Validation Error</div>
                <div id="guardian-validation-message" style="color: #7F1D1D; font-size: 0.875rem;"></div>
            </div>
        </div>
        
        <!-- Form Buttons (INSIDE form, OUTSIDE guardian-fields) -->
        <div style="display: flex; justify-content: space-between; margin-top: 2rem;">
            <a href="{{ url_for('client_file', client_id=client.id) }}" class="btn btn-secondary">Cancel</a>
            <button type="submit" class="btn">Save Profile</button>
        </div>
    </form>
</div>

<!-- Validation error modal -->
<div id="validation-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); z-index: 9999; align-items: center; justify-content: center;">
    <div style="background: white; padding: 2rem; border-radius: 0.5rem; max-width: 400px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); border-top: 4px solid #e53e3e;">
        <h3 style="color: #2d3748; margin-bottom: 1rem; font-size: 1.25rem; font-weight: 600;">Validation Error</h3>
        <div id="validation-errors" style="color: #4a5568; margin-bottom: 1.5rem; line-height: 1.6; font-size: 0.9375rem;"></div>
        <button onclick="closeValidationModal()" style="padding: 0.625rem 1.25rem; background: #00aa88; color: white; border: none; border-radius: 0.375rem; font-size: 0.9375rem; font-weight: 500; cursor: pointer; width: 100%;">
            OK
        </button>
    </div>
</div>


{% endblock %}