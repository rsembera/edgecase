{% extends "base.html" %}

{% block title %}Profile - {{ client.first_name }} {{ client.last_name }} - EdgeCase Equalizer{% endblock %}

{% block extra_css %}
<style>
    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
        margin-bottom: 1.5rem;
    }
    
    .form-row-full {
        margin-bottom: 1.5rem;
    }
    
    .form-row-thirds {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }
    
    @media (max-width: 768px) {
        .form-row, .form-row-thirds {
            grid-template-columns: 1fr;
        }
    }
    
    textarea {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid #e2e8f0;
        border-radius: 0.5rem;
        font-size: 1rem;
        font-family: inherit;
        min-height: 150px;
        transition: border-color 0.2s;
    }
    
    textarea:focus {
        outline: none;
        border-color: #00aa88;
    }
    
    .help-text {
        font-size: 0.875rem;
        color: #718096;
        margin-top: 0.25rem;
    }
    
    .date-input-group {
        display: flex;
        gap: 0.5rem;
    }
    
    .date-input-group select {
        flex: 1;
        height: 46px;  /* Match text input height */
    }
</style>
{% endblock %}

{% block content %}
<div class="card" style="max-width: 900px; margin: 0 auto;">
    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 2rem;">
        <div>
            <h2>Client Profile</h2>
            <p style="color: #718096;">
                <span class="type-badge" style="background-color: {{ client.type.color }}">
                    {{ client.type.name }}
                </span>
                {{ client.first_name }} {{ client.middle_name }} {{ client.last_name }}
            </p>
        </div>
        <a href="{{ url_for('client_file', client_id=client.id) }}" class="btn btn-secondary">Cancel</a>
    </div>
    
    <form method="post" id="profile-form">
        <div class="form-row">
            <div class="form-group">
                <label for="first_name">First Name</label>
                <input type="text" id="first_name" name="first_name" 
                       value="{{ client.first_name }}" readonly 
                       style="background: #f7fafc;">
            </div>
            
            <div class="form-group">
                <label for="middle_name">Middle Name</label>
                <input type="text" id="middle_name" name="middle_name" 
                       value="{{ client.middle_name or '' }}" readonly
                       style="background: #f7fafc;">
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="last_name">Last Name</label>
                <input type="text" id="last_name" name="last_name" 
                       value="{{ client.last_name }}" readonly
                       style="background: #f7fafc;">
            </div>
            
            <div class="form-group">
                <label for="file_number">File Number</label>
                <input type="text" id="file_number" name="file_number" 
                       value="{{ client.file_number }}" readonly
                       style="background: #f7fafc;">
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="date_of_birth">Date of Birth</label>
                <div class="date-input-group">
                    <select id="dob_year" name="dob_year">
                        <option value="">Year</option>
                        {% for year in range(2024, 1899, -1) %}
                        <option value="{{ year }}" {% if profile and profile.date_of_birth and profile.date_of_birth[:4] == year|string %}selected{% endif %}>{{ year }}</option>
                        {% endfor %}
                    </select>
                    <select id="dob_month" name="dob_month">
                        <option value="">Month</option>
                        {% for month in range(1, 13) %}
                        <option value="{{ '%02d'|format(month) }}" {% if profile and profile.date_of_birth and profile.date_of_birth[5:7] == '%02d'|format(month) %}selected{% endif %}>{{ '%02d'|format(month) }}</option>
                        {% endfor %}
                    </select>
                    <select id="dob_day" name="dob_day">
                        <option value="">Day</option>
                        {% for day in range(1, 32) %}
                        <option value="{{ '%02d'|format(day) }}" {% if profile and profile.date_of_birth and profile.date_of_birth[8:10] == '%02d'|format(day) %}selected{% endif %}>{{ '%02d'|format(day) }}</option>
                        {% endfor %}
                    </select>
                </div>
                <input type="hidden" id="date_of_birth" name="date_of_birth" value="{{ profile.date_of_birth if profile else '' }}">
            </div>
            
            <div class="form-group">
                <label for="gender">Gender</label>
                <input type="text" id="gender" name="gender" 
                       value="{{ profile.content if profile and profile.content else '' }}"
                       placeholder="Optional">
            </div>
        </div>
        
        <div class="form-row-full">
            <div class="form-group">
                <label for="address">Address</label>
                <input type="text" id="address" name="address" 
                       value="{{ profile.address if profile else '' }}"
                       placeholder="Street address">
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="email">Email</label>
                <input type="email" id="email" name="email" 
                       value="{{ profile.email if profile else '' }}">
            </div>
            
            <div class="form-group">
                <label for="phone">Cell</label>
                <input type="tel" id="phone" name="phone" 
                       value="{{ profile.phone if profile else '' }}"
                       placeholder="(613) 555-1234"
                       class="phone-input">
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="home_phone">Home Phone</label>
                <input type="tel" id="home_phone" name="home_phone" 
                       value="{{ profile.home_phone if profile else '' }}"
                       placeholder="(613) 555-1234"
                       class="phone-input">
            </div>
            
            <div class="form-group">
                <label for="work_phone">Work Phone</label>
                <input type="tel" id="work_phone" name="work_phone" 
                       value="{{ profile.work_phone if profile else '' }}"
                       placeholder="(613) 555-1234"
                       class="phone-input">
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="text_number">Text Number</label>
                <select id="text_number" name="text_number">
                    <option value="none" {% if not profile or not profile.text_number or profile.text_number == 'none' %}selected{% endif %}>None (no texting)</option>
                    <option value="cell" {% if profile and profile.text_number == 'cell' %}selected{% endif %}>Cell</option>
                    <option value="home" {% if profile and profile.text_number == 'home' %}selected{% endif %}>Home Phone</option>
                    <option value="work" {% if profile and profile.text_number == 'work' %}selected{% endif %}>Work Phone</option>
                </select>
                <p class="help-text">Which number to use for text messages</p>
            </div>
            
            <div class="form-group">
                <label for="ok_to_leave_message">OK to Leave Message?</label>
                <select id="ok_to_leave_message" name="ok_to_leave_message">
                    <option value="yes" {% if profile and profile.ok_to_leave_message == 'yes' %}selected{% endif %}>Yes</option>
                    <option value="no" {% if profile and profile.ok_to_leave_message == 'no' %}selected{% endif %}>No</option>
                </select>
            </div>
        </div>
        
        <div class="form-row-full">
            <div class="form-group">
                <label for="preferred_contact">Preferred Contact Method</label>
                <select id="preferred_contact" name="preferred_contact">
                    <option value="">Select...</option>
                    <option value="email" {% if profile and profile.preferred_contact == 'email' %}selected{% endif %}>Email</option>
                    <option value="call_cell" {% if profile and profile.preferred_contact == 'call_cell' %}selected{% endif %}>Call Cell</option>
                    <option value="call_home" {% if profile and profile.preferred_contact == 'call_home' %}selected{% endif %}>Call Home</option>
                    <option value="call_work" {% if profile and profile.preferred_contact == 'call_work' %}selected{% endif %}>Call Work</option>
                    <option value="text" {% if profile and profile.preferred_contact == 'text' %}selected{% endif %}>Text Message</option>
                </select>
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="emergency_contact_name">Emergency Contact Name</label>
                <input type="text" id="emergency_contact_name" name="emergency_contact_name" 
                       value="{{ profile.emergency_contact_name if profile else '' }}"
                       placeholder="Optional">
            </div>
            
            <div class="form-group">
                <label for="emergency_contact_phone">Emergency Contact Phone</label>
                <input type="tel" id="emergency_contact_phone" name="emergency_contact_phone" 
                       value="{{ profile.emergency_contact_phone if profile else '' }}"
                       placeholder="(613) 555-1234"
                       class="phone-input">
            </div>
        </div>
        
        <div class="form-row-full">
            <div class="form-group">
                <label for="emergency_contact_relationship">Emergency Contact Relationship</label>
                <input type="text" id="emergency_contact_relationship" name="emergency_contact_relationship" 
                       value="{{ profile.emergency_contact_relationship if profile else '' }}"
                       placeholder="e.g., Spouse, Parent, Friend">
            </div>
        </div>
        
        <div class="form-row-full">
            <div class="form-group">
                <label for="referral_source">How did you hear about this practice?</label>
                <input type="text" id="referral_source" name="referral_source" 
                       value="{{ profile.referral_source if profile else '' }}"
                       placeholder="e.g., Referral, Online search, Insurance directory">
            </div>
        </div>
        
        <div class="form-row-full">
            <div class="form-group">
                <label for="additional_info">Additional Information</label>
                <textarea id="additional_info" name="additional_info" 
                          placeholder="Any other relevant information about the client...">{{ profile.additional_info if profile else '' }}</textarea>
                <p class="help-text">Supports Markdown formatting</p>
            </div>
        </div>
        
        <div style="display: flex; gap: 1rem; margin-top: 2rem;">
            <button type="submit" class="btn">Save Profile</button>
            <a href="{{ url_for('client_file', client_id=client.id) }}" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>

<!-- Validation error modal -->
<div id="validation-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); z-index: 9999; align-items: center; justify-content: center;">
    <div style="background: white; padding: 2rem; border-radius: 0.5rem; max-width: 400px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); border-top: 4px solid #e53e3e;">
        <h3 style="color: #2d3748; margin-bottom: 1rem; font-size: 1.25rem; font-weight: 600;">Validation Error</h3>
        <div id="validation-errors" style="color: #4a5568; margin-bottom: 1.5rem; line-height: 1.6; font-size: 0.9375rem;"></div>
        <button onclick="closeValidationModal()" style="padding: 0.625rem 1.25rem; background: #00aa88; color: white; border: none; border-radius: 0.375rem; font-size: 0.9375rem; font-weight: 500; cursor: pointer; width: 100%;">
            OK
        </button>
    </div>
</div>

<script>
    // Validation modal functions
    function showValidationModal(message) {
        document.getElementById('validation-errors').innerHTML = message;
        document.getElementById('validation-modal').style.display = 'flex';
    }
    
    function closeValidationModal() {
        document.getElementById('validation-modal').style.display = 'none';
    }

    // Phone number auto-formatting (supports 10-12 digits)
    function formatPhoneNumber(value) {
        // Remove all non-digit characters
        let cleaned = value.replace(/\D/g, '');
        
        // Limit to 12 digits (international support)
        cleaned = cleaned.substring(0, 12);
        
        // Only format if exactly 10 digits (North American format)
        if (cleaned.length === 10) {
            return '(' + cleaned.substring(0, 3) + ') ' + cleaned.substring(3, 6) + '-' + cleaned.substring(6, 10);
        }
        
        // For 11-12 digits or incomplete, just return digits as-is
        return cleaned;
    }
    
    // Validate phone number has 10-12 digits
    function validatePhone(phoneValue) {
        if (!phoneValue) return true; // Empty is okay
        const digitsOnly = phoneValue.replace(/\D/g, '');
        return digitsOnly.length >= 10 && digitsOnly.length <= 12;
    }
    
    // Add event listeners to all phone inputs
    document.querySelectorAll('.phone-input').forEach(input => {
        if (input.value) {
            input.value = formatPhoneNumber(input.value);
        }
        
        input.addEventListener('input', function(e) {
            const cursorPos = this.selectionStart;
            const oldValue = this.value;
            const oldLength = oldValue.length;
            
            this.value = formatPhoneNumber(this.value);
            
            const newLength = this.value.length;
            if (newLength > oldLength) {
                this.setSelectionRange(cursorPos + (newLength - oldLength), cursorPos + (newLength - oldLength));
            } else {
                this.setSelectionRange(cursorPos, cursorPos);
            }
        });
    });
    
    // Form validation on submit
    let validationPassed = false;
    
    document.getElementById('profile-form').addEventListener('submit', function(e) {
        // If validation already passed, allow submission
        if (validationPassed) {
            validationPassed = false; // Reset for next time
            return true;
        }
        
        // Prevent default to validate first
        e.preventDefault();
        e.stopPropagation();
        
        const phoneInputs = [
            { element: document.getElementById('phone'), label: 'Cell' },
            { element: document.getElementById('home_phone'), label: 'Home Phone' },
            { element: document.getElementById('work_phone'), label: 'Work Phone' },
            { element: document.getElementById('emergency_contact_phone'), label: 'Emergency Contact Phone' }
        ];
        
        let errors = [];
        
        phoneInputs.forEach(input => {
            if (input.element.value && !validatePhone(input.element.value)) {
                errors.push('• ' + input.label + ' must be 10-12 digits');
                input.element.style.borderColor = '#e53e3e';
            } else {
                input.element.style.borderColor = '#e2e8f0';
            }
        });
        
        if (errors.length > 0) {
            showValidationModal(errors.join('<br>'));
            return false;
        } else {
            // Validation passed, submit the form
            validationPassed = true;
            this.submit();
        }
    });
    
    // Date of birth dropdowns → hidden field
    const dobYear = document.getElementById('dob_year');
    const dobMonth = document.getElementById('dob_month');
    const dobDay = document.getElementById('dob_day');
    const dobHidden = document.getElementById('date_of_birth');
    
    function updateDOB() {
        if (dobYear.value && dobMonth.value && dobDay.value) {
            dobHidden.value = `${dobYear.value}-${dobMonth.value}-${dobDay.value}`;
        } else {
            dobHidden.value = '';
        }
    }
    
    dobYear.addEventListener('change', updateDOB);
    dobMonth.addEventListener('change', updateDOB);
    dobDay.addEventListener('change', updateDOB);
</script>
{% endblock %}