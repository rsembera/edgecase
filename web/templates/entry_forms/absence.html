{% extends "base.html" %}

{% block title %}{% if entry %}Edit{% else %}Create{% endif %} Absence - EdgeCase Equalizer{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/absence.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/pickers.css') }}">
{% endblock %}

{% block content %}

<div class="card absence-card">
    <div class="entry-header">
        <div>
            <h2><i data-lucide="x-circle" class="page-icon"></i>Absence Entry</h2>
            <div class="text-muted">
                <div class="client-info-line">
                    <span class="type-badge" style="background-color: {{ client_type['color'] }}">
                        {{ client_type['name'] }}
                    </span>
                </div>
                <div class="client-info-line">
                    {{ client['first_name'] }} {% if client['middle_name'] %}{{ client['middle_name'] }}{% endif %} {{ client['last_name'] }}
                </div>
                <div>
                    File #{{ client['file_number'] }}
                </div>
            </div>
        </div>
    </div>
    
    <form method="POST">
        {% if is_billed %}
        <div class="billed-warning">
            <i data-lucide="alert-circle"></i>
            <span>This absence has been billed. Date and fee fields cannot be changed.</span>
        </div>
        {% endif %}
        
        <!-- Date and Time on same line -->
        <div class="two-column-grid">
            <div class="form-group {% if is_billed %}field-disabled{% endif %}">
                <label>Date *</label>
                <div id="absence-date-picker" {% if is_billed %}class="picker-disabled"{% endif %}></div>
                <input type="hidden" id="date" name="date" value="{% if entry %}{{ absence_date }}{% else %}{{ today }}{% endif %}" required>
            </div>
            
            <div class="form-group">
                <label>Time</label>
                <div id="absence-time-picker"></div>
                <input type="hidden" id="absence_time" name="absence_time" value="{{ entry.absence_time if entry else '' }}">
            </div>
        </div>
        
        <!-- Format dropdown for fee auto-load -->
        <div class="form-row-half">
            <div class="form-group {% if is_billed %}field-disabled{% endif %}">
                <label for="format">Missed Session Format</label>
                <select id="format" name="format" {% if is_billed %}disabled{% endif %}>
                    <option value="">Select to auto-load fee</option>
                    <option value="individual" {% if entry and entry.format == 'individual' %}selected{% endif %}>Individual</option>
                    <option value="couples" {% if entry and entry.format == 'couples' %}selected{% endif %}>Couples</option>
                    <option value="family" {% if entry and entry.format == 'family' %}selected{% endif %}>Family</option>
                    <option value="group" {% if entry and entry.format == 'group' %}selected{% endif %}>Group</option>
                </select>
                <p class="help-text">Select the format of missed session to auto-populate the cancellation fee</p>
            </div>
        </div>
        
        <!-- Description -->
        <div class="form-group">
            <label for="description">Description *</label>
            <input type="text" 
                   id="description" 
                   name="description" 
                   value="{{ entry.description if entry else '' }}"
                   placeholder="Brief summary (e.g., 'Cancelled - sick', 'No-show')"
                   required>
            <div class="helper-text">Short description that appears in the entry list</div>
        </div>
        
        <!-- Cancellation Fee -->
        <h3 class="section-heading">Cancellation Fee</h3>
        
        <div class="fee-grid">
            <div class="fee-field">
                <label for="base_fee">Base Price</label>
                <input type="number" id="base_fee" name="base_fee" 
                    step="0.01" min="0"
                    value="{{ '%.2f'|format(entry.base_fee) if entry and entry.base_fee else '0.00' }}"
                    placeholder="0.00"
                    oninput="calculateAbsenceFee('base')"
                    onblur="formatToTwoDecimals(this)" {% if is_billed %}disabled{% endif %}>
                <small>Before tax</small>
            </div>
            
            <div class="fee-field">
                <label for="tax_rate">Tax Rate</label>
                <input type="number" id="tax_rate" name="tax_rate" 
                    step="0.01" min="0" max="100"
                    value="{{ '%.2f'|format(entry.tax_rate) if entry and entry.tax_rate else '0.00' }}"
                    placeholder="0.00"
                    oninput="calculateAbsenceFee('tax')"
                    onblur="formatToTwoDecimals(this)" {% if is_billed %}disabled{% endif %}>
                <small>Percentage (%)</small>
            </div>
            
            <div class="fee-field">
                <label for="fee">Total</label>
                <input type="number" id="fee" name="fee" 
                    step="0.01" min="0"
                    value="{{ '%.2f'|format(entry.fee) if entry and entry.fee else '0.00' }}"
                    placeholder="0.00"
                    oninput="calculateAbsenceFee('total')"
                    onblur="formatToTwoDecimals(this)" {% if is_billed %}disabled{% endif %}>
                <small>With tax</small>
            </div>
        </div>
        <p class="helper-text fee-helper-text">
            <span id="fee-source"></span>
            Edit any two fields and the third will auto-calculate.
        </p>
        
        <!-- Content -->
        <div class="form-group">
            <label for="content">Notes</label>
            <textarea id="content" 
                      name="content" 
                      placeholder="Additional notes about the absence...">{{ entry.content if entry else '' }}</textarea>
            <div class="helper-text">
                Supports Markdown formatting.
            </div>
        </div>
        
        <!-- Edit History (only in edit mode) -->
        {% if is_edit %}
            {% include 'components/edit_history.html' %}
        {% endif %}
        
        <!-- Form Actions -->
        <div class="absence-form-actions">
            <a href="{{ url_for('clients.client_file', client_id=client['id']) }}" class="btn btn-secondary">Cancel</a>
            <button type="submit" class="btn">Save Absence</button>
        </div>
    </form>
    
    <!-- Missing Link Group Modal -->
    <div id="missing-link-modal" class="modal">
        <div class="modal-content missing-link-modal-content">
            <h3>Link Group Required</h3>
            <p id="missing-link-message"></p>
            <div class="missing-link-modal-actions">
                <a href="{{ url_for('links.manage_links') }}" class="btn btn-secondary">Go to Link Groups</a>
                <button onclick="closeMissingLinkModal()" class="btn">Stay Here</button>
            </div>
        </div>
    </div>
</div>

<!-- Data for JavaScript -->
<div id="absence-data" 
     data-is-edit="{% if is_edit %}true{% else %}false{% endif %}"
     data-is-billed="{% if is_billed %}true{% else %}false{% endif %}">
</div>

<script id="fee-sources-data" type="application/json">
{
    "profileFees": {{ profile_fees | tojson }},
    "linkGroups": {{ link_group_fees | tojson }}
}
</script>

{% block extra_js %}
<script src="{{ url_for('static', filename='js/pickers.js') }}"></script>
<script src="{{ url_for('static', filename='js/absence.js') }}"></script>
{% endblock %}

{% endblock %}
