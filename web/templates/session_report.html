{% extends "base.html" %}

{% block title %}Session Report - EdgeCase Equalizer{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/export.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/pickers.css') }}">
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/pickers.js') }}"></script>
{% endblock %}

{% block content %}
<div class="card card-narrow">
    <!-- Header -->
    <div class="export-header">
        <div>
            <h2><i data-lucide="file-bar-chart" class="page-icon"></i>Report</h2>
            <div class="text-muted">
                <div class="mb-1">
                    <span class="type-badge" style="background-color: {{ client_type.color }}">{{ client_type.name }}</span>
                </div>
                <div class="mb-1">
                    {{ client.first_name }} {{ client.middle_name or '' }} {{ client.last_name }}
                </div>
                <div>
                    File #{{ client.file_number }}
                </div>
            </div>
        </div>
        <a href="{{ url_for('clients.client_file', client_id=client.id) }}" class="btn">
            <i data-lucide="arrow-left" class="icon-btn"></i> Back
        </a>
    </div>
    
    <!-- Date Range -->
    <div class="export-options">
        <h3>Date Range</h3>
        
        <div class="form-row">
            <div class="form-group">
                <label>From</label>
                <div id="start-date-picker"></div>
                <input type="hidden" id="start_date" value="{{ today_year }}-01-01">
            </div>
            
            <div class="form-group">
                <label>To</label>
                <div id="end-date-picker"></div>
                <input type="hidden" id="end_date" value="{{ today_year }}-{{ '%02d'|format(today_month) }}-{{ '%02d'|format(today_day) }}">
            </div>
        </div>
    </div>
    
    <!-- Entry Types -->
    <div class="export-options">
        <h3>Include</h3>
        
        <div class="checkbox-group">
            <label class="checkbox-label">
                <input type="checkbox" id="include_sessions" checked>
                <span>Sessions</span>
            </label>
            <label class="checkbox-label">
                <input type="checkbox" id="include_items">
                <span>Items</span>
            </label>
            <label class="checkbox-label">
                <input type="checkbox" id="include_absences">
                <span>Absences</span>
            </label>
        </div>
        
        <p class="checkbox-hint">Select which entry types to include in the report.</p>
    </div>
    
    <!-- Options -->
    <div class="export-options">
        <h3>Options</h3>
        
        <div class="checkbox-group">
            <label class="checkbox-label">
                <input type="checkbox" id="include_fees" checked>
                <span>Include fees in report</span>
            </label>
        </div>
        
        <p class="checkbox-hint">Uncheck to generate an attendance record without financial information.</p>
    </div>
    
    <!-- Generate Button -->
    <div class="export-actions">
        <button type="button" class="btn" id="generate-btn">
            <i data-lucide="file-down" class="icon-btn"></i> Generate Report
        </button>
    </div>
</div>

<!-- Hidden data for JavaScript -->
<script id="report-data" type="application/json">
{
    "clientId": {{ client.id }},
    "todayYear": {{ today_year }},
    "todayMonth": {{ today_month }},
    "todayDay": {{ today_day }}
}
</script>

<script>
// Parse initial data
const reportData = JSON.parse(document.getElementById('report-data').textContent);

// Initialize date pickers when DOM is ready
function initReportPickers() {
    const startDateInput = document.getElementById('start_date');
    const endDateInput = document.getElementById('end_date');
    
    // Start date: January 1 of current year
    const startDate = new Date(reportData.todayYear, 0, 1);
    
    // End date: Today
    const endDate = new Date(reportData.todayYear, reportData.todayMonth - 1, reportData.todayDay);
    
    // Initialize start date picker
    const startContainer = document.getElementById('start-date-picker');
    if (startContainer) {
        new DatePicker(startContainer, {
            initialDate: startDate,
            onSelect: (date) => {
                const y = date.getFullYear();
                const m = (date.getMonth() + 1).toString().padStart(2, '0');
                const d = date.getDate().toString().padStart(2, '0');
                startDateInput.value = `${y}-${m}-${d}`;
            }
        });
    }
    
    // Initialize end date picker
    const endContainer = document.getElementById('end-date-picker');
    if (endContainer) {
        new DatePicker(endContainer, {
            initialDate: endDate,
            onSelect: (date) => {
                const y = date.getFullYear();
                const m = (date.getMonth() + 1).toString().padStart(2, '0');
                const d = date.getDate().toString().padStart(2, '0');
                endDateInput.value = `${y}-${m}-${d}`;
            }
        });
    }
}

// Generate report button handler
document.getElementById('generate-btn').addEventListener('click', function() {
    // Check at least one entry type is selected
    const includeSessions = document.getElementById('include_sessions').checked;
    const includeItems = document.getElementById('include_items').checked;
    const includeAbsences = document.getElementById('include_absences').checked;
    
    if (!includeSessions && !includeItems && !includeAbsences) {
        alert('Please select at least one entry type to include.');
        return;
    }
    
    // Open window immediately on user action (Safari popup blocker workaround)
    const pdfWindow = window.open('about:blank', '_blank');
    
    // Get dates from hidden inputs
    const startDate = document.getElementById('start_date').value;
    const endDate = document.getElementById('end_date').value;
    
    // Parse dates for URL params
    const [startYear, startMonth, startDay] = startDate.split('-');
    const [endYear, endMonth, endDay] = endDate.split('-');
    
    const params = new URLSearchParams();
    params.append('start_year', startYear);
    params.append('start_month', parseInt(startMonth));
    params.append('start_day', parseInt(startDay));
    params.append('end_year', endYear);
    params.append('end_month', parseInt(endMonth));
    params.append('end_day', parseInt(endDay));
    
    if (includeSessions) {
        params.append('include_sessions', 'on');
    }
    if (includeItems) {
        params.append('include_items', 'on');
    }
    if (includeAbsences) {
        params.append('include_absences', 'on');
    }
    if (document.getElementById('include_fees').checked) {
        params.append('include_fees', 'on');
    }
    
    const url = '{{ url_for("clients.session_report", client_id=client.id) }}?' + params.toString();
    pdfWindow.location.href = url;
});

// Initialize pickers when ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initReportPickers);
} else {
    initReportPickers();
}
</script>
{% endblock %}
