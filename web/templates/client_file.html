{% extends "base.html" %}

{% block title %}{{ client.first_name }} {{ client.last_name }} - EdgeCase Equalizer{% endblock %}

{% block extra_css %}
<style>
    /* Muted palette styling for client file view */
    .card {
        background: #FBFCFD;
        border-radius: 1rem;
        padding: 2rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    
    .type-badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        font-weight: 600;
        cursor: pointer;
        position: relative;
    }
    
    /* Dropdown styling (matches main_view.html) */
    .dropdown-btn {
        padding: 0.75rem 1.25rem;
        background: #FBFCFD;
        border: 2px solid #DEE2E6;
        border-radius: 0.75rem;
        font-size: 0.875rem;
        font-weight: 500;
        color: #323B45;
        cursor: pointer;
        transition: all 0.2s;
        position: relative;
    }
    
    .dropdown-btn:hover {
        border-color: #1F8F74;
        color: #1F8F74;
    }
    
    /* Profile entry styling */
    .profile-entry {
        padding: 1.5rem;
        background: #CFE7DA;
        border-radius: 1rem;
        margin-bottom: 2rem;
        border-left: 4px solid #1F8F74;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .profile-entry:hover {
        background: #BFDCDC;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    /* Year/Month headers */
    .year-header {
        background: #DEE2EA;
        color: #55607D;
        padding: 1rem 1.5rem;
        border-radius: 1rem;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        user-select: none;
        transition: all 0.2s;
    }
    
    .year-header:hover {
        background: #D4D9E3;
    }
    
    .month-header {
        background: #BFDCDC;
        color: #115D4F;
        padding: 0.75rem 1.5rem;
        border-radius: 0.75rem;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        user-select: none;
        transition: all 0.2s;
    }
    
    .month-header:hover {
        background: #9FCFC0;
    }
    
    /* Table styling */
    table {
        width: 100%;
        border-collapse: collapse;
        background: #FBFCFD;
        border-radius: 0.75rem;
        overflow: hidden;
        box-shadow: 0 1px 3px rgba(0,0,0,0.06);
        table-layout: fixed; /* Fixed table layout for consistent column widths */
    }
    
    /* Fixed column widths */
    th:nth-child(1), td:nth-child(1) { width: 10%; }  /* Date */
    th:nth-child(2), td:nth-child(2) { width: 15%; }  /* Class */
    th:nth-child(3), td:nth-child(3) { width: 35%; }  /* Description */
    th:nth-child(4), td:nth-child(4) { width: 10%; }  /* Time */
    th:nth-child(5), td:nth-child(5) { width: 15%; }  /* Details */
    th:nth-child(6), td:nth-child(6) { width: 15%; }  /* Info */
    
    thead tr {
        background: #E3E9EE;
        border-bottom: 2px solid #DEE2E6;
    }
    
    th {
        padding: 0.75rem 1rem;
        text-align: left;
        font-weight: 600;
        color: #55607D;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    
    td {
        padding: 0.75rem 1rem;
        border-bottom: 1px solid #E5E7EB;
        color: #323B45;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    /* Allow Date column to wrap (no truncation) */
    td:nth-child(1) {
        white-space: normal;
        word-wrap: break-word;
    }
    
    /* Allow Description column to wrap */
    td:nth-child(3) {
        white-space: normal;
        word-wrap: break-word;
    }
    
    /* Allow Time column to wrap */
    td:nth-child(4) {
        white-space: normal;
        word-wrap: break-word;
    }
    
    /* Allow Details column to wrap */
    td:nth-child(5) {
        white-space: normal;
        word-wrap: break-word;
    }
    
    tbody tr {
        border-bottom: 1px solid #DEE2E6;
        cursor: pointer;
        transition: background 0.2s;
    }
    
    tbody tr:hover {
        background: #F2F4F5;
    }
    
    td {
        padding: 0.75rem 1rem;
        font-size: 0.875rem;
        color: #323B45;
    }
    
    /* Session/Consultation badges */
    .session-badge {
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-weight: 500;
        font-size: 0.875rem;
    }
    
    .session-badge.consultation {
        background: #FAF0DF;
        color: #5A4823;
    }
    
    .session-badge.session {
        background: #CFE7DA;
        color: #0E5346;
    }
    
    /* Links */
    a.edit-link {
        color: #1F8F74;
        text-decoration: none;
        font-size: 0.875rem;
        font-weight: 500;
        transition: color 0.2s;
    }
    
    a.edit-link:hover {
        color: #16735F;
    }
    
    /* Empty state */
    .empty-state {
        padding: 3rem;
        text-align: center;
        background: #E3E9EE;
        border-radius: 1rem;
        margin-top: 1rem;
    }
</style>
{% endblock %}

{% block content %}

<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 2rem;">
        <div>
            <h2 style="color: #111827; margin-bottom: 0.5rem;">{{ client.first_name }} {{ client.middle_name }} {{ client.last_name }}</h2>
            <div style="color: #5B6571;">
                <div style="position: relative; display: inline-block;">
                    <span class="type-badge" 
                          style="background-color: {{ client.type.color }}"
                          onclick="event.stopPropagation(); toggleDropdown('type-dropdown')">
                        {{ client.type.name }}
                    </span>
                    <!-- Type change dropdown -->
                    <div id="type-dropdown" style="display: none; position: absolute; top: 100%; left: 0; margin-top: 0.5rem; background: white; border-radius: 0.75rem; box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 1rem; min-width: 200px; z-index: 100;">
                        <form method="post" action="{{ url_for('change_client_type', client_id=client.id) }}">
                            {% for type in all_types %}
                            <label style="display: block; padding: 0.5rem; cursor: pointer; border-radius: 0.5rem; {% if type.id == client.type_id %}font-weight: 600; background: #F3F4F6;{% endif %}" 
                                   onmouseover="if ({{ type.id }} != {{ client.type_id }}) this.style.background='#F3F4F6'" 
                                   onmouseout="if ({{ type.id }} != {{ client.type_id }}) this.style.background='transparent'">
                                <input type="radio" name="type_id" value="{{ type.id }}" 
                                       {% if type.id == client.type_id %}checked{% endif %}
                                       onchange="this.form.submit()"
                                       style="margin-right: 0.5rem;">
                                <span style="font-size: 0.875rem;">{{ type.name }}</span>
                            </label>
                            {% endfor %}
                        </form>
                    </div>
                </div>
                <br>
                <span style="display: inline-block; margin-top: 0.5rem;">File #{{ client.file_number }}</span>
            </div>
        </div>
        <div style="display: flex; gap: 1rem;">
            <a href="{{ url_for('create_session', client_id=client.id) }}" class="btn">+ Create Session</a>
            <a href="{{ url_for('create_communication', client_id=client.id) }}" class="btn">+ Create Communication</a>
            <a href="{{ url_for('create_absence', client_id=client.id) }}" class="btn">+ Create Absence</a>
            <a href="{{ url_for('create_item', client_id=client.id) }}" class="btn">+ Create Item</a>
            <a href="{{ url_for('index') }}" class="btn">‚Üê Back to Clients</a>
        </div>
    </div>
    
    {# Profile Entry - Always at top if exists #}
    {% if profile_entry %}
    <div class="profile-entry" onclick="window.location.href='{{ url_for('edit_profile', client_id=client.id) }}'">
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
            <strong style="font-size: 1.125rem; color: #0E5346;">Profile</strong>
        </div>
        
        {# Contact Information - matching main_view.html logic #}
        {% if profile_entry.email %}
        <p style="font-size: 0.875rem; color: #323B45; margin: 0.25rem 0;">
            üìß <a href="mailto:{{ profile_entry.email }}" 
                  style="color: #323B45; text-decoration: {% if profile_entry.preferred_contact == 'email' %}underline{% else %}none{% endif %};" 
                  onclick="event.stopPropagation();">{{ profile_entry.email }}</a>
        </p>
        {% endif %}
        
        {% if profile_entry.phone or profile_entry.home_phone or profile_entry.work_phone %}
        <p style="font-size: 0.875rem; color: #323B45; margin: 0.25rem 0;">
            {# Determine which phone to display and link type based on preferred_contact #}
            {% set display_phone = '' %}
            {% set link_type = 'tel' %}
            {% set is_preferred = false %}
            
            {% if profile_entry.preferred_contact == 'call_cell' %}
                {% set display_phone = profile_entry.phone %}
                {% set link_type = 'tel' %}
                {% set is_preferred = true %}
            {% elif profile_entry.preferred_contact == 'call_home' %}
                {% set display_phone = profile_entry.home_phone %}
                {% set link_type = 'tel' %}
                {% set is_preferred = true %}
            {% elif profile_entry.preferred_contact == 'call_work' %}
                {% set display_phone = profile_entry.work_phone %}
                {% set link_type = 'tel' %}
                {% set is_preferred = true %}
            {% elif profile_entry.preferred_contact == 'text' %}
                {% if profile_entry.text_number == 'cell' %}
                    {% set display_phone = profile_entry.phone %}
                {% elif profile_entry.text_number == 'home' %}
                    {% set display_phone = profile_entry.home_phone %}
                {% elif profile_entry.text_number == 'work' %}
                    {% set display_phone = profile_entry.work_phone %}
                {% else %}
                    {% set display_phone = profile_entry.phone %}
                {% endif %}
                {% set link_type = 'sms' %}
                {% set is_preferred = true %}
            {% else %}
                {# Default: show cell phone #}
                {% set display_phone = profile_entry.phone or profile_entry.home_phone or profile_entry.work_phone %}
                {% set link_type = 'tel' %}
            {% endif %}
            
            {% if display_phone %}
                {% if link_type == 'tel' %}üìû{% else %}üí¨{% endif %} 
                <a href="{{ link_type }}:{{ display_phone }}" 
                   style="color: #323B45; text-decoration: {% if is_preferred %}underline{% else %}none{% endif %};" 
                   onclick="event.stopPropagation();">{{ display_phone }}</a>
                {% if profile_entry.ok_to_leave_message == 'no' %} ‚ö†Ô∏è{% endif %}
            {% endif %}
        </p>
        {% endif %}
        
        <small style="color: #5B6571;">Created: {{ profile_entry.created_at|timestamp_to_date }}</small>
    </div>
    {% else %}
    {# No profile - make it clickable to create one #}
    <div class="profile-entry" onclick="window.location.href='{{ url_for('edit_profile', client_id=client.id) }}'" style="text-align: center;">
        <strong style="font-size: 1.125rem; color: #0E5346;">+ Create Profile</strong>
        <p style="font-size: 0.875rem; color: #5B6571; margin-top: 0.5rem;">Click to add client contact information</p>
    </div>
    {% endif %}
    
    <h3 style="color: #111827; margin-bottom: 1rem;">Session History 
        {% if session_count > 0 or consultation_count > 0 or absence_count > 0 %}
            ({{ session_count }} Session{{ 's' if session_count != 1 else '' }}{% if consultation_count > 0 %}, {{ consultation_count }} Consultation{{ 's' if consultation_count != 1 else '' }}{% endif %}{% if absence_count > 0 %}, {{ absence_count }} Absence{{ 's' if absence_count != 1 else '' }} this year{% endif %})
        {% endif %}
    </h3>
    
    <!-- Entry Class Filter -->
    <div style="background: #E3E9EE; border-radius: 1rem; padding: 1rem 1.5rem; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 1rem;">
        <div style="position: relative;">
            <button class="dropdown-btn" onclick="toggleDropdown('filter-dropdown')">
                Filter: {{ class_filter|length }} type{{ 's' if class_filter|length != 1 else '' }} ‚ñæ
            </button>
            <div id="filter-dropdown" style="display: none; position: absolute; top: 100%; left: 0; margin-top: 0.5rem; background: white; border-radius: 0.75rem; box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 1rem; min-width: 220px; z-index: 100;">
                <form id="filter-form" method="get">
                    <label style="display: block; padding: 0.5rem; cursor: pointer; border-radius: 0.5rem;" 
                           onmouseover="this.style.background='#F3F4F6'" 
                           onmouseout="this.style.background='transparent'">
                        <input type="checkbox" name="class" value="session" 
                               {% if 'session' in class_filter %}checked{% endif %}
                               onchange="document.getElementById('filter-form').submit()">
                        <span style="margin-left: 0.5rem; font-size: 0.875rem;">Session</span>
                    </label>
                    <label style="display: block; padding: 0.5rem; cursor: pointer; border-radius: 0.5rem;" 
                           onmouseover="this.style.background='#F3F4F6'" 
                           onmouseout="this.style.background='transparent'">
                        <input type="checkbox" name="class" value="consultation" 
                               {% if 'consultation' in class_filter %}checked{% endif %}
                               onchange="document.getElementById('filter-form').submit()">
                        <span style="margin-left: 0.5rem; font-size: 0.875rem;">Consultation</span>
                    </label>
                    <label style="display: block; padding: 0.5rem; cursor: pointer; border-radius: 0.5rem;" 
                           onmouseover="this.style.background='#F3F4F6'" 
                           onmouseout="this.style.background='transparent'">
                        <input type="checkbox" name="class" value="communication" 
                               {% if 'communication' in class_filter %}checked{% endif %}
                               onchange="document.getElementById('filter-form').submit()">
                        <span style="margin-left: 0.5rem; font-size: 0.875rem;">Communication</span>
                    </label>
                    <label style="display: block; padding: 0.5rem; cursor: pointer; border-radius: 0.5rem;" 
                           onmouseover="this.style.background='#F3F4F6'" 
                           onmouseout="this.style.background='transparent'">
                        <input type="checkbox" name="class" value="absence" 
                               {% if 'absence' in class_filter %}checked{% endif %}
                               onchange="document.getElementById('filter-form').submit()">
                        <span style="margin-left: 0.5rem; font-size: 0.875rem;">Absence</span>
                    </label>
                    <label style="display: block; padding: 0.5rem; cursor: pointer; border-radius: 0.5rem;" 
                           onmouseover="this.style.background='#F3F4F6'" 
                           onmouseout="this.style.background='transparent'">
                        <input type="checkbox" name="class" value="item" 
                               {% if 'item' in class_filter %}checked{% endif %}
                               onchange="document.getElementById('filter-form').submit()">
                        <span style="margin-left: 0.5rem; font-size: 0.875rem;">Item</span>
                    </label>
                </form>
            </div>
        </div>
        <span style="color: #5B6571; font-size: 0.875rem;">Show/hide entry types</span>
    </div>
    
    {% if entries_by_year %}
    <div style="margin-top: 1.5rem;">
        {% for year_group in entries_by_year %}
        <div class="year-section" style="margin-bottom: 1.5rem;">
            {# Year Header #}
            <div class="year-header" onclick="toggleYear('year-{{ year_group.year }}')">
                <span style="font-size: 1.125rem; font-weight: 600;">
                    <span id="year-{{ year_group.year }}-icon">{{ '‚ñº' if year_group.is_current else '‚ñ∂' }}</span>
                    {{ year_group.year }}
                </span>
                <span style="font-size: 0.875rem; opacity: 0.9;">{{ year_group.total }} Entries</span>
            </div>
            
            {# Year Content (collapsible) #}
            <div id="year-{{ year_group.year }}-content" 
                 style="{% if not year_group.is_current %}display: none;{% endif %}">
                
                {% for month_group in year_group.months %}
                <div class="month-section" style="margin-top: 1rem;">
                    {# Month Header #}
                    <div class="month-header"
                         onclick="toggleMonth('month-{{ year_group.year }}-{{ month_group.month_num }}')">
                        <span style="font-weight: 600;">
                            <span id="month-{{ year_group.year }}-{{ month_group.month_num }}-icon">{{ '‚ñº' if month_group.is_current else '‚ñ∂' }}</span>
                            {{ month_group.month_name }}
                        </span>
                        <span style="font-size: 0.875rem; opacity: 0.9;">{{ month_group.entries|length }} Entries</span>
                    </div>
                    
                    {# Month Content - Table #}
                    <div id="month-{{ year_group.year }}-{{ month_group.month_num }}-content"
                         style="{% if not month_group.is_current %}display: none;{% endif %} margin-top: 0.5rem;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Class</th>
                                    <th>Description</th>
                                    <th>Time</th>
                                    <th>Details</th>
                                    <th>Info</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for entry in month_group.entries %}
                                <tr onclick="window.location.href='{% if entry.class == 'session' %}{{ url_for('edit_session', client_id=client.id, entry_id=entry.id) }}{% elif entry.class == 'communication' %}{{ url_for('edit_communication', client_id=client.id, entry_id=entry.id) }}{% elif entry.class == 'absence' %}{{ url_for('edit_absence', client_id=client.id, entry_id=entry.id) }}{% elif entry.class == 'item' %}{{ url_for('edit_item', client_id=client.id, entry_id=entry.id) }}{% endif %}'">
                                    <td>
                                        {% if entry.class == 'session' %}
                                            {{ entry.session_date|timestamp_to_date }}
                                        {% elif entry.class == 'communication' %}
                                            {{ entry.comm_date|timestamp_to_date }}
                                        {% elif entry.class == 'absence' %}
                                            {{ entry.absence_date|timestamp_to_date }}
                                        {% elif entry.class == 'item' %}
                                            {{ entry.item_date|timestamp_to_date if entry.item_date else '-' }}
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if entry.class == 'session' %}
                                            <span class="session-badge {% if entry.is_consultation %}consultation{% else %}session{% endif %}">
                                                {% if entry.is_consultation %}Consultation{% else %}Session{% endif %}
                                            </span>
                                        {% elif entry.class == 'communication' %}
                                            <span class="session-badge" style="background: #DCD3E8; color: #3F3358;">
                                                Communication
                                            </span>
                                        {% elif entry.class == 'absence' %}
                                            <span class="session-badge" style="background: #E9CFCF; color: #6A243E;">
                                                Absence
                                            </span>
                                        {% elif entry.class == 'item' %}
                                            <span class="session-badge" style="background: #F5E6D3; color: #7A5C3E;">
                                                Item
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if entry.description|length > 50 %}
                                            {{ entry.description[:50] }}...
                                        {% else %}
                                            {{ entry.description }}
                                        {% endif %}
                                    </td>
                                    <td style="color: #5B6571;">
                                        {% if entry.class == 'session' %}
                                            {{ entry.session_time or '-' }}
                                        {% elif entry.class == 'communication' %}
                                            {{ entry.comm_time or '-' }}
                                        {% elif entry.class == 'absence' %}
                                            {{ entry.absence_time or '-' }}
                                        {% elif entry.class == 'item' %}
                                            {{ entry.item_time or '-' }}
                                        {% endif %}
                                    </td>
                                    <td style="color: #5B6571;">
                                        {% if entry.class == 'session' %}
                                            {{ entry.duration or '-' }} min
                                        {% elif entry.class == 'communication' %}
                                            {{ entry.comm_recipient|replace('_', ' ')|title if entry.comm_recipient else '-' }}
                                        {% elif entry.class == 'absence' %}
                                            -
                                        {% elif entry.class == 'item' %}
                                            {% if entry.base_price and entry.tax_rate %}
                                                ${{ "%.2f"|format(entry.base_price) }} + {{ "%.1f"|format(entry.tax_rate) }}% tax
                                            {% else %}
                                                -
                                            {% endif %}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td style="color: #5B6571;">
                                        {% if entry.class == 'session' and entry.fee %}
                                            ${{ "%.2f"|format(entry.fee) }}
                                        {% elif entry.class == 'communication' and entry.comm_type %}
                                            {{ entry.comm_type|capitalize }}
                                        {% elif entry.class == 'absence' %}
                                            ${{ "%.2f"|format(entry.fee) if entry.fee else '0.00' }}
                                        {% elif entry.class == 'item' %}
                                            ${{ "%.2f"|format(entry.fee) if entry.fee else '0.00' }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
        <p style="color: #5B6571; margin-bottom: 1rem;">No sessions yet. Create your first session to get started.</p>
        <a href="{{ url_for('create_session', client_id=client.id) }}" class="btn">+ Create Session</a>
    </div>
    {% endif %}
</div>

<script>
function toggleYear(yearId) {
    const content = document.getElementById(yearId + '-content');
    const icon = document.getElementById(yearId + '-icon');
    
    if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.textContent = '‚ñº';
    } else {
        content.style.display = 'none';
        icon.textContent = '‚ñ∂';
    }
}

function toggleMonth(monthId) {
    const content = document.getElementById(monthId + '-content');
    const icon = document.getElementById(monthId + '-icon');
    
    if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.textContent = '‚ñº';
    } else {
        content.style.display = 'none';
        icon.textContent = '‚ñ∂';
    }
}

// Dropdown toggle for filters and type selector
function toggleDropdown(dropdownId) {
    const dropdown = document.getElementById(dropdownId);
    const allDropdowns = document.querySelectorAll('[id$="-dropdown"]');
    
    // Close all other dropdowns
    allDropdowns.forEach(d => {
        if (d.id !== dropdownId) {
            d.style.display = 'none';
        }
    });
    
    // Toggle this dropdown (check for both 'none' and empty string)
    if (dropdown.style.display === 'none' || dropdown.style.display === '') {
        dropdown.style.display = 'block';
    } else {
        dropdown.style.display = 'none';
    }
}

// Close dropdowns when clicking outside
document.addEventListener('click', function(e) {
    if (!e.target.closest('.type-badge') && !e.target.closest('.dropdown-btn') && !e.target.closest('[id$="-dropdown"]')) {
        document.querySelectorAll('[id$="-dropdown"]').forEach(d => d.style.display = 'none');
    }
});
</script>

{% endblock %}