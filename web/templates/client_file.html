{% extends "base.html" %}

{% block title %}{{ client.first_name }} {{ client.last_name }} - EdgeCase Equalizer{% endblock %}

{% block extra_css %}
<style>
    /* Muted palette styling for client file view */
    .card {
        background: #FBFCFD;
        border-radius: 1rem;
        padding: 2rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    
    .type-badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        font-weight: 600;
    }
    
    /* Profile entry styling */
    .profile-entry {
        padding: 1.5rem;
        background: #CFE7DA;
        border-radius: 1rem;
        margin-bottom: 2rem;
        border-left: 4px solid #1F8F74;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .profile-entry:hover {
        background: #BFDCDC;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    /* Year/Month headers */
    .year-header {
        background: #DEE2EA;
        color: #55607D;
        padding: 1rem 1.5rem;
        border-radius: 1rem;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        user-select: none;
        transition: all 0.2s;
    }
    
    .year-header:hover {
        background: #D4D9E3;
    }
    
    .month-header {
        background: #BFDCDC;
        color: #115D4F;
        padding: 0.75rem 1.5rem;
        border-radius: 0.75rem;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        user-select: none;
        transition: all 0.2s;
    }
    
    .month-header:hover {
        background: #9FCFC0;
    }
    
    /* Table styling */
    table {
        width: 100%;
        border-collapse: collapse;
        background: #FBFCFD;
        border-radius: 0.75rem;
        overflow: hidden;
        box-shadow: 0 1px 3px rgba(0,0,0,0.06);
    }
    
    thead tr {
        background: #E3E9EE;
        border-bottom: 2px solid #DEE2E6;
    }
    
    th {
        padding: 0.75rem 1rem;
        text-align: left;
        font-weight: 600;
        color: #55607D;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    
    tbody tr {
        border-bottom: 1px solid #DEE2E6;
        cursor: pointer;
        transition: background 0.2s;
    }
    
    tbody tr:hover {
        background: #F2F4F5;
    }
    
    td {
        padding: 0.75rem 1rem;
        font-size: 0.875rem;
        color: #323B45;
    }
    
    /* Session/Consultation badges */
    .session-badge {
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-weight: 500;
        font-size: 0.875rem;
    }
    
    .session-badge.consultation {
        background: #FAF0DF;
        color: #5A4823;
    }
    
    .session-badge.session {
        background: #CFE7DA;
        color: #0E5346;
    }
    
    /* Links */
    a.edit-link {
        color: #1F8F74;
        text-decoration: none;
        font-size: 0.875rem;
        font-weight: 500;
        transition: color 0.2s;
    }
    
    a.edit-link:hover {
        color: #16735F;
    }
    
    /* Empty state */
    .empty-state {
        padding: 3rem;
        text-align: center;
        background: #E3E9EE;
        border-radius: 1rem;
        margin-top: 1rem;
    }
</style>
{% endblock %}

{% block content %}

<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 2rem;">
        <div>
            <h2 style="color: #111827; margin-bottom: 0.5rem;">{{ client.first_name }} {{ client.middle_name }} {{ client.last_name }}</h2>
            <p style="color: #5B6571;">
                <span class="type-badge" style="background-color: {{ client.type.color }}">
                    {{ client.type.name }}
                </span>
                File {{ client.file_number }}
            </p>
        </div>
        <div style="display: flex; gap: 1rem;">
            <a href="{{ url_for('create_session', client_id=client.id) }}" class="btn">+ Create Session</a>
            <a href="{{ url_for('index') }}" class="btn">‚Üê Back to Clients</a>
        </div>
    </div>
    
    {# Profile Entry - Always at top if exists #}
    {% if profile_entry %}
    <div class="profile-entry" onclick="window.location.href='{{ url_for('edit_profile', client_id=client.id) }}'">
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
            <strong style="font-size: 1.125rem; color: #0E5346;">Profile</strong>
        </div>
        
        {# Contact Information - matching main_view.html logic #}
        {% if profile_entry.email %}
        <p style="font-size: 0.875rem; color: #323B45; margin: 0.25rem 0;">
            üìß <a href="mailto:{{ profile_entry.email }}" 
                  style="color: #323B45; text-decoration: {% if profile_entry.preferred_contact == 'email' %}underline{% else %}none{% endif %};" 
                  onclick="event.stopPropagation();">{{ profile_entry.email }}</a>
        </p>
        {% endif %}
        
        {% if profile_entry.phone or profile_entry.home_phone or profile_entry.work_phone %}
        <p style="font-size: 0.875rem; color: #323B45; margin: 0.25rem 0;">
            {# Determine which phone to display and link type based on preferred_contact #}
            {% set display_phone = '' %}
            {% set link_type = 'tel' %}
            {% set is_preferred = false %}
            
            {% if profile_entry.preferred_contact == 'call_cell' %}
                {% set display_phone = profile_entry.phone %}
                {% set link_type = 'tel' %}
                {% set is_preferred = true %}
            {% elif profile_entry.preferred_contact == 'call_home' %}
                {% set display_phone = profile_entry.home_phone %}
                {% set link_type = 'tel' %}
                {% set is_preferred = true %}
            {% elif profile_entry.preferred_contact == 'call_work' %}
                {% set display_phone = profile_entry.work_phone %}
                {% set link_type = 'tel' %}
                {% set is_preferred = true %}
            {% elif profile_entry.preferred_contact == 'text' %}
                {% if profile_entry.text_number == 'cell' %}
                    {% set display_phone = profile_entry.phone %}
                {% elif profile_entry.text_number == 'home' %}
                    {% set display_phone = profile_entry.home_phone %}
                {% elif profile_entry.text_number == 'work' %}
                    {% set display_phone = profile_entry.work_phone %}
                {% else %}
                    {% set display_phone = profile_entry.phone %}
                {% endif %}
                {% set link_type = 'sms' %}
                {% set is_preferred = true %}
            {% else %}
                {# Default: show cell phone #}
                {% set display_phone = profile_entry.phone or profile_entry.home_phone or profile_entry.work_phone %}
                {% set link_type = 'tel' %}
            {% endif %}
            
            {% if display_phone %}
                {% if link_type == 'tel' %}üìû{% else %}üí¨{% endif %} 
                <a href="{{ link_type }}:{{ display_phone }}" 
                   style="color: #323B45; text-decoration: {% if is_preferred %}underline{% else %}none{% endif %};" 
                   onclick="event.stopPropagation();">{{ display_phone }}</a>
                {% if profile_entry.ok_to_leave_message == 'no' %} ‚ö†Ô∏è{% endif %}
            {% endif %}
        </p>
        {% endif %}
        
        <small style="color: #5B6571;">Created: {{ profile_entry.created_at|timestamp_to_date }}</small>
    </div>
    {% else %}
    {# No profile - make it clickable to create one #}
    <div class="profile-entry" onclick="window.location.href='{{ url_for('edit_profile', client_id=client.id) }}'" style="text-align: center;">
        <strong style="font-size: 1.125rem; color: #0E5346;">+ Create Profile</strong>
        <p style="font-size: 0.875rem; color: #5B6571; margin-top: 0.5rem;">Click to add client contact information</p>
    </div>
    {% endif %}
    
    <h3 style="color: #111827; margin-bottom: 1rem;">Session History 
        {% if session_count > 0 or consultation_count > 0 %}
            ({{ session_count }} Session{{ 's' if session_count != 1 else '' }}{% if consultation_count > 0 %}, {{ consultation_count }} Consultation{{ 's' if consultation_count != 1 else '' }}{% endif %})
        {% endif %}
    </h3>
    
    {% if entries_by_year %}
    <div style="margin-top: 1.5rem;">
        {% for year_group in entries_by_year %}
        <div class="year-section" style="margin-bottom: 1.5rem;">
            {# Year Header #}
            <div class="year-header" onclick="toggleYear('year-{{ year_group.year }}')">
                <span style="font-size: 1.125rem; font-weight: 600;">
                    <span id="year-{{ year_group.year }}-icon">{{ '‚ñº' if year_group.is_current else '‚ñ∂' }}</span>
                    {{ year_group.year }}
                </span>
                <span style="font-size: 0.875rem; opacity: 0.9;">{{ year_group.total }} Entries</span>
            </div>
            
            {# Year Content (collapsible) #}
            <div id="year-{{ year_group.year }}-content" 
                 style="{% if not year_group.is_current %}display: none;{% endif %}">
                
                {% for month_group in year_group.months %}
                <div class="month-section" style="margin-top: 1rem;">
                    {# Month Header #}
                    <div class="month-header"
                         onclick="toggleMonth('month-{{ year_group.year }}-{{ month_group.month_num }}')">
                        <span style="font-weight: 600;">
                            <span id="month-{{ year_group.year }}-{{ month_group.month_num }}-icon">{{ '‚ñº' if month_group.is_current else '‚ñ∂' }}</span>
                            {{ month_group.month_name }}
                        </span>
                        <span style="font-size: 0.875rem; opacity: 0.9;">{{ month_group.entries|length }} Entries</span>
                    </div>
                    
                    {# Month Content - Table #}
                    <div id="month-{{ year_group.year }}-{{ month_group.month_num }}-content"
                         style="{% if not month_group.is_current %}display: none;{% endif %} margin-top: 0.5rem;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Type</th>
                                    <th>Description</th>
                                    <th>Time</th>
                                    <th>Duration</th>
                                    <th>Fee</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for entry in month_group.entries %}
                                <tr onclick="window.location.href='{{ url_for('edit_session', client_id=client.id, entry_id=entry.id) }}'">
                                    <td>{{ entry.session_date|timestamp_to_date }}</td>
                                    <td>
                                        <span class="session-badge {% if entry.is_consultation %}consultation{% else %}session{% endif %}">
                                            {% if entry.is_consultation %}Consultation{% else %}Session{% endif %}
                                        </span>
                                    </td>
                                    <td>{{ entry.description }}</td>
                                    <td style="color: #5B6571;">{{ entry.session_time or '-' }}</td>
                                    <td style="color: #5B6571;">{{ entry.duration or '-' }} min</td>
                                    <td style="color: #5B6571;">
                                        {% if entry.fee %}${{ "%.2f"|format(entry.fee) }}{% else %}-{% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
        <p style="color: #5B6571; margin-bottom: 1rem;">No sessions yet. Create your first session to get started.</p>
        <a href="{{ url_for('create_session', client_id=client.id) }}" class="btn">+ Create Session</a>
    </div>
    {% endif %}
</div>

<script>
function toggleYear(yearId) {
    const content = document.getElementById(yearId + '-content');
    const icon = document.getElementById(yearId + '-icon');
    
    if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.textContent = '‚ñº';
    } else {
        content.style.display = 'none';
        icon.textContent = '‚ñ∂';
    }
}

function toggleMonth(monthId) {
    const content = document.getElementById(monthId + '-content');
    const icon = document.getElementById(monthId + '-icon');
    
    if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.textContent = '‚ñº';
    } else {
        content.style.display = 'none';
        icon.textContent = '‚ñ∂';
    }
}
</script>

{% endblock %}