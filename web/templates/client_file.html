{% extends "base.html" %}

{% block title %}{{ client.first_name }} {{ client.last_name }} - EdgeCase Equalizer{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/client_file.css') }}">
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/client_file.js') }}"></script>
{% endblock %}

{% block content %}

<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 2rem;">
        <div>
            <h2 style="color: #111827; margin-bottom: 0.5rem;">{{ client.first_name }} {{ client.middle_name }} {{ client.last_name }}</h2>
            <div style="color: #5B6571;">
                <div style="position: relative; display: inline-block;">
                    <span class="type-badge" 
                          style="background-color: {{ client.type.color }}"
                          onclick="event.stopPropagation(); toggleDropdown('type-dropdown')">
                        {{ client.type.name }}
                    </span>
                    <!-- Type change dropdown -->
                    <div id="type-dropdown" style="display: none; position: absolute; top: 100%; left: 0; margin-top: 0.5rem; background: white; border-radius: 0.75rem; box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 1rem; min-width: 200px; z-index: 100;">
                        <form method="post" action="{{ url_for('change_client_type', client_id=client.id) }}">
                            {% for type in all_types %}
                            <label style="display: block; padding: 0.5rem; cursor: pointer; border-radius: 0.5rem; {% if type.id == client.type_id %}font-weight: 600; background: #F3F4F6;{% endif %}" 
                                   onmouseover="if ({{ type.id }} != {{ client.type_id }}) this.style.background='#F3F4F6'" 
                                   onmouseout="if ({{ type.id }} != {{ client.type_id }}) this.style.background='transparent'">
                                <input type="radio" name="type_id" value="{{ type.id }}" 
                                       {% if type.id == client.type_id %}checked{% endif %}
                                       onchange="this.form.submit()"
                                       style="margin-right: 0.5rem;">
                                <span style="font-size: 0.875rem;">{{ type.name }}</span>
                            </label>
                            {% endfor %}
                        </form>
                    </div>
                </div>
                <br>
                <span style="display: inline-block; margin-top: 0.5rem;">File #{{ client.file_number }}</span>
            </div>
        </div>
        <a href="{{ url_for('index') }}" class="btn">‚Üê Back to Clients</a>
    </div>
    
    {# Profile Entry - Always at top if exists #}
    {% if profile_entry %}
    <div class="profile-entry" onclick="window.location.href='{{ url_for('edit_profile', client_id=client.id) }}'">
        <div style="display: flex; align-items: center; gap: 0.5rem;">
            <strong style="font-size: 1.125rem; color: #0E5346;">Profile</strong>
            
            {# Fee Override Badge #}
            {% if profile_entry.fee_override_total %}
            <span style="background: #FEF3C7; color: #92400E; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 600;">
                üí∞ Fee Override
            </span>
            {% endif %}
            
            {# Minor Badge #}
            {% if profile_entry.is_minor %}
            <span style="background: #DBEAFE; color: #1E40AF; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 600;">
                üë∂ Minor
            </span>
            {% endif %}
        </div>
        
        {# Contact Information - matching main_view.html logic #}
        {% if profile_entry.email %}
        <p style="font-size: 0.875rem; color: #323B45; margin: 0.25rem 0;">
            üìß <a href="mailto:{{ profile_entry.email }}" 
                  style="color: #323B45; text-decoration: {% if profile_entry.preferred_contact == 'email' %}underline{% else %}none{% endif %};" 
                  onclick="event.stopPropagation();">{{ profile_entry.email }}</a>
        </p>
        {% endif %}
        
        {% if profile_entry.phone or profile_entry.home_phone or profile_entry.work_phone %}
        <p style="font-size: 0.875rem; color: #323B45; margin: 0.25rem 0;">
            {# Determine which phone to display and link type based on preferred_contact #}
            {% set display_phone = '' %}
            {% set link_type = 'tel' %}
            {% set is_preferred = false %}
            
            {% if profile_entry.preferred_contact == 'call_cell' %}
                {% set display_phone = profile_entry.phone %}
                {% set link_type = 'tel' %}
                {% set is_preferred = true %}
            {% elif profile_entry.preferred_contact == 'call_home' %}
                {% set display_phone = profile_entry.home_phone %}
                {% set link_type = 'tel' %}
                {% set is_preferred = true %}
            {% elif profile_entry.preferred_contact == 'call_work' %}
                {% set display_phone = profile_entry.work_phone %}
                {% set link_type = 'tel' %}
                {% set is_preferred = true %}
            {% elif profile_entry.preferred_contact == 'text' %}
                {% if profile_entry.text_number == 'cell' %}
                    {% set display_phone = profile_entry.phone %}
                {% elif profile_entry.text_number == 'home' %}
                    {% set display_phone = profile_entry.home_phone %}
                {% elif profile_entry.text_number == 'work' %}
                    {% set display_phone = profile_entry.work_phone %}
                {% else %}
                    {% set display_phone = profile_entry.phone %}
                {% endif %}
                {% set link_type = 'sms' %}
                {% set is_preferred = true %}
            {% else %}
                {# Default: show cell phone #}
                {% set display_phone = profile_entry.phone or profile_entry.home_phone or profile_entry.work_phone %}
                {% set link_type = 'tel' %}
            {% endif %}
            
            {% if display_phone %}
                {% if link_type == 'tel' %}üìû{% else %}üí¨{% endif %} 
                <a href="{{ link_type }}:{{ display_phone }}" 
                   style="color: #323B45; text-decoration: {% if is_preferred %}underline{% else %}none{% endif %};" 
                   onclick="event.stopPropagation();">{{ display_phone }}</a>
                {% if profile_entry.ok_to_leave_message == 'no' %} ‚ö†Ô∏è{% endif %}
            {% endif %}
        </p>
        {% endif %}
        
        <small style="color: #5B6571;">Created: {{ profile_entry.created_at|timestamp_to_date }}</small>
    </div>
    {% else %}
    {# No profile - make it clickable to create one #}
    <div class="profile-entry" onclick="window.location.href='{{ url_for('edit_profile', client_id=client.id) }}'" style="text-align: center;">
        <strong style="font-size: 1.125rem; color: #0E5346;">+ Create Profile</strong>
        <p style="font-size: 0.875rem; color: #5B6571; margin-top: 0.5rem;">Click to add client contact information</p>
    </div>
    {% endif %}

    {# Linked Clients Section - NEW #}
    {% if linked_groups %}
    <div style="margin: 1.5rem 0;">
        <h4 style="color: #111827; font-size: 1rem; margin-bottom: 0.75rem;">Linked Clients</h4>
        
        {% for group in linked_groups %}
        <div style="background: #F9FAFB; border-radius: 0.75rem; padding: 1rem; margin-bottom: 1rem; border-left: 4px solid #9FCFC0;">
            <div style="font-weight: 600; color: #374151; margin-bottom: 0.75rem; font-size: 0.875rem;">
                {{ group.format_display }} Group
            </div>
            
            <div style="display: flex; flex-wrap: wrap; gap: 0.75rem;">
                {% for member in group.members %}
                <a href="{{ url_for('client_file', client_id=member.id) }}" 
                   class="linked-client-card"
                   onclick="event.stopPropagation();">
                    <span class="type-badge" 
                          style="background-color: {{ member.type.color }}; font-size: 0.75rem; padding: 0.25rem 0.5rem;">
                        {{ member.type.name }}
                    </span>
                    <div style="margin-top: 0.25rem;">
                        <div style="font-weight: 600; font-size: 0.875rem; color: #111827;">
                            {{ member.first_name }} 
                            {% if member.middle_name %}{{ member.middle_name[0] }}.{% endif %} 
                            {{ member.last_name }}
                        </div>
                        <div style="font-size: 0.75rem; color: #6B7280; margin-top: 0.125rem;">
                            #{{ member.file_number }}
                        </div>
                    </div>
                </a>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    {# End Linked Clients Section #}
    
    <h3 style="color: #111827; margin-bottom: 1rem;">Session History 
        {% if session_count > 0 or consultation_count > 0 or absence_count > 0 %}
            ({{ session_count }} Session{{ 's' if session_count != 1 else '' }}{% if consultation_count > 0 %}, {{ consultation_count }} Consultation{{ 's' if consultation_count != 1 else '' }}{% endif %}{% if absence_count > 0 %}, {{ absence_count }} Absence{{ 's' if absence_count != 1 else '' }} this year{% endif %})
        {% endif %}
    </h3>
    
    <!-- Entry Class Filter -->
    <div style="background: #E3E9EE; border-radius: 1rem; padding: 1rem 1.5rem; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 1rem;">
        <div style="position: relative;">
            <button class="dropdown-btn" id="class-filter-button" onclick="toggleDropdown('filter-dropdown')">
                Filter: {{ class_filter|length }} type{{ 's' if class_filter|length != 1 else '' }} ‚ñæ
            </button>
            <div id="filter-dropdown" style="display: none; position: absolute; top: 100%; left: 0; margin-top: 0.5rem; background: white; border-radius: 0.75rem; box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 1rem; min-width: 220px; z-index: 100;">
                <div id="filter-form">
                    <label style="display: block; padding: 0.5rem; cursor: pointer; border-radius: 0.5rem;" 
                        onmouseover="this.style.background='#F3F4F6'" 
                        onmouseout="this.style.background='transparent'">
                        <input type="checkbox" name="class" value="session" 
                            {% if 'session' in class_filter %}checked{% endif %}>
                        <span style="margin-left: 0.5rem; font-size: 0.875rem;">Session</span>
                    </label>
                    <label style="display: block; padding: 0.5rem; cursor: pointer; border-radius: 0.5rem;" 
                        onmouseover="this.style.background='#F3F4F6'" 
                        onmouseout="this.style.background='transparent'">
                        <input type="checkbox" name="class" value="consultation" 
                            {% if 'consultation' in class_filter %}checked{% endif %}>
                        <span style="margin-left: 0.5rem; font-size: 0.875rem;">Consultation</span>
                    </label>
                    <label style="display: block; padding: 0.5rem; cursor: pointer; border-radius: 0.5rem;" 
                        onmouseover="this.style.background='#F3F4F6'" 
                        onmouseout="this.style.background='transparent'">
                        <input type="checkbox" name="class" value="communication" 
                            {% if 'communication' in class_filter %}checked{% endif %}>
                        <span style="margin-left: 0.5rem; font-size: 0.875rem;">Communication</span>
                    </label>
                    <label style="display: block; padding: 0.5rem; cursor: pointer; border-radius: 0.5rem;" 
                        onmouseover="this.style.background='#F3F4F6'" 
                        onmouseout="this.style.background='transparent'">
                        <input type="checkbox" name="class" value="absence" 
                            {% if 'absence' in class_filter %}checked{% endif %}>
                        <span style="margin-left: 0.5rem; font-size: 0.875rem;">Absence</span>
                    </label>
                    <label style="display: block; padding: 0.5rem; cursor: pointer; border-radius: 0.5rem;" 
                        onmouseover="this.style.background='#F3F4F6'" 
                        onmouseout="this.style.background='transparent'">
                        <input type="checkbox" name="class" value="item" 
                            {% if 'item' in class_filter %}checked{% endif %}>
                        <span style="margin-left: 0.5rem; font-size: 0.875rem;">Item</span>
                    </label>
                </div>
            </div>
        </div>
        
        <!-- Search Box -->
        <div class="entry-search-box" style="position: relative; flex: 1; max-width: 400px;">
            <input type="text" 
                id="entry-search" 
                placeholder="Search entries..." 
                style="width: 100%; padding: 0.75rem 2.5rem 0.75rem 2.5rem; border: 2px solid #DEE2E6; border-radius: 0.75rem; font-size: 0.875rem;">
            <span style="position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); font-size: 1rem;">üîç</span>
            <button type="button" 
                    id="clear-entry-search" 
                    style="display: none; position: absolute; right: 0.75rem; top: 50%; transform: translateY(-50%); background: none; border: none; color: #9CA3AF; font-size: 1.25rem; cursor: pointer; padding: 0.25rem 0.5rem;">‚úï</button>
        </div>
        
        <!-- Action Buttons (right-aligned) -->
        <div style="margin-left: auto; display: flex; gap: 1rem; flex-wrap: wrap;">
            <a href="{{ url_for('create_session', client_id=client.id) }}" class="btn">+ Session</a>
            <a href="{{ url_for('create_communication', client_id=client.id) }}" class="btn">+ Communication</a>
            <a href="{{ url_for('create_absence', client_id=client.id) }}" class="btn">+ Absence</a>
            <a href="{{ url_for('create_item', client_id=client.id) }}" class="btn">+ Item</a>
        </div>
    </div>
    
    {% if entries_by_year %}
    <div style="margin-top: 1.5rem;">
        {% for year_group in entries_by_year %}
        <div class="year-section" style="margin-bottom: 1.5rem;">
            {# Year Header #}
            <div class="year-header" onclick="toggleYear('year-{{ year_group.year }}')">
                <span style="font-size: 1.125rem; font-weight: 600;">
                    <span id="year-{{ year_group.year }}-icon">{{ '‚ñº' if year_group.is_current else '‚ñ∂' }}</span>
                    {{ year_group.year }}
                </span>
                <span style="font-size: 0.875rem; opacity: 0.9;">{{ year_group.total }} Entries</span>
            </div>
            
            {# Year Content (collapsible) #}
            <div id="year-{{ year_group.year }}-content" 
                 style="{% if not year_group.is_current %}display: none;{% endif %}">
                
                {% for month_group in year_group.months %}
                <div class="month-section" style="margin-top: 1rem;">
                    {# Month Header #}
                    <div class="month-header"
                         onclick="toggleMonth('month-{{ year_group.year }}-{{ month_group.month_num }}')">
                        <span style="font-weight: 600;">
                            <span id="month-{{ year_group.year }}-{{ month_group.month_num }}-icon">{{ '‚ñº' if month_group.is_current else '‚ñ∂' }}</span>
                            {{ month_group.month_name }}
                        </span>
                        <span style="font-size: 0.875rem; opacity: 0.9;">{{ month_group.entries|length }} Entries</span>
                    </div>
                    
                    {# Month Content - Table #}
                    <div id="month-{{ year_group.year }}-{{ month_group.month_num }}-content"
                         style="{% if not month_group.is_current %}display: none;{% endif %} margin-top: 0.5rem;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Class</th>
                                    <th>Description</th>
                                    <th>Time</th>
                                    <th>Details</th>
                                    <th>Info</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for entry in month_group.entries %}
                                <tr onclick="window.location.href='{% if entry.class == 'session' %}{{ url_for('edit_session', client_id=client.id, entry_id=entry.id) }}{% elif entry.class == 'communication' %}{{ url_for('edit_communication', client_id=client.id, entry_id=entry.id) }}{% elif entry.class == 'absence' %}{{ url_for('edit_absence', client_id=client.id, entry_id=entry.id) }}{% elif entry.class == 'item' %}{{ url_for('edit_item', client_id=client.id, entry_id=entry.id) }}{% endif %}'" 
                                    data-description="{{ entry.description|e }}" 
                                    data-content="{{ entry.content|e if entry.content else '' }}">
                                    <td>
                                        {% if entry.class == 'session' %}
                                            {{ entry.session_date|timestamp_to_date }}
                                        {% elif entry.class == 'communication' %}
                                            {{ entry.comm_date|timestamp_to_date }}
                                        {% elif entry.class == 'absence' %}
                                            {{ entry.absence_date|timestamp_to_date }}
                                        {% elif entry.class == 'item' %}
                                            {{ entry.item_date|timestamp_to_date if entry.item_date else '-' }}
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if entry.class == 'session' %}
                                            <span class="session-badge {% if entry.is_consultation %}consultation{% else %}session{% endif %}">
                                                {% if entry.is_consultation %}Consultation{% else %}Session{% endif %}
                                            </span>
                                        {% elif entry.class == 'communication' %}
                                            <span class="session-badge" style="background: #DCD3E8; color: #3F3358;">
                                                Communication
                                            </span>
                                        {% elif entry.class == 'absence' %}
                                            <span class="session-badge" style="background: #E9CFCF; color: #6A243E;">
                                                Absence
                                            </span>
                                        {% elif entry.class == 'item' %}
                                            <span class="session-badge" style="background: #F5E6D3; color: #7A5C3E;">
                                                Item
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if entry.description|length > 50 %}
                                            {{ entry.description[:50] }}...
                                        {% else %}
                                            {{ entry.description }}
                                        {% endif %}
                                    </td>
                                    <td style="color: #5B6571;">
                                        {% if entry.class == 'session' %}
                                            {{ entry.session_time or '-' }}
                                        {% elif entry.class == 'communication' %}
                                            {{ entry.comm_time or '-' }}
                                        {% elif entry.class == 'absence' %}
                                            {{ entry.absence_time or '-' }}
                                        {% elif entry.class == 'item' %}
                                            {{ entry.item_time or '-' }}
                                        {% endif %}
                                    </td>
                                    <td style="color: #5B6571;">
                                        {% if entry.class == 'session' %}
                                            {{ entry.duration or '-' }} min
                                        {% elif entry.class == 'communication' %}
                                            {{ entry.comm_recipient|replace('_', ' ')|title if entry.comm_recipient else '-' }}
                                        {% elif entry.class == 'absence' %}
                                            -
                                        {% elif entry.class == 'item' %}
                                            {% if entry.base_price and entry.tax_rate %}
                                                ${{ "%.2f"|format(entry.base_price) }} + {{ "%.1f"|format(entry.tax_rate) }}% tax
                                            {% else %}
                                                -
                                            {% endif %}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td style="color: #5B6571;">
                                        {% if entry.class == 'session' and entry.fee %}
                                            ${{ "%.2f"|format(entry.fee) }}
                                        {% elif entry.class == 'communication' and entry.comm_type %}
                                            {{ entry.comm_type|capitalize }}
                                        {% elif entry.class == 'absence' %}
                                            ${{ "%.2f"|format(entry.fee) if entry.fee else '0.00' }}
                                        {% elif entry.class == 'item' %}
                                            ${{ "%.2f"|format(entry.fee) if entry.fee else '0.00' }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
        <p style="color: #5B6571; margin-bottom: 1rem;">No Entries yet.</p>
    </div>
    {% endif %}
</div>

{% endblock %}