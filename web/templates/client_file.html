{% extends "base.html" %}

{% block title %}Client File - EdgeCase Equalizer{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/client_file.css') }}">
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/client_file.js') }}"></script>
{% endblock %}

{% block content %}

<div class="card">
    <div class="client-header">
        <div>
            <h2 class="client-name">{{ client.first_name }} {% if client.middle_name %}{{ client.middle_name }}{% endif %} {{ client.last_name }}</h2>
            <div class="text-muted">
                <div class="type-badge-wrapper">
                    <span class="type-badge" 
                          style="background-color: {{ client.type.color }}"
                          onclick="event.stopPropagation(); toggleDropdown('type-dropdown')">
                        {{ client.type.name }}
                    </span>
                    <!-- Type change dropdown -->
                    <div id="type-dropdown" class="dropdown-menu-positioned min-width-200" style="display: none;">
                        <form method="post" action="{{ url_for('clients.change_client_type', client_id=client.id) }}">
                            {% for type in all_types %}
                            {% if type.name != 'Deleted' %}
                            <label class="dropdown-label{% if type.id == client.type_id %} selected{% endif %}" 
                                   onmouseover="if ({{ type.id }} != {{ client.type_id }}) this.style.background='#F3F4F6'" 
                                   onmouseout="if ({{ type.id }} != {{ client.type_id }}) this.style.background='transparent'">
                                <input type="radio" name="type_id" value="{{ type.id }}" 
                                       {% if type.id == client.type_id %}checked{% endif %}
                                       onchange="this.form.submit()"
                                       >
                                <span>{{ type.name }}</span>
                            </label>
                            {% endif %}
                            {% endfor %}
                        </form>
                    </div>
                </div>
                <br>
                <span class="file-number">File #{{ client.file_number }}</span>
            </div>
        </div>
        <a href="{{ url_for('clients.index') }}" class="btn"><i data-lucide="arrow-left" class="icon-sm"></i> Back</a>
    </div>
    
    {# Profile Entry - Always at top if exists #}
    {% if profile_entry %}
    <div class="profile-entry" style="background-color: {{ client.type.bubble_color or '#CFE7DA' }};" onclick="window.location.href='{{ url_for('entries.edit_profile', client_id=client.id) }}'">
        <div class="profile-header">
            <strong class="profile-title">Profile</strong>
            
            {# Minor Badge #}
            {% if profile_entry.is_minor %}
            <span class="minor-badge">
                <i data-lucide="baby" class="icon-xs icon-inline"></i> Minor
            </span>
            {% endif %}
        </div>
        
        {# Contact Information - matching main_view.html logic #}
        {% if profile_entry.email %}
        <p class="contact-row">
            <i data-lucide="mail" class="icon-xs icon-inline"></i> <a href="mailto:{{ profile_entry.email }}" 
                  class="contact-link{% if profile_entry.preferred_contact == 'email' %} preferred{% endif %}" 
                  onclick="event.stopPropagation();">{{ profile_entry.email }}</a>
        </p>
        {% endif %}
        
        {% if profile_entry.phone or profile_entry.home_phone or profile_entry.work_phone %}
        <p class="contact-row">
            {# Determine which phone to display and link type based on preferred_contact #}
            {% set display_phone = '' %}
            {% set link_type = 'tel' %}
            {% set is_preferred = false %}
            
            {% if profile_entry.preferred_contact == 'call_cell' %}
                {% set display_phone = profile_entry.phone %}
                {% set link_type = 'tel' %}
                {% set is_preferred = true %}
            {% elif profile_entry.preferred_contact == 'call_home' %}
                {% set display_phone = profile_entry.home_phone %}
                {% set link_type = 'tel' %}
                {% set is_preferred = true %}
            {% elif profile_entry.preferred_contact == 'call_work' %}
                {% set display_phone = profile_entry.work_phone %}
                {% set link_type = 'tel' %}
                {% set is_preferred = true %}
            {% elif profile_entry.preferred_contact == 'text' %}
                {% if profile_entry.text_number == 'cell' %}
                    {% set display_phone = profile_entry.phone %}
                {% elif profile_entry.text_number == 'home' %}
                    {% set display_phone = profile_entry.home_phone %}
                {% elif profile_entry.text_number == 'work' %}
                    {% set display_phone = profile_entry.work_phone %}
                {% else %}
                    {% set display_phone = profile_entry.phone %}
                {% endif %}
                {% set link_type = 'sms' %}
                {% set is_preferred = true %}
            {% else %}
                {# Default: show cell phone #}
                {% set display_phone = profile_entry.phone or profile_entry.home_phone or profile_entry.work_phone %}
                {% set link_type = 'tel' %}
            {% endif %}
            
            {% if display_phone %}
                {% if link_type == 'tel' %}<i data-lucide="phone" class="icon-xs icon-inline"></i>{% else %}<i data-lucide="message-circle" class="icon-xs icon-inline"></i>{% endif %} 
                <a href="{{ link_type }}:{{ display_phone }}" 
                   class="contact-link{% if is_preferred %} preferred{% endif %}" 
                   onclick="event.stopPropagation();">{{ display_phone }}</a>
                {% if profile_entry.ok_to_leave_message == 'no' %} <i data-lucide="alert-triangle" class="icon-xs icon-inline icon-warning"></i>{% endif %}
            {% endif %}
        </p>
        {% endif %}
        
        <small class="text-muted">Created: {{ profile_entry.created_at|timestamp_to_date }}</small>
    </div>
    {% else %}
    {# No profile - make it clickable to create one #}
    <div class="profile-entry profile-entry-empty" onclick="window.location.href='{{ url_for('entries.edit_profile', client_id=client.id) }}'">
        <strong class="profile-title">+ Create Profile</strong>
        <p class="text-muted profile-empty-text">Click to add client contact information</p>
    </div>
    {% endif %}

{# Linked Clients Section - NEW #}
    {% if linked_groups %}
    <div class="linked-section">
        <h4>Linked Clients</h4>
        
        {% for group in linked_groups %}
        <div class="linked-group-card">
            <div class="linked-group-title">
                {{ group.format_display }} Link
            </div>
            
            <div class="linked-members">
                {% for member in group.members %}
                <a href="{{ url_for('clients.client_file', client_id=member.id) }}" 
                   class="linked-client-card"
                   onclick="event.stopPropagation();">
                    <span class="type-badge type-badge-small" 
                          style="background-color: {{ member.type.color }};">
                        {{ member.type.name }}
                    </span>
                    <div class="linked-member-content">
                        <div class="linked-member-name">
                            {{ member.first_name }} 
                            {% if member.middle_name %}{{ member.middle_name }}{% endif %} 
                            {{ member.last_name }}
                        </div>
                        <div class="linked-member-file">
                            #{{ member.file_number }}
                        </div>
                    </div>
                </a>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    {# End Linked Clients Section #}
    
    <h3 class="section-heading section-heading-spaced">Session History 
        {% if session_count > 0 or consultation_count > 0 or absence_count > 0 %}
            ({{ session_count }} Session{{ 's' if session_count != 1 else '' }}{% if consultation_count > 0 %}, {{ consultation_count }} Consultation{{ 's' if consultation_count != 1 else '' }}{% endif %}{% if absence_count > 0 %}, {{ absence_count }} Absence{{ 's' if absence_count != 1 else '' }} this year{% endif %})
        {% endif %}
    </h3>
    
    <!-- Entry Class Filter -->
    <div class="controls-bar">
        <div class="dropdown-wrapper">
            <button class="dropdown-btn" id="class-filter-button" onclick="toggleDropdown('filter-dropdown')">
                Filter: {{ class_filter|length }} type{{ 's' if class_filter|length != 1 else '' }} ▾
            </button>
            <div id="filter-dropdown" class="dropdown-menu-positioned min-width-220" style="display: none;">
                <div id="filter-form">
                    <label class="dropdown-label">
                        <input type="checkbox" name="class" value="session" 
                            {% if 'session' in class_filter %}checked{% endif %}>
                        <span>Session</span>
                    </label>
                    <label class="dropdown-label">
                        <input type="checkbox" name="class" value="communication" 
                            {% if 'communication' in class_filter %}checked{% endif %}>
                        <span>Communication</span>
                    </label>
                    <label class="dropdown-label">
                        <input type="checkbox" name="class" value="absence" 
                            {% if 'absence' in class_filter %}checked{% endif %}>
                        <span>Absence</span>
                    </label>
                    <label class="dropdown-label">
                        <input type="checkbox" name="class" value="item" 
                            {% if 'item' in class_filter %}checked{% endif %}>
                        <span>Item</span>
                    </label>
                    <label class="dropdown-label">
                        <input type="checkbox" name="class" value="upload" 
                            {% if 'upload' in class_filter %}checked{% endif %}>
                        <span>Upload</span>
                    </label>
                    <label class="dropdown-label">
                        <input type="checkbox" name="class" value="consultation" 
                            {% if 'consultation' in class_filter %}checked{% endif %}>
                        <span>Consultation</span>
                    </label>
                </div>
            </div>
        </div>
        
        <!-- Search Box -->
        <div class="search-box search-box-flex">
            <span class="search-icon"><i data-lucide="search"></i></span>
            <input type="text" 
                id="entry-search" 
                placeholder="Search entries..."
                autocomplete="off">
            <button type="button" 
                    id="clear-entry-search" 
                    class="clear-search"><i data-lucide="x"></i></button>
        </div>
        
        <!-- Action Buttons (right-aligned) -->
        <div class="controls-actions">
            <!-- Add Entry Dropdown -->
            <div class="dropdown-wrapper">
                <button class="dropdown-btn" onclick="toggleDropdown('add-entry-dropdown')">
                    <i data-lucide="plus" class="icon-sm icon-inline"></i> New ▾
                </button>
                <div id="add-entry-dropdown" class="dropdown-menu dropdown-menu-right" style="display: none;">
                    <a href="{{ url_for('entries.create_session', client_id=client.id) }}" class="dropdown-item">
                        <i data-lucide="clipboard" class="icon-sm icon-inline"></i> Session
                    </a>
                    <a href="{{ url_for('entries.create_communication', client_id=client.id) }}" class="dropdown-item">
                        <i data-lucide="message-circle" class="icon-sm icon-inline"></i> Communication
                    </a>
                    <a href="{{ url_for('entries.create_absence', client_id=client.id) }}" class="dropdown-item">
                        <i data-lucide="x-circle" class="icon-sm icon-inline"></i> Absence
                    </a>
                    <a href="{{ url_for('entries.create_item', client_id=client.id) }}" class="dropdown-item">
                        <i data-lucide="package" class="icon-sm icon-inline"></i> Item
                    </a>
                    <a href="{{ url_for('entries.create_upload', client_id=client.id) }}" class="dropdown-item">
                        <i data-lucide="paperclip" class="icon-sm icon-inline"></i> Upload
                    </a>
                    <div class="dropdown-separator"></div>
                    <a href="{{ url_for('scheduler.schedule_for_client', client_id=client.id) }}" class="dropdown-item">
                        <i data-lucide="calendar-plus" class="icon-sm icon-inline"></i> Appointment
                    </a>
                    <a href="{{ url_for('clients.session_report', client_id=client.id) }}" class="dropdown-item">
                        <i data-lucide="file-bar-chart" class="icon-sm icon-inline"></i> Report
                    </a>
                    <a href="{{ url_for('clients.export_client', client_id=client.id) }}" class="dropdown-item">
                        <i data-lucide="file-text" class="icon-sm icon-inline"></i> Export
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    {% if entries_by_year %}
    <div class="timeline-container">
        {% for year_group in entries_by_year %}
        <div class="year-section">
            {# Year Header #}
            <div class="year-header" onclick="toggleYear('year-{{ year_group.year }}')">
                <span class="year-header-text">
                    <span id="year-{{ year_group.year }}-icon">{{ '▼' if year_group.is_current else '▶' }}</span>
                    {{ year_group.year }}
                </span>
                <span class="entry-count">{{ year_group.total }} Entr{{ 'y' if year_group.total == 1 else 'ies' }}</span>
            </div>
            
            {# Year Content (collapsible) #}
            <div id="year-{{ year_group.year }}-content" 
                 style="{% if not year_group.is_current %}display: none;{% endif %}">
                
                {% for month_group in year_group.months %}
                <div class="month-section">
                    {# Month Header #}
                    <div class="month-header"
                         onclick="toggleMonth('month-{{ year_group.year }}-{{ month_group.month_num }}')">
                        <span class="month-header-text">
                            <span id="month-{{ year_group.year }}-{{ month_group.month_num }}-icon">{{ '▼' if month_group.is_current else '▶' }}</span>
                            {{ month_group.month_name }}
                        </span>
                        <span class="entry-count">{{ month_group.entries|length }} Entr{{ 'y' if month_group.entries|length == 1 else 'ies' }}</span>
                    </div>
                    
                    {# Month Content - Table #}
                    <div id="month-{{ year_group.year }}-{{ month_group.month_num }}-content"
                         class="month-content"
                         style="{% if not month_group.is_current %}display: none;{% endif %}">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Class</th>
                                    <th>Description</th>
                                    <th>Time</th>
                                    <th>Details</th>
                                    <th>Info</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for entry in month_group.entries %}
                                <tr {% if entry.is_redacted %}class="redacted-entry"{% endif %}
                                    onclick="{% if entry.is_redacted %}window.location.href='{{ url_for('entries.view_redacted_entry', client_id=client.id, entry_id=entry.id) }}'{% elif entry.class == 'session' %}window.location.href='{{ url_for('entries.edit_session', client_id=client.id, entry_id=entry.id) }}'{% elif entry.class == 'communication' %}window.location.href='{{ url_for('entries.edit_communication', client_id=client.id, entry_id=entry.id) }}'{% elif entry.class == 'absence' %}window.location.href='{{ url_for('entries.edit_absence', client_id=client.id, entry_id=entry.id) }}'{% elif entry.class == 'item' %}window.location.href='{{ url_for('entries.edit_item', client_id=client.id, entry_id=entry.id) }}'{% elif entry.class == 'upload' %}window.location.href='{{ url_for('entries.edit_upload', client_id=client.id, entry_id=entry.id) }}'{% endif %}"
                                    data-description="{{ entry.description|e }}" 
                                    data-content="{{ entry.content|e if entry.content else '' }}">
                                    <td>
                                        {% if entry.class == 'session' %}
                                            {{ entry.session_date|timestamp_to_date }}
                                        {% elif entry.class == 'communication' %}
                                            {{ entry.comm_date|timestamp_to_date }}
                                        {% elif entry.class == 'absence' %}
                                            {{ entry.absence_date|timestamp_to_date }}
                                        {% elif entry.class == 'item' %}
                                            {{ entry.item_date|timestamp_to_date if entry.item_date else '-' }}
                                        {% elif entry.class == 'upload' %}
                                            {{ entry.upload_date|timestamp_to_date if entry.upload_date else '-' }}
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if entry.class == 'session' %}
                                            <span class="session-badge {% if not entry.locked %}draft{% elif entry.is_consultation %}consultation{% else %}session{% endif %}">
                                                {% if not entry.locked %}
                                                    Draft
                                                {% elif entry.is_consultation %}
                                                    Consultation
                                                {% else %}
                                                    Session
                                                {% endif %}
                                            </span>
                                        {% elif entry.class == 'communication' %}
                                            <span class="session-badge session-badge-communication">
                                                Communication
                                            </span>
                                        {% elif entry.class == 'absence' %}
                                            <span class="session-badge session-badge-absence">
                                                Absence
                                            </span>
                                        {% elif entry.class == 'item' %}
                                            <span class="session-badge session-badge-item">
                                                Item
                                            </span>
                                        {% elif entry.class == 'upload' %}
                                            <span class="session-badge session-badge-upload">
                                                Upload
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if entry.description|length > 50 %}
                                            {{ entry.description[:50] }}...
                                        {% else %}
                                            {{ entry.description }}
                                        {% endif %}
                                    </td>
                                    <td class="text-muted">
                                        {% if entry.class == 'session' %}
                                            {{ entry.session_time or '-' }}
                                        {% elif entry.class == 'communication' %}
                                            {{ entry.comm_time or '-' }}
                                        {% elif entry.class == 'absence' %}
                                            {{ entry.absence_time or '-' }}
                                        {% elif entry.class == 'item' %}
                                            {{ entry.item_time or '-' }}
                                        {% elif entry.class == 'upload' %}
                                            {{ entry.upload_time or '-' }}
                                        {% endif %}
                                    </td>
                                    <td class="text-muted">
                                        {% if entry.class == 'session' %}
                                            {{ entry.duration or '-' }} min
                                        {% elif entry.class == 'communication' %}
                                            {{ entry.comm_recipient|replace('_', ' ')|title if entry.comm_recipient else '-' }}
                                        {% elif entry.class == 'absence' %}
                                            {{ entry.format|capitalize if entry.format else '-' }}
                                        {% elif entry.class == 'item' %}
                                            {% if entry.base_price and entry.tax_rate %}
                                                ${{ "%.2f"|format(entry.base_price) }} + {{ "%.1f"|format(entry.tax_rate) }}% tax
                                            {% else %}
                                                -
                                            {% endif %}
                                        {% elif entry.class == 'upload' %}
                                            {{ entry.attachment_count }} file{{ 's' if entry.attachment_count != 1 else '' }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td class="text-muted">
                                        {% if entry.class == 'session' and entry.fee %}
                                            ${{ "%.2f"|format(entry.fee) }}
                                        {% elif entry.class == 'communication' and entry.comm_type %}
                                            {{ entry.comm_type|capitalize }}
                                        {% elif entry.class == 'absence' %}
                                            ${{ "%.2f"|format(entry.fee) if entry.fee else '0.00' }}
                                        {% elif entry.class == 'item' %}
                                            ${{ "%.2f"|format(entry.fee) if entry.fee else '0.00' }}
                                        {% elif entry.class == 'upload' %}
                                            -
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
        <p class="text-muted empty-entries-text">No Entries yet.</p>
    </div>
    {% endif %}
</div>

{% endblock %}
